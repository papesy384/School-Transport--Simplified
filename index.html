<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>ISD Car Booking - ISD Transportation</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase configuration - Replace with your Firebase project config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        const auth = getAuth(firebaseApp);
        
        // Make Firebase available globally
        window.firebaseApp = firebaseApp;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseConfig = firebaseConfig; // Store config for checking
        window.firebaseFunctions = {
            collection,
            doc,
            getDoc,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            query,
            where,
            orderBy,
            onSnapshot
        };
    </script>
    <!-- Use Inter font, suitable for professional and modern web apps -->
    <style>
        /* Define ISD Brand Colors using Tailwind utility classes */
        :root {
            --color-isd-gold: #FDC12B;
            --color-isd-black: #000000;
        }

        .bg-isd-gold { background-color: var(--color-isd-gold); }
        .text-isd-gold { color: var(--color-isd-gold); }
        .bg-isd-black { background-color: var(--color-isd-black); }
        .text-isd-black { color: var(--color-isd-black); }
        .border-isd-gold { border-color: var(--color-isd-gold); }
        
        /* Form validation styles */
        .border-red-500 {
            border-color: #ef4444 !important;
            border-width: 2px !important;
        }

        /* iOS Safari safe area support */
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-right: env(safe-area-inset-right);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
        }
        
        html {
            width: 100%;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            /* Prevent iOS Safari bounce */
            overscroll-behavior: none;
            /* Fix iOS Safari 100vh issue */
            height: -webkit-fill-available;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            min-height: -webkit-fill-available; /* iOS Safari fix */
            display: flex;
            flex-direction: column;
            background-color: #000000; /* Black background */
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
            /* Prevent pull-to-refresh on mobile */
            overscroll-behavior-y: none;
            /* Better touch scrolling */
            -webkit-overflow-scrolling: touch;
            /* Prevent text selection issues on mobile */
            -webkit-tap-highlight-color: transparent;
            /* Support safe areas for iOS notch */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .role-button {
            transition: all 0.2s ease-in-out;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            height: -webkit-fill-available; /* iOS Safari fix */
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 10000; /* High z-index to ensure it's on top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            /* Support safe areas for iOS notch */
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .modal-overlay.open {
            display: flex !important; /* Force display when open */
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 450px;
            max-width: 500px;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal-button {
            display: inline-block;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            text-transform: uppercase;
        }
        .modal-button:active {
            transform: translateY(1px);
        }
        
        /* View sections */
        .view-section {
            display: none;
            width: 100%;
        }
        
        .view-section.active {
            display: block;
            width: 100%;
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            /* Ensure all buttons are touch-friendly (min 44x44px) */
            button, a, input[type="submit"], input[type="button"] {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation; /* Disable double-tap zoom */
            }
            
            /* Better mobile typography */
            body {
                font-size: 16px; /* Prevent iOS zoom on input focus */
            }
            
            /* Prevent iOS zoom on input focus */
            input, select, textarea {
                font-size: 16px !important;
            }
            
            /* Better spacing on mobile */
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            /* Full width on mobile */
            main {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* Better modal on mobile */
            .modal-content {
                width: calc(100% - 2rem);
                max-width: calc(100% - 2rem);
                padding: 1.5rem;
                margin: 1rem;
                max-height: calc(100vh - 4rem);
                max-height: calc(-webkit-fill-available - 4rem);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Ensure modal overlay covers full screen on mobile */
            .modal-overlay {
                padding: 0;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }
            
            /* Better table scrolling on mobile */
            table {
                font-size: 14px;
            }
            
            /* Stack elements on mobile */
            .flex-row {
                flex-direction: column;
            }
            
            /* Better header on mobile */
            header {
                padding: 0.75rem 1rem;
            }
        }
        
        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            /* iOS Safari specific */
            body {
                min-height: -webkit-fill-available;
            }
            
            /* Fix iOS Safari address bar */
            @media (orientation: portrait) {
                body {
                    min-height: 100vh;
                    min-height: -webkit-fill-available;
                }
            }
        }
        
        /* Android Chrome specific */
        @media screen and (max-width: 768px) {
            /* Better touch targets for Android */
            button, a, .cursor-pointer {
                -webkit-tap-highlight-color: rgba(253, 193, 43, 0.3);
            }
        }
        
        /* Ensure all sections are visible on mobile */
        .view-section {
            min-height: calc(100vh - 200px);
            min-height: calc(-webkit-fill-available - 200px);
        }
        
        /* Better scrolling on mobile */
        * {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Prevent text selection on mobile buttons */
        button, .role-button {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Better form inputs on mobile */
        input, select, textarea {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 8px;
        }
        
        /* Fix iOS input styling */
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"] {
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* Fuel Level Radio Button Visual Feedback */
        .fuel-level-option {
            transition: all 0.2s ease;
        }
        
        .fuel-level-radio:checked ~ span {
            border-color: #D4AF37;
            background-color: rgba(212, 175, 55, 0.1);
        }
        
        .fuel-level-option:has(.fuel-level-radio:checked) {
            border-color: #D4AF37;
            background-color: rgba(212, 175, 55, 0.1);
        }
        
        /* Mobile-optimized button sizes for driver interface */
        @media (max-width: 768px) {
            #active-trip-card button {
                min-height: 56px;
                font-size: 16px;
            }
        }
        
        /* Dark-Mode High-Contrast Theme for Driver Interface */
        #view-assigned-trips,
        #view-trip-finalization {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        #view-assigned-trips .bg-white,
        #view-trip-finalization .bg-white {
            background-color: #2d2d2d !important;
            color: #ffffff !important;
        }
        
        #view-assigned-trips .text-gray-800,
        #view-trip-finalization .text-gray-800,
        #view-assigned-trips .text-gray-700,
        #view-trip-finalization .text-gray-700 {
            color: #ffffff !important;
        }
        
        #view-assigned-trips .text-gray-600,
        #view-trip-finalization .text-gray-600 {
            color: #d1d5db !important;
        }
        
        #view-assigned-trips .border-gray-300,
        #view-trip-finalization .border-gray-300 {
            border-color: #4b5563 !important;
        }
        
        #view-assigned-trips input,
        #view-trip-finalization input,
        #view-assigned-trips textarea,
        #view-trip-finalization textarea,
        #view-assigned-trips select,
        #view-trip-finalization select {
            background-color: #374151 !important;
            color: #ffffff !important;
            border-color: #4b5563 !important;
        }
        
        #view-assigned-trips input::placeholder,
        #view-trip-finalization input::placeholder,
        #view-assigned-trips textarea::placeholder,
        #view-trip-finalization textarea::placeholder {
            color: #9ca3af !important;
        }
        
        #view-assigned-trips button:not(.disabled),
        #view-trip-finalization button:not(.disabled) {
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        #view-assigned-trips .bg-yellow-50,
        #view-trip-finalization .bg-yellow-50 {
            background-color: #3d3529 !important;
            border-color: #fbbf24 !important;
        }
        
        #view-assigned-trips .bg-blue-50,
        #view-trip-finalization .bg-blue-50 {
            background-color: #1e3a5f !important;
            border-color: #3b82f6 !important;
        }
        
        /* High-contrast focus states for driver interface */
        #view-assigned-trips input:focus,
        #view-trip-finalization input:focus,
        #view-assigned-trips textarea:focus,
        #view-trip-finalization textarea:focus {
            outline: 3px solid #60a5fa !important;
            outline-offset: 2px;
        }
        
        /* Large touch targets for driver interface buttons - Enhanced for mobile safety */
        #view-assigned-trips button,
        #view-trip-finalization button {
            min-height: 64px !important; /* Increased from 56px for better touch target */
            min-width: 120px !important;
            padding: 1rem 1.5rem !important; /* p-4 or higher (16px vertical, 24px horizontal) */
            font-size: 18px !important; /* Larger text for better visibility */
            font-weight: 700 !important; /* Extra bold for high contrast */
            letter-spacing: 0.5px !important; /* Better text readability */
        }
        
        /* Enhanced Start Trip button - Primary action, extra large */
        #view-assigned-trips #start-trip-btn {
            min-height: 72px !important; /* Extra large for primary action */
            padding: 1.25rem 2rem !important; /* p-5 or higher (20px vertical, 32px horizontal) */
            font-size: 20px !important;
            background-color: #10b981 !important; /* Brighter green for dark mode */
            border: 2px solid #059669 !important; /* Border for extra visibility */
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important; /* Glow effect */
        }
        
        #view-assigned-trips #start-trip-btn:hover {
            background-color: #059669 !important;
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.6) !important;
        }
        
        /* Dark mode button color enhancements for better contrast */
        #view-assigned-trips button.bg-green-600,
        #view-assigned-trips #start-trip-btn {
            background-color: #10b981 !important; /* Brighter green (#10b981) instead of #16a34a */
            color: #ffffff !important;
            border: 2px solid #059669 !important;
        }
        
        #view-assigned-trips button.bg-green-600:hover {
            background-color: #059669 !important;
        }
        
        #view-assigned-trips button.bg-blue-600 {
            background-color: #3b82f6 !important; /* Brighter blue for dark mode */
            color: #ffffff !important;
            border: 2px solid #2563eb !important;
        }
        
        #view-assigned-trips button.bg-blue-600:hover {
            background-color: #2563eb !important;
        }
        
        #view-assigned-trips button.bg-purple-600 {
            background-color: #9333ea !important; /* Brighter purple for dark mode */
            color: #ffffff !important;
            border: 2px solid #7e22ce !important;
        }
        
        #view-assigned-trips button.bg-purple-600:hover {
            background-color: #7e22ce !important;
        }
        
        #view-assigned-trips button.bg-indigo-600 {
            background-color: #4f46e5 !important; /* Brighter indigo for dark mode */
            color: #ffffff !important;
            border: 2px solid #4338ca !important;
        }
        
        #view-assigned-trips button.bg-indigo-600:hover {
            background-color: #4338ca !important;
        }
        
        #view-assigned-trips button.bg-orange-500 {
            background-color: #f97316 !important; /* Brighter orange for dark mode */
            color: #ffffff !important;
            border: 2px solid #ea580c !important;
        }
        
        #view-assigned-trips button.bg-orange-500:hover {
            background-color: #ea580c !important;
        }
        
        #view-assigned-trips button.bg-gray-700 {
            background-color: #374151 !important; /* Lighter gray for dark mode visibility */
            color: #ffffff !important;
            border: 2px solid #4b5563 !important;
        }
        
        #view-assigned-trips button.bg-gray-700:hover {
            background-color: #4b5563 !important;
        }
        
        /* Disabled buttons in dark mode */
        #view-assigned-trips button:disabled {
            background-color: #4b5563 !important;
            color: #9ca3af !important;
            border: 2px solid #6b7280 !important;
            opacity: 0.6 !important;
        }
        
        /* Button text shadows for better readability in dark mode */
        #view-assigned-trips button:not(:disabled) {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important; /* Stronger shadow for dark mode */
        }
        
        /* Active/pressed state for better feedback */
        #view-assigned-trips button:active:not(:disabled) {
            transform: scale(0.98) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
        }
        
        /* Style unavailable dates - match browser's disabled input styling exactly */
        input[type="date"].unavailable-date,
        input[type="date"].unavailable-date:disabled,
        #trip-date.unavailable-date,
        #trip-date.unavailable-date:disabled {
            background-color: #e5e7eb !important;
            color: #9ca3af !important;
            cursor: not-allowed !important;
            border-color: #d1d5db !important;
            opacity: 0.65 !important;
            -webkit-text-fill-color: #9ca3af !important;
        }
        
        /* Style date input when unavailable date is attempted */
        input[type="date"].unavailable-date:focus,
        input[type="date"].unavailable-date:disabled:focus,
        #trip-date.unavailable-date:focus,
        #trip-date.unavailable-date:disabled:focus {
            background-color: #e5e7eb !important;
            color: #9ca3af !important;
            border-color: #d1d5db !important;
            outline: none !important;
            opacity: 0.65 !important;
            -webkit-text-fill-color: #9ca3af !important;
        }
        
        /* Match browser's readonly input styling for unavailable dates */
        input[type="date"].unavailable-date[readonly],
        #trip-date.unavailable-date[readonly] {
            background-color: #e5e7eb !important;
            color: #9ca3af !important;
            cursor: not-allowed !important;
            opacity: 0.65 !important;
            -webkit-text-fill-color: #9ca3af !important;
        }
        
        /* Show unavailable date indicator in suggestion */
        .unavailable-date-suggestion {
            background-color: #f3f4f6;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header & Language Switcher -->
    <header class="bg-isd-black text-white p-3 sm:p-4 shadow-xl relative sticky top-0 z-50" style="padding-top: calc(0.75rem + env(safe-area-inset-top));">
        <div class="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-2 sm:gap-0 px-2 sm:px-4">
            <div class="flex items-center space-x-3">
                <!-- Logo Image -->
                <img id="header-logo" src="logo%20isd.webp" alt="ISD Logo" class="h-10 w-10 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <!-- Fallback SVG icon (hidden by default, shown if logo image fails to load) -->
                <svg id="header-logo-fallback" class="w-8 h-8 text-isd-gold hidden" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    <path fill="var(--color-isd-gold)" d="M15.5 12c.79 0 1.48-.3 2.03-.83l-1.42-1.42c-.22.18-.51.25-.81.25s-.59-.07-.81-.25L13 8.58V12h2.5z"/>
                </svg>
                <a href="#home" id="header-title-link" class="text-3xl font-extrabold tracking-tight text-isd-gold hover:text-yellow-400">
                    ISD Car Booking
                </a>
            </div>
            
            <div class="flex flex-wrap items-center justify-center sm:justify-end gap-2 sm:gap-4 sm:gap-6 w-full sm:w-auto">
                <!-- Home/Logout Button (shown in dashboard views) - First item -->
                <a href="#home" id="home-link" class="text-sm text-isd-gold hover:text-white font-semibold hidden min-h-[44px] min-w-[44px] flex items-center justify-center px-2 py-1" data-translate="home">Home</a>
                
                <!-- User Categories -->
                <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap justify-center sm:justify-end">
                    <a href="#login/admin" id="btn-admin" class="text-sm text-isd-gold hover:text-white font-medium transition-colors px-2 py-1 min-h-[44px] min-w-[44px] flex items-center justify-center" data-translate="admin">Admin</a>
                    <a href="#login/employee" id="btn-employee" class="text-sm text-isd-gold hover:text-white font-medium transition-colors px-2 py-1 min-h-[44px] min-w-[44px] flex items-center justify-center" data-translate="employee">Employee</a>
                    <a href="#login/driver" id="btn-driver" class="text-sm text-isd-gold hover:text-white font-medium transition-colors px-2 py-1 min-h-[44px] min-w-[44px] flex items-center justify-center" data-translate="driver">Driver</a>
                </div>
                
                <!-- Language Switcher -->
                <div id="language-switcher" class="text-sm font-semibold flex items-center gap-1 min-h-[44px]">
                    <a href="#" id="lang-en" class="text-isd-gold hover:text-white border-b border-isd-gold pb-0.5 px-2 py-1 min-h-[44px] min-w-[44px] flex items-center justify-center" data-translate="langEn">EN</a>
                    <span class="text-gray-400"> / </span>
                    <a href="#" id="lang-fr" class="text-white hover:text-isd-gold px-2 py-1 min-h-[44px] min-w-[44px] flex items-center justify-center" data-translate="langFr">FR</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Section -->
    <main class="flex-grow container mx-auto p-2 sm:p-4 md:p-6 lg:p-8 max-w-7xl w-full" style="padding-bottom: calc(1rem + env(safe-area-inset-bottom));">
        
        <!-- Home View -->
        <div id="view-home" class="view-section active w-full">
            <!-- Hero Section with Vehicle Image -->
            <div class="relative overflow-hidden rounded-xl mb-8">
                <div class="absolute inset-0 z-0">
                    <img src="https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=1920&h=1080&fit=crop" alt="School Bus Fleet" class="w-full h-full object-cover opacity-40">
                    <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-black/60 to-black"></div>
                </div>
                <div class="relative z-10 w-full px-4 sm:px-6 lg:px-8 py-16 md:py-24 lg:py-32">
                    <div class="text-center">
                        <h1 id="msg-title" class="text-5xl md:text-7xl lg:text-8xl font-extrabold mb-6 text-white tracking-tight drop-shadow-2xl">
                            ISD Car Booking
                        </h1>
                        <p id="msg-text" class="text-xl md:text-2xl lg:text-3xl text-gray-200 mb-8 max-w-4xl mx-auto drop-shadow-lg">
                            Your centralized transportation platform for the International School of Dakar
                        </p>
                    </div>
                </div>
            </div>

            <!-- Vehicle Gallery Section -->
            <div class="w-full px-4 sm:px-6 lg:px-8 py-12 md:py-16 lg:py-20">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-4" data-translate="ourFleet">Our Fleet</h2>
                    <p class="text-lg md:text-xl text-gray-300 max-w-2xl mx-auto" data-translate="fleetDesc">A diverse range of vehicles to meet all your transportation needs</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mb-12 md:mb-20">
                    <!-- School Bus Card -->
                    <div class="group relative overflow-hidden rounded-2xl shadow-2xl transform transition-all duration-300 hover:scale-105">
                        <div class="absolute inset-0 z-0">
                            <img src="https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=800&h=600&fit=crop" alt="School Bus" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
                        </div>
                        <div class="relative z-10 p-8 h-full flex flex-col justify-end min-h-[400px]">
                            <h3 class="text-3xl font-bold text-white mb-3" data-translate="schoolBus">School Bus</h3>
                            <p class="text-gray-200 mb-4 text-lg" data-translate="schoolBusDesc">50 seats ‚Ä¢ Perfect for field trips and large groups</p>
                            <div class="flex items-center text-isd-gold">
                                <span class="text-2xl font-bold">8</span>
                                <span class="ml-2 text-lg" data-translate="available">Available</span>
                            </div>
                        </div>
                    </div>

                    <!-- SUV Card -->
                    <div class="group relative overflow-hidden rounded-2xl shadow-2xl transform transition-all duration-300 hover:scale-105">
                        <div class="absolute inset-0 z-0">
                            <img src="https://images.unsplash.com/photo-1503376780353-7e6692767b70?w=800&h=600&fit=crop" alt="SUV" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
                        </div>
                        <div class="relative z-10 p-8 h-full flex flex-col justify-end min-h-[400px]">
                            <h3 class="text-3xl font-bold text-white mb-3" data-translate="suv">SUV</h3>
                            <p class="text-gray-200 mb-4 text-lg" data-translate="suvDesc">7 seats ‚Ä¢ Comfortable for small groups</p>
                            <div class="flex items-center text-isd-gold">
                                <span class="text-2xl font-bold">10</span>
                                <span class="ml-2 text-lg" data-translate="available">Available</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sedan Card -->
                    <div class="group relative overflow-hidden rounded-2xl shadow-2xl transform transition-all duration-300 hover:scale-105">
                        <div class="absolute inset-0 z-0">
                            <img src="https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?w=800&h=600&fit=crop" alt="Sedan" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
                        </div>
                        <div class="relative z-10 p-8 h-full flex flex-col justify-end min-h-[400px]">
                            <h3 class="text-3xl font-bold text-white mb-3" data-translate="sedan">Sedan</h3>
                            <p class="text-gray-200 mb-4 text-lg" data-translate="sedanDesc">5 seats ‚Ä¢ Ideal for staff travel</p>
                            <div class="flex items-center text-isd-gold">
                                <span class="text-2xl font-bold">14</span>
                                <span class="ml-2 text-lg" data-translate="available">Available</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Features Section -->
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl md:text-4xl font-bold text-white text-center mb-12" data-translate="platformFeatures">Platform Features</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 hover:border-isd-gold transition-all hover:shadow-2xl hover:shadow-isd-gold/20">
                            <div class="text-isd-gold text-4xl mb-4">üöå</div>
                            <h3 class="text-xl font-bold text-white mb-2" data-translate="fleetManagement">Fleet Management</h3>
                            <p class="text-gray-400" data-translate="fleetManagementDesc">Track and manage all vehicles efficiently</p>
                        </div>
                        <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 hover:border-isd-gold transition-all hover:shadow-2xl hover:shadow-isd-gold/20">
                            <div class="text-isd-gold text-4xl mb-4">üìÖ</div>
                            <h3 class="text-xl font-bold text-white mb-2" data-translate="easyBooking">Easy Booking</h3>
                            <p class="text-gray-400" data-translate="easyBookingDesc">Book vehicles with just a few clicks</p>
                        </div>
                        <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 hover:border-isd-gold transition-all hover:shadow-2xl hover:shadow-isd-gold/20">
                            <div class="text-isd-gold text-4xl mb-4">‚úÖ</div>
                            <h3 class="text-xl font-bold text-white mb-2" data-translate="quickApprovals">Quick Approvals</h3>
                            <p class="text-gray-400" data-translate="quickApprovalsDesc">Streamlined approval workflow</p>
                        </div>
                        <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 hover:border-isd-gold transition-all hover:shadow-2xl hover:shadow-isd-gold/20">
                            <div class="text-isd-gold text-4xl mb-4">üìä</div>
                            <h3 class="text-xl font-bold text-white mb-2" data-translate="realTimeTracking">Real-time Tracking</h3>
                            <p class="text-gray-400" data-translate="realTimeTrackingDesc">Monitor trip status in real-time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guest Admin Dashboard View -->
        <div id="view-guest-admin" class="view-section w-full">
            <div class="bg-white p-6 sm:p-8 lg:p-10 rounded-xl shadow-lg mb-6 border-t-8 border-isd-gold w-full">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                    <div>
                        <h2 id="dashboard-admin-title" class="text-2xl sm:text-3xl font-bold text-gray-800" data-translate="adminDashboard">Admin Dashboard</h2>
                        <p id="dashboard-admin-desc" class="text-gray-600 mt-2 text-sm sm:text-base" data-translate="decisionManagementHub">Decision and Management Hub</p>
                </div>
                    <span id="guest-mode-badge" class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold whitespace-nowrap" data-translate="guestMode">GUEST MODE</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 w-full">
                <!-- Main Actions -->
                <div class="lg:col-span-3 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 id="admin-fleet-title" class="text-xl font-bold mb-3 text-gray-800" data-translate="fleetManagement">Fleet Management</h3>
                            <p id="admin-fleet-desc" class="text-gray-600 mb-4 text-sm" data-translate="adminFleetDesc">View and manage vehicle fleet</p>
                    <button id="admin-fleet-btn" class="w-full bg-isd-gold text-isd-black py-2 px-4 rounded-lg font-semibold hover:bg-yellow-400" data-translate="manageFleet">Manage Fleet</button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 id="admin-approvals-title" class="text-xl font-bold mb-3 text-gray-800" data-translate="bookingApprovals">Booking Approvals</h3>
                            <p id="admin-approvals-desc" class="text-gray-600 mb-4 text-sm" data-translate="adminApprovalsDesc">Review and approve booking requests</p>
                    <button id="admin-approvals-btn" class="w-full bg-isd-gold text-isd-black py-2 px-4 rounded-lg font-semibold hover:bg-yellow-400" data-translate="viewRequests">View Requests</button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 id="admin-users-title" class="text-xl font-bold mb-3 text-gray-800" data-translate="userManagement">User Management</h3>
                            <p id="admin-users-desc" class="text-gray-600 mb-4 text-sm" data-translate="adminUsersDesc">Manage employees and drivers</p>
                    <button id="admin-users-btn" class="w-full bg-isd-gold text-isd-black py-2 px-4 rounded-lg font-semibold hover:bg-yellow-400" data-translate="manageUsers">Manage Users</button>
                </div>
            </div>
                    
        </div>

                <!-- Resource Health Monitoring Widget (Sidebar) -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4" data-translate="resourceHealth">Resource Health</h3>
                        
                        <!-- Driver Status -->
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3" data-translate="driverStatusLabel">Driver Status</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between p-2 bg-green-50 rounded">
                                    <span class="text-xs text-gray-700" data-translate="driverAvailable">Available</span>
                                    <span class="text-sm font-bold text-green-600">12</span>
                </div>
                                <div class="flex items-center justify-between p-2 bg-blue-50 rounded">
                                    <span class="text-xs text-gray-700" data-translate="driverOnTrip">On Trip</span>
                                    <span class="text-sm font-bold text-blue-600">5</span>
                                </div>
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                    <span class="text-xs text-gray-700" data-translate="driverUnavailable">Unavailable</span>
                                    <span class="text-sm font-bold text-gray-600">2</span>
                                </div>
                            </div>
            </div>
            
                        <!-- Vehicle Warnings -->
                        <div>
                            <h4 class="text-sm font-semibold text-gray-700 mb-3" data-translate="vehicleWarnings">Vehicle Warnings</h4>
                            <div class="space-y-2">
                                <div class="p-2 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                                    <p class="text-xs font-semibold text-yellow-800" data-translate="maintenanceDue">Maintenance Due</p>
                                    <p class="text-xs text-yellow-700">Bus VH-003 (2 <span data-translate="days">days</span>)</p>
                </div>
                                <div class="p-2 bg-red-50 border-l-4 border-red-500 rounded">
                                    <p class="text-xs font-semibold text-red-800" data-translate="outOfCommission">Out of Commission</p>
                                    <p class="text-xs text-red-700">Van VH-012</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guest Employee Dashboard View (Request Dashboard) -->
        <div id="view-guest-employee" class="view-section w-full">
            <div class="bg-white p-6 sm:p-8 lg:p-10 rounded-xl shadow-lg mb-6 border-t-8 border-isd-gold w-full">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                    <div>
                        <h2 id="dashboard-employee-title" class="text-2xl sm:text-3xl font-bold text-gray-800" data-translate="employeeMyBookingsTitle">My Bookings</h2>
                        <p id="dashboard-employee-desc" class="text-gray-600 mt-2 text-sm sm:text-base" data-translate="employeeDashboardDesc">View all your past, upcoming, pending, and active bookings</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="guest-mode-badge-employee" class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold whitespace-nowrap" data-translate="guestMode">GUEST MODE</span>
                        <button id="employee-booking-btn" class="px-4 py-2 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400 whitespace-nowrap" data-translate="newRequest">+ New Request</button>
                    </div>
                </div>
            </div>
            
               <!-- Quick Stats -->
               <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                   <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-yellow-500">
                       <p class="text-sm text-gray-600 mb-1 stats-label" data-translate="statsPending">Pending</p>
                       <p class="text-2xl font-bold text-yellow-600" id="stats-pending">0</p>
                   </div>
                   <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                       <p class="text-sm text-gray-600 mb-1 stats-label" data-translate="statsApproved">Approved</p>
                       <p class="text-2xl font-bold text-green-600" id="stats-approved">0</p>
                   </div>
                   <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
                       <p class="text-sm text-gray-600 mb-1 stats-label" data-translate="statsActive">Active</p>
                       <p class="text-2xl font-bold text-blue-600" id="stats-active">0</p>
                   </div>
                   <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-red-500">
                       <p class="text-sm text-gray-600 mb-1 stats-label" data-translate="statsDenied">Denied</p>
                       <p class="text-2xl font-bold text-red-600" id="stats-denied">0</p>
                   </div>
                   <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-gray-500">
                       <p class="text-sm text-gray-600 mb-1 stats-label" data-translate="statsCompleted">Completed</p>
                       <p class="text-2xl font-bold text-gray-600" id="stats-completed">0</p>
                   </div>
               </div>
               
               <!-- Bookings List - Post-Submission Management -->
               <div id="employee-bookings-list" class="space-y-4">
                <!-- Bookings will be dynamically populated here -->
            </div>
        </div>

        <!-- Guest Driver Dashboard View -->
        <div id="view-guest-driver" class="view-section w-full">
            <div class="bg-white p-6 sm:p-8 lg:p-10 rounded-xl shadow-lg mb-6 border-t-8 border-isd-gold w-full">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                    <div>
                        <h2 id="dashboard-driver-title" class="text-2xl sm:text-3xl font-bold text-gray-800" data-translate="guestDriverInterface">Guest Driver Interface</h2>
                        <p id="dashboard-driver-desc" class="text-gray-600 mt-2 text-sm sm:text-base" data-translate="guestDriverDesc">Welcome to the Driver Interface. You are logged in as a guest driver.</p>
                </div>
                    <span id="guest-mode-badge-driver" class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold whitespace-nowrap" data-translate="guestMode">GUEST MODE</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 id="driver-trips-title" class="text-xl font-bold mb-3 text-gray-800" data-translate="assignedTrips">Assigned Trips</h3>
                    <p id="driver-trips-desc" class="text-gray-600 mb-4" data-translate="driverTripsDesc">View your assigned trips and routes</p>
                    <button id="driver-trips-btn" class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-600" data-translate="viewTrips">View Trips</button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 id="driver-status-title" class="text-xl font-bold mb-3 text-gray-800" data-translate="updateStatus">Update Status</h3>
                    <p id="driver-status-desc" class="text-gray-600 mb-4" data-translate="driverStatusDesc">Update trip status and location</p>
                    <button id="driver-status-btn" class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-600" data-translate="updateStatus">Update Status</button>
                </div>
            </div>
        </div>

        <!-- Fleet Management View -->
        <div id="view-fleet-management" class="view-section w-full">
            <div class="bg-white p-6 sm:p-8 lg:p-10 rounded-xl shadow-lg mb-6 border-t-8 border-isd-gold w-full">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                    <div>
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800" data-translate="fleetManagement">Fleet Management</h2>
                        <p class="text-gray-600 mt-2 text-sm sm:text-base" data-translate="fleetManagementDesc">View and manage your vehicle fleet</p>
                </div>
                    <button onclick="window.location.hash = 'guest/admin'" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold whitespace-nowrap" data-translate="backToDashboard">‚Üê Back to Dashboard</button>
                </div>
            </div>
            
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 w-full">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800" data-translate="vehicleFleet">Vehicle Fleet</h3>
                    <button id="add-vehicle-btn" class="px-4 py-2 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400 whitespace-nowrap" data-translate="addVehicle">+ Add Vehicle</button>
                </div>
                
                <!-- Fleet Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-600 mb-1" data-translate="schoolBus">School Bus</p>
                                <p class="text-2xl font-bold text-gray-900">8</p>
                            </div>
                            <!-- School Bus Image -->
                            <img src="https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=80&h=80&fit=crop" alt="School Bus" class="w-16 h-16 object-cover rounded-lg">
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-600 mb-1" data-translate="suv">SUV</p>
                                <p class="text-2xl font-bold text-gray-900">10</p>
                            </div>
                            <!-- SUV Image -->
                            <img src="https://images.unsplash.com/photo-1503376780353-7e6692767b70?w=80&h=80&fit=crop" alt="SUV" class="w-16 h-16 object-cover rounded-lg">
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-600 mb-1" data-translate="sedan">Sedan</p>
                                <p class="text-2xl font-bold text-gray-900">14</p>
                            </div>
                            <!-- Sedan Image -->
                            <img src="https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?w=80&h=80&fit=crop" alt="Sedan" class="w-16 h-16 object-cover rounded-lg">
                        </div>
                    </div>
                </div>
                
                <!-- Vehicle Details Table -->
                <div class="overflow-x-auto -mx-2 sm:mx-0" style="-webkit-overflow-scrolling: touch;">
                    <table class="w-full text-left min-w-[600px]">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-sm font-semibold text-gray-700" data-translate="image">Image</th>
                                <th class="p-3 text-sm font-semibold text-gray-700" data-translate="vehicleIdCol">Vehicle ID</th>
                                <th class="p-3 text-sm font-semibold text-gray-700" data-translate="type">Type</th>
                                <th class="p-3 text-sm font-semibold text-gray-700" data-translate="capacityCol">Capacity</th>
                                <th class="p-3 text-sm font-semibold text-gray-700" data-translate="statusCol">Status</th>
                                <th class="p-3 text-sm font-semibold text-gray-700" data-translate="actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehicle-table-body">
                            <!-- School Buses (8) -->
                            <tr class="border-b">
                                <td class="p-3">
                                    <img src="https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=100&h=100&fit=crop" alt="School Bus" class="w-16 h-16 object-cover rounded-lg">
                                </td>
                                <td class="p-3">SB-001</td>
                                <td class="p-3" data-translate="schoolBus">School Bus</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-yellow-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 16c0 .88.39 1.67 1 2.22V20a1 1 0 001 1h1a1 1 0 001-1v-1h8v1a1 1 0 001 1h1a1 1 0 001-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SB-002</td>
                                <td class="p-3" data-translate="schoolBus">School Bus</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-yellow-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 16c0 .88.39 1.67 1 2.22V20a1 1 0 001 1h1a1 1 0 001-1v-1h8v1a1 1 0 001 1h1a1 1 0 001-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SB-003</td>
                                <td class="p-3" data-translate="schoolBus">School Bus</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold" data-translate="statusInUse">In Use</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-yellow-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 16c0 .88.39 1.67 1 2.22V20a1 1 0 001 1h1a1 1 0 001-1v-1h8v1a1 1 0 001 1h1a1 1 0 001-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SB-004</td>
                                <td class="p-3" data-translate="schoolBus">School Bus</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-yellow-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 16c0 .88.39 1.67 1 2.22V20a1 1 0 001 1h1a1 1 0 001-1v-1h8v1a1 1 0 001 1h1a1 1 0 001-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SB-005</td>
                                <td class="p-3" data-translate="schoolBus">School Bus</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-yellow-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 16c0 .88.39 1.67 1 2.22V20a1 1 0 001 1h1a1 1 0 001-1v-1h8v1a1 1 0 001 1h1a1 1 0 001-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SB-006</td>
                                <td class="p-3" data-translate="schoolBus">School Bus</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-yellow-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 16c0 .88.39 1.67 1 2.22V20a1 1 0 001 1h1a1 1 0 001-1v-1h8v1a1 1 0 001 1h1a1 1 0 001-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SB-007</td>
                                <td class="p-3" data-translate="schoolBus">School Bus</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold" data-translate="statusInUse">In Use</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-yellow-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 16c0 .88.39 1.67 1 2.22V20a1 1 0 001 1h1a1 1 0 001-1v-1h8v1a1 1 0 001 1h1a1 1 0 001-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SB-008</td>
                                <td class="p-3" data-translate="schoolBus">School Bus</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <!-- SUVs (10) -->
                            <tr class="border-b">
                                <td class="p-3">
                                    <img src="https://images.unsplash.com/photo-1503376780353-7e6692767b70?w=100&h=100&fit=crop" alt="SUV" class="w-16 h-16 object-cover rounded-lg">
                                </td>
                                <td class="p-3">SUV-001</td>
                                <td class="p-3">SUV</td>
                                <td class="p-3">7 seats</td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SUV-002</td>
                                <td class="p-3">SUV</td>
                                <td class="p-3">7 seats</td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SUV-003</td>
                                <td class="p-3">SUV</td>
                                <td class="p-3">7 seats</td>
                                <td class="p-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold" data-translate="statusInUse">In Use</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SUV-004</td>
                                <td class="p-3">SUV</td>
                                <td class="p-3">7 seats</td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SUV-005</td>
                                <td class="p-3">SUV</td>
                                <td class="p-3">7 seats</td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SUV-006</td>
                                <td class="p-3">SUV</td>
                                <td class="p-3">7 seats</td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SUV-007</td>
                                <td class="p-3">SUV</td>
                                <td class="p-3">7 seats</td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SUV-008</td>
                                <td class="p-3">SUV</td>
                                <td class="p-3">7 seats</td>
                                <td class="p-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold" data-translate="statusInUse">In Use</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SUV-009</td>
                                <td class="p-3">SUV</td>
                                <td class="p-3">7 seats</td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SUV-010</td>
                                <td class="p-3">SUV</td>
                                <td class="p-3">7 seats</td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <!-- Sedans (14) -->
                            <tr class="border-b">
                                <td class="p-3">
                                    <img src="https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?w=100&h=100&fit=crop" alt="Sedan" class="w-16 h-16 object-cover rounded-lg">
                                </td>
                                <td class="p-3">SD-001</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-002</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-003</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold" data-translate="statusInUse">In Use</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-004</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-005</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-006</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-007</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-008</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-009</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold" data-translate="statusInUse">In Use</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-010</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-011</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-012</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-013</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-3">
                                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </td>
                                <td class="p-3">SD-014</td>
                                <td class="p-3">Sedan</td>
                                <td class="p-3"><span data-translate="seats">seats</span></td>
                                <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold" data-translate="statusAvailable">Available</span></td>
                                <td class="p-3">
                                    <button onclick="openEditVehicleModalFromRow(this)" class="text-isd-gold hover:underline mr-2" data-translate="edit">Edit</button>
                                    <button onclick="deleteVehicle('SB-001')" class="text-red-600 hover:underline" data-translate="delete">Delete</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Booking Approvals View -->
        <div id="view-booking-approvals" class="view-section w-full">
            <div class="bg-white p-6 sm:p-8 lg:p-10 rounded-xl shadow-lg mb-6 border-t-8 border-isd-gold w-full">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800" data-translate="bookingApprovalsQueue">Booking Approvals Queue</h2>
                        <p class="text-gray-600 mt-2" data-translate="adminApprovalsDesc">Review and approve booking requests</p>
                </div>
                    <button onclick="window.location.hash = 'guest/admin'" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold" data-translate="backToDashboard">‚Üê Back to Dashboard</button>
            </div>
            
                <!-- Queue Controls: Sorting and Filtering -->
                <div class="flex flex-wrap items-center gap-4 mt-4 pt-4 border-t border-gray-200">
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-semibold text-gray-700" data-translate="sort">Sort:</label>
                        <select id="queue-sort" onchange="sortQueue()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-isd-gold">
                            <option value="urgency" data-translate="mostUrgentFirst">Most Urgent First</option>
                            <option value="date" data-translate="dateNewestFirst">Date (Newest First)</option>
                            <option value="requester" data-translate="requesterName">Requester Name</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-semibold text-gray-700" data-translate="filter">Filter:</label>
                        <select id="queue-filter" onchange="filterQueue()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-isd-gold">
                            <option value="all" data-translate="allRequests">All Requests</option>
                            <option value="urgent" data-translate="urgent48h">Urgent (48h)</option>
                            <option value="violations" data-translate="policyViolations">Policy Violations</option>
                            <option value="short-notice" data-translate="shortNotice">Short Notice</option>
                            <option value="max-duration" data-translate="exceedsMaxDuration">Exceeds Max Duration</option>
                        </select>
                    </div>
                    <div class="ml-auto text-sm text-gray-600">
                        <span id="queue-count">3</span> <span data-translate="pendingRequests">pending requests</span>
                    </div>
                </div>
            </div>
            
            <div id="pending-queue" class="space-y-4">
                <!-- Urgent Request (within 48 hours) -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500" data-urgency="urgent" data-violations="none" data-date="2025-03-15T09:00">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-lg font-bold text-gray-800" data-translate="museumFieldTrip">Trip to Museum - Field Trip</h3>
                                <span class="px-3 py-1 bg-red-500 text-white rounded-full text-xs font-semibold shadow-sm animate-pulse" data-translate="urgent">URGENT</span>
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold" data-translate="pending">Pending</span>
                        </div>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="requestedBy">Requested by:</span> <span class="font-semibold">John Doe</span> (<span data-translate="scienceDepartment">Science Department</span>)</p>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="dateLabel">Date:</span> <span class="font-semibold">March 15, 2025</span> | <span data-translate="timeLabel">Time:</span> <span class="font-semibold">9:00 AM</span> (<span data-translate="tomorrow">Tomorrow</span>)</p>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="vehicleLabel">Vehicle:</span> <span class="font-semibold"><span data-translate="bus">Bus</span> (50 <span data-translate="seats">seats</span>)</span> | <span data-translate="passengersLabel">Passengers:</span> <span class="font-semibold">45 <span data-translate="students">students</span></span></p>
                    </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickApprove('museum-trip')" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 text-sm" data-translate="approve">‚úì Approve</button>
                        <button onclick="quickDenyAvailability('museum-trip')" class="px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 text-sm" data-translate="quickDeny">Quick Deny (Availability)</button>
                        <button onclick="openRequestDetailView('museum-trip')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 text-sm" data-translate="viewDetails">View Details</button>
                    </div>
                </div>
                
                <!-- Request with Policy Violation -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-orange-500" data-urgency="normal" data-violations="short-notice" data-date="2025-03-16T14:00">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-lg font-bold text-gray-800" data-translate="sportsEvent">Sports Event</h3>
                                <span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-semibold" data-translate="shortNotice">‚ö†Ô∏è Short Notice</span>
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold" data-translate="pending">Pending</span>
                        </div>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="requestedBy">Requested by:</span> <span class="font-semibold">Jane Smith</span> (<span data-translate="athleticsDepartment">Athletics Department</span>)</p>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="dateLabel">Date:</span> <span class="font-semibold">March 16, 2025</span> | <span data-translate="timeLabel">Time:</span> <span class="font-semibold">2:00 PM</span></p>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="vehicleLabel">Vehicle:</span> <span class="font-semibold">Van (15 <span data-translate="seats">seats</span>)</span> | <span data-translate="passengersLabel">Passengers:</span> <span class="font-semibold">20 <span data-translate="students">students</span></span></p>
                    </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickApprove('sports-event')" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 text-sm" data-translate="approve">‚úì Approve</button>
                        <button onclick="quickDenyAvailability('sports-event')" class="px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 text-sm" data-translate="quickDeny">Quick Deny (Availability)</button>
                        <button onclick="openRequestDetailView('sports-event')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 text-sm" data-translate="viewDetails">View Details</button>
                    </div>
                </div>
                
                <!-- Normal Request -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500" data-urgency="normal" data-violations="none" data-date="2025-03-20T10:00">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-gray-800" data-translate="weekendWorkshop">Weekend Workshop</h3>
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold" data-translate="pending">Pending</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="requestedBy">Requested by:</span> <span class="font-semibold">Robert Brown</span> (<span data-translate="educationDepartment">Education Department</span>)</p>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="dateLabel">Date:</span> <span class="font-semibold">March 20, 2025</span> | <span data-translate="timeLabel">Time:</span> <span class="font-semibold">10:00 AM</span></p>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="vehicleLabel">Vehicle:</span> <span class="font-semibold">Bus (50 <span data-translate="seats">seats</span>)</span> | <span data-translate="passengersLabel">Passengers:</span> <span class="font-semibold">30 <span data-translate="students">students</span></span></p>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickApprove('weekend-workshop')" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 text-sm">‚úì Approve</button>
                        <button onclick="quickDenyAvailability('weekend-workshop')" class="px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 text-sm">Quick Deny (Availability)</button>
                        <button onclick="openRequestDetailView('weekend-workshop')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 text-sm" data-translate="viewDetails">View Details</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- User Management View -->
        <div id="view-user-management" class="view-section w-full">
            <div class="bg-white p-6 sm:p-8 lg:p-10 rounded-xl shadow-lg mb-6 border-t-8 border-isd-gold w-full">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800">User Management</h2>
                    <button onclick="window.location.hash = 'guest/admin'" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">‚Üê Back to Dashboard</button>
                </div>
                <p class="text-gray-600">Manage employees and drivers</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Employees</h3>
                    <button class="w-full mb-4 px-4 py-2 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400">+ Add Employee</button>
                    <div class="space-y-2">
                        <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">John Doe</p>
                                <p class="text-sm text-gray-600">john.doe@isd.edu</p>
                            </div>
                            <button onclick="openEditUserModal('John Doe', 'john.doe@isd.edu', 'Employee')" class="text-isd-gold hover:underline">Edit</button>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">Jane Smith</p>
                                <p class="text-sm text-gray-600">jane.smith@isd.edu</p>
                            </div>
                            <button onclick="openEditUserModal('John Doe', 'john.doe@isd.edu', 'Employee')" class="text-isd-gold hover:underline">Edit</button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Drivers</h3>
                    <button class="w-full mb-4 px-4 py-2 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400">+ Add Driver</button>
                    <div class="space-y-2">
                        <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">Mike Johnson</p>
                                <p class="text-sm text-gray-600"><span data-translate="license">License:</span> DL-12345</p>
                            </div>
                            <button onclick="openEditUserModal('John Doe', 'john.doe@isd.edu', 'Employee')" class="text-isd-gold hover:underline">Edit</button>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">Sarah Williams</p>
                                <p class="text-sm text-gray-600"><span data-translate="license">License:</span> DL-67890</p>
                            </div>
                            <button onclick="openEditUserModal('John Doe', 'john.doe@isd.edu', 'Employee')" class="text-isd-gold hover:underline">Edit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Booking Request View -->
        <div id="view-new-booking" class="view-section w-full">
            <div class="bg-white p-6 sm:p-8 lg:p-10 rounded-xl shadow-lg mb-6 border-t-8 border-isd-gold w-full">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800" data-translate="employeeBookingTitle">New Booking Request</h2>
                    <button onclick="window.location.hash = 'guest/employee'" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold" data-translate="backToDashboard">‚Üê Back to Dashboard</button>
                </div>
                <p class="text-gray-600" data-translate="employeeBookingDesc">Submit a new vehicle booking request</p>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <form id="new-booking-form" class="space-y-6">
                    <!-- Trip Purpose -->
                    <div class="border-b border-gray-200 pb-4">
                    <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="tripPurpose">
                                Trip Purpose <span class="text-red-600">*</span>
                                <a href="#" onclick="showTripPolicy(); return false;" class="text-isd-gold hover:text-yellow-600 ml-2 text-xs" title="View Trip Policy" data-translate="viewTripPolicy" data-title-key="viewTripPolicy">
                                    <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </a>
                            </label>
                            <input type="text" id="trip-purpose" name="trip-purpose" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" placeholder="e.g., Field trip to museum, School business, Airport transfer" data-placeholder-key="tripPurposePlaceholder">
                        <p class="text-red-600 text-sm mt-1 hidden" id="trip-purpose-error" data-translate="tripPurposeError">Trip purpose is required</p>
                    </div>
                    </div>
                    
                    <!-- Vehicle Type -->
                    <div class="border-b border-gray-200 pb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="vehicleType">Vehicle Type <span class="text-red-600">*</span></label>
                            <select id="vehicle-type" name="vehicle-type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold">
                                <option value="" data-translate="vehicleTypeSelect">Select a vehicle type</option>
                                <option value="bus" data-translate="vehicleTypeBus">Bus / Minibus (50 seats)</option>
                                <option value="van" data-translate="vehicleTypeVan">Van (15 seats)</option>
                                <option value="car" data-translate="vehicleTypeCar">Sedan / Car (5 seats)</option>
                            </select>
                            <p class="text-red-600 text-sm mt-1 hidden" id="vehicle-type-error" data-translate="vehicleTypeError">Please select a vehicle type</p>
                        </div>
                    </div>
                    
                    <!-- Start Date -->
                    <div class="border-b border-gray-200 pb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="startDate">Start Date <span class="text-red-600">*</span></label>
                            <input type="date" id="trip-date" name="trip-date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" min="">
                            <p class="text-red-600 text-sm mt-1 hidden" id="trip-date-error" data-translate="dateError">Date is required</p>
                            <!-- Date Availability Message (appears next to date input) -->
                            <div id="date-availability-message" class="hidden mt-2"></div>
                        </div>
                    </div>
                    
                    <!-- Duration -->
                    <div class="border-b border-gray-200 pb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="duration">Duration <span class="text-red-600">*</span></label>
                        <select id="trip-duration" name="trip-duration" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold">
                            <option value="" data-translate="durationSelect">Select duration</option>
                                <optgroup label="Hours" data-translate="durationHours">
                            <option value="1" data-translate="duration1Hour">1 hour</option>
                            <option value="2" data-translate="duration2Hours">2 hours</option>
                            <option value="3" data-translate="duration3Hours">3 hours</option>
                            <option value="4" data-translate="duration4Hours">4 hours</option>
                            <option value="5" data-translate="duration5Hours">5 hours</option>
                            <option value="6" data-translate="duration6Hours">6 hours</option>
                                    <option value="8" data-translate="duration8Hours">8 hours</option>
                                    <option value="10" data-translate="duration10Hours">10 hours</option>
                                    <option value="12" data-translate="duration12Hours">12 hours</option>
                                </optgroup>
                                <optgroup label="Days" data-translate="durationDays">
                                    <option value="24" data-translate="duration1Day">1 day</option>
                                    <option value="48" data-translate="duration2Days">2 days</option>
                                    <option value="72" data-translate="duration3Days">3 days</option>
                                    <option value="96" data-translate="duration4Days">4 days</option>
                                    <option value="120" data-translate="duration5Days">5 days</option>
                                    <option value="144" data-translate="duration6Days">6 days</option>
                                    <option value="168" data-translate="duration7Days1Week">7 days (1 week)</option>
                                </optgroup>
                        </select>
                        <p class="text-red-600 text-sm mt-1 hidden" id="trip-duration-error" data-translate="durationError">Duration is required</p>
                    </div>
                    </div>
                    
                    <!-- Pickup Time (Scroll List with AM/PM) -->
                    <div class="border-b border-gray-200 pb-4">
                    <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="pickupTime">Pickup Time <span class="text-red-600">*</span></label>
                            <select id="pickup-time" name="pickup-time" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold">
                                <option value="" data-translate="pickupTimeSelect">Select pickup time</option>
                                <optgroup label="AM" data-translate="pickupTimeAM">
                                    <option value="06:00">6:00 AM</option>
                                    <option value="06:30">6:30 AM</option>
                                    <option value="07:00">7:00 AM</option>
                                    <option value="07:30">7:30 AM</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="08:30">8:30 AM</option>
                                    <option value="09:00">9:00 AM</option>
                                    <option value="09:30">9:30 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="10:30">10:30 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="11:30">11:30 AM</option>
                                </optgroup>
                                <optgroup label="PM" data-translate="pickupTimePM">
                                    <option value="12:00">12:00 PM</option>
                                    <option value="12:30">12:30 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                    <option value="13:30">1:30 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="14:30">2:30 PM</option>
                                    <option value="15:00">3:00 PM</option>
                                    <option value="15:30">3:30 PM</option>
                                    <option value="16:00">4:00 PM</option>
                                    <option value="16:30">4:30 PM</option>
                                    <option value="17:00">5:00 PM</option>
                                    <option value="17:30">5:30 PM</option>
                                    <option value="18:00">6:00 PM</option>
                                    <option value="18:30">6:30 PM</option>
                                    <option value="19:00">7:00 PM</option>
                                    <option value="19:30">7:30 PM</option>
                                    <option value="20:00">8:00 PM</option>
                                </optgroup>
                            </select>
                            <p class="text-red-600 text-sm mt-1 hidden" id="pickup-time-error" data-translate="pickupTimeError">Pickup time is required</p>
                    </div>
                    </div>
                    
                    <!-- Driver Option (Default: School Driver) -->
                    <div class="border-b border-gray-200 pb-4">
                    <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="driverOption">Driver Option <span class="text-red-600">*</span></label>
                            <select id="driver-option" name="driver-option" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold">
                                <option value="school-driver" selected data-translate="driverOptionSchool">Request a School Driver</option>
                                <option value="self-drive" data-translate="driverOptionSelf">Self-Drive / Own Authorized Driver</option>
                        </select>
                            <p class="text-red-600 text-sm mt-1 hidden" id="driver-option-error" data-translate="driverOptionError">Please select a driver option</p>
                    </div>
                        
                        <!-- School Driver Details -->
                        <div id="school-driver-details" class="mt-4 space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-blue-800 mb-3" data-translate="schoolDriverRequirements">School Driver Requirements</h4>
                    <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="pickupLocation">Pickup Location <span class="text-red-600">*</span></label>
                                    <input type="text" id="pickup-location" name="pickup-location" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" placeholder="e.g., Main School Gate, Building A Entrance" data-placeholder-key="pickupLocationPlaceholder">
                                    <p class="text-red-600 text-sm mt-1 hidden" id="pickup-location-error" data-translate="pickupLocationError">Pickup location is required</p>
                    </div>
                            </div>
                        </div>
                        
                        <!-- Self-Drive Authorization Status (Not Auto-Approved) -->
                        <div id="driver-authorization-status" class="mt-4 hidden">
                            <div id="authorization-authorized" class="hidden p-4 bg-green-50 border-2 border-green-400 rounded-lg shadow-md">
                                <div class="flex items-center gap-3 mb-2">
                                    <svg class="w-8 h-8 text-green-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <span class="text-base font-bold text-green-800 block" data-translate="authorizedMessage">‚úÖ You are authorized</span>
                                        <p class="text-sm text-green-700 mt-1" data-translate="authorizedDesc">Self-Drive / Own Authorized Driver option is available for this vehicle type.</p>
                                    </div>
                                </div>
                            </div>
                            <div id="authorization-not-authorized" class="hidden p-4 bg-red-50 border-2 border-red-400 rounded-lg shadow-md">
                                <div class="flex items-center gap-3 mb-2">
                                    <svg class="w-8 h-8 text-red-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <span class="text-base font-bold text-red-800 block" data-translate="notAuthorizedMessage">‚ùå Not authorized for this vehicle class</span>
                                        <p class="text-sm text-red-700 mt-1" data-translate="notAuthorizedDesc">Please select 'Request a School Driver' instead.</p>
                                    </div>
                                </div>
                            </div>
                            <div id="authorization-pending" class="hidden p-4 bg-yellow-50 border-2 border-yellow-400 rounded-lg shadow-md">
                                <div class="flex items-center gap-3 mb-2">
                                    <svg class="w-8 h-8 text-yellow-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <span class="text-base font-bold text-yellow-800 block" data-translate="authorizationPending">‚è≥ Self-Drive Authorization Pending</span>
                                        <p class="text-sm text-yellow-700 mt-1" data-translate="authorizationPendingDesc">Your authorization status will be verified by HR. This option is not automatically approved.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Number of Passengers -->
                    <div class="border-b border-gray-200 pb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="numberOfPassengers">Number of Passengers <span class="text-red-600">*</span></label>
                        <input type="number" id="passengers" name="passengers" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" placeholder="e.g., 45">
                        <p class="text-red-600 text-sm mt-1 hidden" id="passengers-error">Please enter a valid number of passengers</p>
                            <p class="text-xs text-gray-500 mt-1" id="passengers-capacity-info"></p>
                    </div>
                    </div>
                    
                    <!-- Additional Notes -->
                    <div class="border-b border-gray-200 pb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="additionalNotes">Additional Notes</label>
                            <textarea rows="3" id="notes" name="notes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" placeholder="Any special requirements or additional information..."></textarea>
                    </div>
                    </div>
                    
                    <!-- Final Review & Submit -->
                    <div class="border-t border-gray-200 pt-4">
                        <!-- Dynamic Availability Feedback Area -->
                        <div id="availability-feedback" class="hidden mb-4">
                            <div id="availability-status" class="p-4 rounded-lg mb-4"></div>
                            <div id="alternative-vehicles" class="hidden mb-4"></div>
                            <div id="time-suggestions" class="hidden mb-4"></div>
                        </div>
                        
                        <div id="booking-summary" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                            <h4 class="text-sm font-semibold text-gray-800 mb-3" data-translate="bookingSummary">Booking Summary</h4>
                            <div id="summary-content" class="text-sm text-gray-700 space-y-2"></div>
                        </div>
                        
                    <div class="flex space-x-3">
                            <button type="submit" id="submit-booking-btn" class="px-6 py-2 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled data-translate="submitRequest">Submit Request</button>
                        <button type="button" onclick="window.location.hash = 'guest/employee'" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300" data-translate="cancel">Cancel</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- My Bookings View -->
        <div id="view-my-bookings" class="view-section w-full">
            <div class="bg-white p-6 sm:p-8 lg:p-10 rounded-xl shadow-lg mb-6 border-t-8 border-isd-gold w-full">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-3xl font-bold text-gray-800" data-translate="employeeMyBookingsTitle">My Bookings</h2>
                    <button onclick="window.location.hash = 'guest/employee'" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold" data-translate="backToDashboard">‚Üê Back to Dashboard</button>
                </div>
                <p class="text-gray-600" data-translate="employeeMyBookingsDesc">View and track your booking requests</p>
            </div>
            
            <div class="space-y-4">
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-lg font-bold text-gray-800" data-translate="museumFieldTrip">Museum Field Trip</h3>
                                <span class="px-3 py-1 bg-green-500 text-white rounded-full text-xs font-semibold shadow-sm" data-translate="approved">Approved</span>
                        </div>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="dateLabel">Date:</span> March 10, 2025 | <span data-translate="timeLabel">Time:</span> 9:00 AM</p>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="vehicleLabel">Vehicle:</span> <span data-translate="bus">Bus</span> (50 <span data-translate="seats">seats</span>) | <span data-translate="passengersLabel">Passengers:</span> 45</p>
                    </div>
                    </div>
                    <button onclick="viewBookingDetails('museum-field-trip')" class="text-isd-gold hover:underline text-sm font-semibold" data-translate="viewDetails">View Details</button>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-lg font-bold text-gray-800" data-translate="sportsEvent">Sports Event</h3>
                                <span class="px-3 py-1 bg-yellow-500 text-white rounded-full text-xs font-semibold shadow-sm" data-translate="pending">Pending</span>
                        </div>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="dateLabel">Date:</span> March 18, 2025 | <span data-translate="timeLabel">Time:</span> 2:00 PM</p>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="vehicleLabel">Vehicle:</span> <span data-translate="vehicleTypeVan">Van (15 seats)</span> | <span data-translate="passengersLabel">Passengers:</span> 20</p>
                            <p class="text-yellow-700 text-xs font-medium mt-2 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                </svg>
                                <span data-translate="submittedAgo">Submitted 4 hours ago</span>
                            </p>
                    </div>
                </div>
                    <button onclick="viewBookingDetails('sports-event-booking')" class="text-isd-gold hover:underline text-sm font-semibold" data-translate="viewDetails">View Details</button>
            </div>
                
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-gray-800" data-translate="weekendWorkshop">Weekend Workshop</h3>
                                <span class="px-3 py-1 bg-red-500 text-white rounded-full text-xs font-semibold shadow-sm" data-translate="denied">Denied</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="dateLabel">Date:</span> March 20, 2025 | <span data-translate="timeLabel">Time:</span> 8:00 AM</p>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="vehicleLabel">Vehicle:</span> Bus (50 <span data-translate="seats">seats</span>) | <span data-translate="passengersLabel">Passengers:</span> 30</p>
                            <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                                <p class="text-red-800 text-xs font-semibold mb-1" data-translate="adminNote">Admin Note:</p>
                                <p class="text-red-700 text-sm" data-translate="noBusesAvailableWeekend">No buses available for weekend trips. Please consider alternative dates or use a smaller vehicle.</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="viewBookingDetails('weekend-workshop')" class="text-isd-gold hover:underline text-sm font-semibold" data-translate="viewDetails">View Details</button>
        </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-gray-800" data-translate="scienceMuseum">Science Museum Trip</h3>
                                <span class="px-3 py-1 bg-blue-500 text-white rounded-full text-xs font-semibold shadow-sm" data-translate="activeTrip">Active Trip</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="dateLabel">Date:</span> March 15, 2025 | <span data-translate="timeLabel">Time:</span> 10:00 AM</p>
                            <p class="text-gray-600 text-sm mb-1"><span data-translate="vehicleLabel">Vehicle:</span> Bus (50 <span data-translate="seats">seats</span>) | <span data-translate="passengersLabel">Passengers:</span> 42</p>
                        </div>
                    </div>
                    <button onclick="viewBookingDetails('science-museum')" class="text-isd-gold hover:underline text-sm font-semibold" data-translate="viewDetails">View Details</button>
                </div>
            </div>
        </div>

        <!-- Assigned Trips View (My Trips - Active Trip Screen) -->
        <div id="view-assigned-trips" class="view-section w-full">
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-4 border-t-4 border-isd-gold w-full">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800" data-translate="myActiveTrip">My Active Trip</h2>
                    <button onclick="window.location.hash = 'guest/driver'" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold text-sm" data-translate="dashboard">‚Üê Dashboard</button>
                </div>
            </div>
            
            <!-- Active Trip Card -->
            <div id="active-trip-card" class="bg-white p-6 rounded-xl shadow-lg mb-6 border-l-4 border-blue-500" data-trip-id="museum-trip" data-status="scheduled">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold text-gray-800" data-translate="museumFieldTrip">Museum Field Trip</h3>
                        <span id="trip-status-badge" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold" data-translate="scheduled">Scheduled</span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-700">
                        <p><span class="font-semibold" data-translate="dateLabel">Date:</span> March 10, 2025</p>
                        <p><span class="font-semibold" data-translate="pickupTimeLabel">Pickup Time:</span> 9:00 AM</p>
                        <p><span class="font-semibold" data-translate="vehicleLabel">Vehicle:</span> VH-001 (<span data-translate="bus">Bus</span> - 50 <span data-translate="seats">seats</span>)</p>
                        <p><span class="font-semibold" data-translate="passengersLabel">Passengers:</span> 45 <span data-translate="students">students</span></p>
                        <p><span class="font-semibold" data-translate="pickupLocationLabel">Pickup Location:</span> <span data-translate="mainSchoolGate">Main School Gate</span></p>
                        <p><span class="font-semibold" data-translate="routeLabel">Route:</span> <span data-translate="routeIsdMuseumIsd">ISD ‚Üí Museum ‚Üí ISD</span></p>
                    </div>
                </div>
                
                <!-- Single-Tap Delay Communication Button -->
                <div class="mb-6">
                    <button id="delay-notification-btn" onclick="sendDelayNotification()" class="w-full py-5 px-8 bg-orange-500 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-orange-600 active:scale-95 transition-transform border-2 border-orange-400" data-translate="runningLate">
                        ‚è±Ô∏è Running 10 Mins Late
                    </button>
                    <p class="text-xs text-gray-600 mt-2 text-center" data-translate="delayNotificationDesc">Tap to instantly notify employee and admin</p>
                </div>
                
                <!-- Guided Status Workflow (Sequential Buttons) -->
            <div class="space-y-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-3" data-translate="tripStatusUpdates">Trip Status Updates</h4>
                    
                    <!-- Step 1: Start Trip (Departing from garage/depot) -->
                    <div class="border-l-4 border-green-500 pl-4">
                        <button id="start-trip-btn" onclick="updateTripStatus('start-trip')" class="w-full py-5 px-8 bg-green-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-green-700 active:scale-95 transition-transform border-2 border-green-500" data-translate="startTrip">
                            üöó Start Trip
                        </button>
                        <p class="text-xs text-gray-600 mt-1" data-translate="departingFromGarage">Departing from garage/depot</p>
                        </div>
                    
                    <!-- Step 2: Arrived at Pickup (Disabled until Start Trip is clicked) -->
                    <div class="border-l-4 border-gray-300 pl-4">
                        <button id="arrived-pickup-btn" onclick="updateTripStatus('arrived-pickup')" class="w-full py-5 px-8 bg-blue-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-blue-700 active:scale-95 transition-transform border-2 border-blue-500 disabled:bg-gray-300 disabled:cursor-not-allowed disabled:opacity-50" disabled data-translate="arrivedAtPickup">
                            üìç Arrived at Pickup
                        </button>
                        <p class="text-xs text-gray-600 mt-1" data-translate="arrivedAtPickupLocation">Arrived at pickup location</p>
                    </div>
                    
                    <!-- Step 3: Pre-Departure Safety Checklist (Mandatory Gate) -->
                    <div id="safety-check-section" class="border-l-4 border-yellow-500 pl-4 bg-yellow-50 p-4 rounded-lg opacity-50">
                        <h4 class="text-base font-bold text-gray-800 mb-3" data-translate="preDepartureSafetyChecklist">Pre-Departure Safety Checklist</h4>
                        <p class="text-xs text-gray-600 mb-3" data-translate="completeAllChecks">Complete all checks before starting drive (Available after arriving at pickup)</p>
                        <div class="space-y-2">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="check-tires" onchange="checkAllSafetyChecks()" class="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500" disabled>
                                <span class="text-sm text-gray-800" data-translate="tiresChecked">Tires checked (pressure & condition)</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="check-lights" onchange="checkAllSafetyChecks()" class="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500" disabled>
                                <span class="text-sm text-gray-800" data-translate="lightsFunctional">Lights functional (headlights, brake lights, indicators)</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="check-brakes" onchange="checkAllSafetyChecks()" class="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500" disabled>
                                <span class="text-sm text-gray-800" data-translate="brakesTested">Brakes tested</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="check-fuel" onchange="checkAllSafetyChecks()" class="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500" disabled>
                                <span class="text-sm text-gray-800" data-translate="fuelLevelAdequate">Fuel level adequate</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="check-mirrors" onchange="checkAllSafetyChecks()" class="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500" disabled>
                                <span class="text-sm text-gray-800" data-translate="mirrorsAdjusted">Mirrors adjusted</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="check-first-aid" onchange="checkAllSafetyChecks()" class="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500" disabled>
                                <span class="text-sm text-gray-800" data-translate="firstAidKitPresent">First aid kit present</span>
                            </label>
                        </div>
                        <div class="mt-3 pt-3 border-t border-yellow-300">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="safety-check-confirmed" onchange="toggleStartDrivingButton()" class="w-6 h-6 rounded border-gray-300 text-green-600 focus:ring-green-500" disabled>
                                <span class="text-base font-bold text-gray-800" data-translate="safetyCheckConfirmed">All Safety Checks Confirmed</span>
                            </label>
                        </div>
                </div>
                
                    <!-- Step 4: Start Driving (Disabled until Safety Check is confirmed) -->
                    <div class="border-l-4 border-gray-300 pl-4">
                        <button id="start-driving-btn" onclick="updateTripStatus('start-driving')" class="w-full py-5 px-8 bg-purple-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-purple-700 active:scale-95 transition-transform border-2 border-purple-500 disabled:bg-gray-300 disabled:cursor-not-allowed disabled:opacity-50" disabled data-translate="startDriving">
                            ‚ñ∂Ô∏è Start Driving
                        </button>
                        <p class="text-xs text-gray-600 mt-1" data-translate="passengersLoaded">Passengers loaded, trip underway</p>
                        </div>
                    
                    <!-- Step 5: Arrived at Destination -->
                    <div class="border-l-4 border-gray-300 pl-4">
                        <button id="arrived-destination-btn" onclick="updateTripStatus('arrived-destination')" class="w-full py-5 px-8 bg-indigo-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-transform border-2 border-indigo-500 disabled:bg-gray-300 disabled:cursor-not-allowed disabled:opacity-50" disabled data-translate="arrivedDestination">
                            üéØ Arrived at Destination
                        </button>
                        <p class="text-xs text-gray-600 mt-1" data-translate="arrivedAtDestinationText">Arrived at destination</p>
                    </div>
                    
                    <!-- Step 6: Trip Complete (Opens Finalization Log) -->
                    <div class="border-l-4 border-gray-300 pl-4">
                        <button id="trip-complete-btn" onclick="openTripFinalization()" class="w-full py-5 px-8 bg-gray-700 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-gray-800 active:scale-95 transition-transform border-2 border-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed disabled:opacity-50" disabled data-translate="tripComplete">
                            ‚úÖ Trip Complete
                        </button>
                        <p class="text-xs text-gray-600 mt-1" data-translate="completeTripSubmitLog">Complete trip and submit log</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trip Finalization/Log Screen -->
        <div id="view-trip-finalization" class="view-section w-full">
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-4 border-t-4 border-isd-gold w-full">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800" data-translate="tripFinalization">Trip Finalization</h2>
                    <button onclick="window.location.hash = 'assigned-trips'" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold text-sm" data-translate="cancel">‚Üê Back</button>
                </div>
                <p class="text-gray-600 text-sm" data-translate="completeTripSubmitFinalLog">Complete trip and submit final log</p>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-2" data-translate="museumFieldTrip">Museum Field Trip</h3>
                    <p class="text-sm text-gray-700"><span data-translate="dateLabel">Date:</span> March 10, 2025 | <span data-translate="vehicleLabel">Vehicle:</span> VH-001 (<span data-translate="bus">Bus</span>)</p>
                    </div>
                
                <form id="trip-finalization-form" class="space-y-6">
                    <!-- Mobile-First Fuel/Expense Logging (Quick Log) -->
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-4 mb-6">
                        <h4 class="text-base font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
                                <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"></path>
                            </svg>
                            Quick Fuel/Expense Log (Optional)
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">Fuel (Liters)</label>
                                <input type="number" id="fuel-liters" name="fuel-liters" min="0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-base" placeholder="0.0">
                    </div>
                    <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">Cost ($)</label>
                                <input type="number" id="fuel-cost" name="fuel-cost" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-base" placeholder="0.00">
                    </div>
                    <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">Odometer</label>
                                <input type="number" id="quick-odometer" name="quick-odometer" min="0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-base" placeholder="0.0">
                    </div>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">Log fuel and expenses quickly during trip (optional - can be updated later)</p>
                    </div>
                    
                    <!-- Mandatory Finalization Fields -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-bold text-gray-800 mb-4" data-translate="requiredTripMetrics">Required Trip Metrics</h4>
                        
                        <!-- Final Odometer Reading (Mandatory) -->
                    <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="finalOdometer">
                                Final Odometer Reading <span class="text-red-600">*</span>
                            </label>
                            <input type="number" id="final-odometer" name="final-odometer" required min="0" step="0.1" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-isd-gold text-lg" placeholder="Enter odometer reading (miles)" data-placeholder-key="finalOdometerPlaceholder">
                            <p class="text-red-600 text-sm mt-1 hidden" id="odometer-error" data-translate="finalOdometerError">Odometer reading is required</p>
                    </div>
                        
                        <!-- Final Fuel Level (Mandatory) -->
                    <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="finalFuelLevel">
                                Final Fuel Level <span class="text-red-600">*</span>
                            </label>
                            <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
                                <label class="flex items-center justify-center p-4 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-isd-gold transition-colors fuel-level-option">
                                    <input type="radio" name="final-fuel-level" value="Full" required class="sr-only fuel-level-radio">
                                    <span class="text-sm font-semibold text-gray-700" data-translate="finalFuelLevelFull">Full</span>
                                </label>
                                <label class="flex items-center justify-center p-4 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-isd-gold transition-colors fuel-level-option">
                                    <input type="radio" name="final-fuel-level" value="3/4" required class="sr-only fuel-level-radio">
                                    <span class="text-sm font-semibold text-gray-700">3/4</span>
                                </label>
                                <label class="flex items-center justify-center p-4 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-isd-gold transition-colors fuel-level-option">
                                    <input type="radio" name="final-fuel-level" value="1/2" required class="sr-only fuel-level-radio">
                                    <span class="text-sm font-semibold text-gray-700">1/2</span>
                                </label>
                                <label class="flex items-center justify-center p-4 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-isd-gold transition-colors fuel-level-option">
                                    <input type="radio" name="final-fuel-level" value="1/4" required class="sr-only fuel-level-radio">
                                    <span class="text-sm font-semibold text-gray-700">1/4</span>
                                </label>
                                <label class="flex items-center justify-center p-4 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-isd-gold transition-colors fuel-level-option">
                                    <input type="radio" name="final-fuel-level" value="Empty" required class="sr-only fuel-level-radio">
                                    <span class="text-sm font-semibold text-gray-700" data-translate="finalFuelLevelEmpty">Empty</span>
                                </label>
                    </div>
                            <p class="text-red-600 text-sm mt-1 hidden" id="fuel-level-error" data-translate="finalFuelLevelError">Fuel level selection is required</p>
                        </div>
                        
                        <!-- Vehicle Issues/Comments (Mandatory) -->
                    <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="vehicleIssues">
                                Vehicle Issues/Comments <span class="text-red-600">*</span>
                            </label>
                            <textarea id="vehicle-issues" name="vehicle-issues" rows="4" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-isd-gold text-base" placeholder="Report any vehicle issues, damage, or additional comments..." data-placeholder-key="vehicleIssuesPlaceholder"></textarea>
                            <p class="text-red-600 text-sm mt-1 hidden" id="vehicle-issues-error" data-translate="vehicleIssuesError">Vehicle issues/comments are required</p>
                    </div>
                    </div>
                    
                    <!-- Submit Button (Disabled until all fields are filled) -->
                    <div class="border-t border-gray-200 pt-4">
                        <button type="submit" id="submit-trip-log-btn" class="w-full py-4 px-6 bg-gray-700 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 active:scale-95 transition-transform disabled:bg-gray-300 disabled:cursor-not-allowed disabled:opacity-50" disabled data-translate="submitLogComplete">
                            ‚úÖ Submit Log and Complete Trip
                        </button>
                        <p class="text-xs text-gray-600 mt-2 text-center">All fields must be completed before submission</p>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-isd-black text-gray-400 p-3 sm:p-4 mt-auto" style="padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));">
        <div class="max-w-6xl mx-auto flex justify-between items-center text-xs sm:text-sm px-2 sm:px-4">
            <span>&copy; 2025 ISD Car Booking for ISD</span>
        </div>
    </footer>

    <!-- Edit Vehicle Modal -->
    <div id="edit-vehicle-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-5 text-isd-black" data-translate="editVehicle">Edit Vehicle</h3>
            <form id="edit-vehicle-form" class="space-y-4" enctype="multipart/form-data">
                <input type="hidden" id="edit-vehicle-id">
                <input type="hidden" id="edit-vehicle-current-image">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="vehicleIdDisplay">Vehicle ID</label>
                    <input type="text" id="edit-vehicle-id-display" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" readonly>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="vehicleImage">Vehicle Image</label>
                    <div class="mb-3">
                        <img id="edit-vehicle-image-preview" src="" alt="Vehicle Preview" class="w-32 h-32 object-cover rounded-lg border-2 border-gray-300 mb-2 hidden">
                        <p id="edit-vehicle-image-current" class="text-sm text-gray-600 mb-2"></p>
                    </div>
                    <input type="file" id="edit-vehicle-image" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-isd-gold file:text-isd-black hover:file:bg-yellow-400">
                    <p class="text-xs text-gray-500 mt-1">Upload a new image to replace the current one (JPG, PNG, or GIF)</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="type">Type</label>
                    <select id="edit-vehicle-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold">
                        <option value="School Bus" data-translate="schoolBus">School Bus</option>
                        <option value="SUV" data-translate="suv">SUV</option>
                        <option value="Sedan" data-translate="sedan">Sedan</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="capacity">Capacity</label>
                    <input type="text" id="edit-vehicle-capacity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" placeholder="e.g., 50 seats" data-placeholder-key="capacityPlaceholder">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="status">Status</label>
                    <select id="edit-vehicle-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold">
                        <option value="Available" data-translate="statusAvailable">Available</option>
                        <option value="In Use" data-translate="statusInUse">In Use</option>
                        <option value="Maintenance" data-translate="statusInMaintenance">Maintenance</option>
                    </select>
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="px-6 py-2 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400" data-translate="saveChanges">Save Changes</button>
                    <button type="button" onclick="closeEditVehicleModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300" data-translate="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="add-vehicle-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-5 text-isd-black" data-translate="addNewVehicle">Add New Vehicle</h3>
            <form id="add-vehicle-form" class="space-y-4" enctype="multipart/form-data">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="vehicleId">Vehicle ID <span class="text-red-600">*</span></label>
                    <input type="text" id="add-vehicle-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" placeholder="e.g., VH-001" data-placeholder-key="vehicleIdPlaceholder" required>
                    <p class="text-xs text-gray-500 mt-1">Unique identifier for this vehicle</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="vehicleImage">Vehicle Image</label>
                    <div class="mb-3">
                        <img id="add-vehicle-image-preview" src="" alt="Vehicle Preview" class="w-32 h-32 object-cover rounded-lg border-2 border-gray-300 mb-2 hidden">
                    </div>
                    <input type="file" id="add-vehicle-image" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-isd-gold file:text-isd-black hover:file:bg-yellow-400">
                    <p class="text-xs text-gray-500 mt-1">Upload an image (JPG, PNG, or GIF)</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="vehicleTypeSelect">Vehicle Type <span class="text-red-600">*</span></label>
                    <select id="add-vehicle-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" required data-translate="vehicleTypeSelect">
                        <option value="" data-translate="vehicleTypeSelect">Select vehicle type</option>
                        <option value="Minibus" data-translate="vehicleTypeMinibus">Minibus</option>
                        <option value="Passenger Van" data-translate="vehicleTypePassengerVan">Passenger Van</option>
                        <option value="Sedan" data-translate="vehicleTypeSedan">Sedan</option>
                        <option value="School Bus" data-translate="vehicleTypeSchoolBus">School Bus</option>
                        <option value="SUV" data-translate="vehicleTypeSUV">SUV</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="capacity">Capacity <span class="text-red-600">*</span></label>
                    <input type="text" id="add-vehicle-capacity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" placeholder="e.g., 50 seats" data-placeholder-key="capacityPlaceholder" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="status">Status <span class="text-red-600">*</span></label>
                    <select id="add-vehicle-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" required>
                        <option value="Available" data-translate="statusAvailable">Available</option>
                        <option value="In Maintenance" data-translate="statusInMaintenance">In Maintenance</option>
                        <option value="In Use" data-translate="statusInUse">In Use</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="location">Location</label>
                    <input type="text" id="add-vehicle-location" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" placeholder="e.g., Garage 1" data-placeholder-key="locationPlaceholder">
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="px-6 py-2 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400" data-translate="addVehicle">Add Vehicle</button>
                    <button type="button" onclick="closeAddVehicleModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300" data-translate="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-5 text-isd-black" data-translate="editUser">Edit User</h3>
            <form id="edit-user-form" class="space-y-4">
                <input type="hidden" id="edit-user-id">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="name">Name</label>
                    <input type="text" id="edit-user-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="email">Email</label>
                    <input type="email" id="edit-user-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="role">Role</label>
                    <select id="edit-user-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold">
                        <option value="Employee" data-translate="roleEmployee">Employee</option>
                        <option value="Driver" data-translate="roleDriver">Driver</option>
                    </select>
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="px-6 py-2 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400" data-translate="saveChanges">Save Changes</button>
                    <button type="button" onclick="closeEditUserModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300" data-translate="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Testing Script (Development Only) -->
    <script src="load-test.js"></script>

    <!-- JavaScript for Basic Interactions (Language Toggle) -->
    <script>
        // Wait for DOM to be ready
        
        // Define app scope
        const app = {
            content: {
                en: {
                    // Header & Navigation
                    title: 'Your Centralized Transportation Platform',
                    text: 'Easily book vehicles for field trips, sports events, and staff travel. A centralized platform for all your school\'s transportation needs at the International School of Dakar.',
                    admin: 'Admin Access',
                    employee: 'Employee Login',
                    driver: 'Driver Login',
                    home: 'Home',
                    appName: 'ISD Car Booking',
                    langEn: 'EN',
                    langFr: 'FR',
                    
                    // Guest Mode
                    guestMode: 'GUEST MODE',
                    
                    // Admin Dashboard
                    adminDashboardTitle: 'Guest Admin Dashboard',
                    adminDashboardDesc: 'Welcome to the Admin Dashboard. You are logged in as a guest administrator.',
                    adminFleetTitle: 'Fleet Management',
                    adminFleetDesc: 'View and manage vehicle fleet',
                    adminFleetBtn: 'Manage Fleet',
                    manageFleet: 'Manage Fleet',
                    adminApprovalsTitle: 'Booking Approvals',
                    bookingApprovals: 'Booking Approvals',
                    adminApprovalsDesc: 'Review and approve booking requests',
                    adminApprovalsBtn: 'View Requests',
                    viewRequests: 'View Requests',
                    adminUsersTitle: 'User Management',
                    adminUsersDesc: 'Manage employees and drivers',
                    adminUsersBtn: 'Manage Users',
                    manageUsers: 'Manage Users',
                    backToDashboard: '‚Üê Back to Dashboard',
                    
                    // Employee Dashboard
                    employeeDashboardTitle: 'Guest Employee Dashboard',
                    employeeDashboardDesc: 'Welcome to the Employee Dashboard. You are logged in as a guest employee.',
                    employeeBookingTitle: 'New Booking Request',
                    employeeBookingDesc: 'Submit a new vehicle booking request',
                    employeeBookingBtn: 'Create Booking',
                    employeeMyBookingsTitle: 'My Bookings',
                    employeeMyBookingsDesc: 'View and track your booking requests',
                    employeeMyBookingsBtn: 'View Bookings',
                    newRequest: '+ New Request',
                    
                    // Driver Dashboard
                    driverDashboardTitle: 'Guest Driver Interface',
                    guestDriverInterface: 'Guest Driver Interface',
                    driverDashboardDesc: 'Welcome to the Driver Interface. You are logged in as a guest driver.',
                    guestDriverDesc: 'Welcome to the Driver Interface. You are logged in as a guest driver.',
                    driverTripsTitle: 'Assigned Trips',
                    assignedTrips: 'Assigned Trips',
                    driverTripsDesc: 'View your assigned trips and routes',
                    driverTripsBtn: 'View Trips',
                    viewTrips: 'View Trips',
                    driverStatusTitle: 'Update Status',
                    updateStatus: 'Update Status',
                    driverStatusDesc: 'Update trip status and location',
                    driverStatusBtn: 'Update Status',
                    myActiveTrip: 'My Active Trip',
                    dashboard: 'Dashboard',
                    
                    // Booking Form
                    tripPurpose: 'Trip Purpose',
                    tripPurposePlaceholder: 'e.g., Field trip to museum, School business, Airport transfer',
                    tripPurposeError: 'Trip purpose is required',
                    vehicleType: 'Vehicle Type',
                    vehicleTypeSelect: 'Select a vehicle type',
                    vehicleTypeBus: 'Bus / Minibus (50 seats)',
                    vehicleTypeVan: 'Van (15 seats)',
                    vehicleTypeCar: 'Sedan / Car (5 seats)',
                    vehicleTypeError: 'Please select a vehicle type',
                    startDate: 'Start Date',
                    dateError: 'Date is required',
                    duration: 'Duration',
                    durationSelect: 'Select duration',
                    durationHours: 'Hours',
                    durationDays: 'Days',
                    durationHour: 'hour',
                    durationHoursPlural: 'hours',
                    durationDay: 'day',
                    durationDaysPlural: 'days',
                    durationWeek: 'week',
                    duration1Hour: '1 hour',
                    duration2Hours: '2 hours',
                    duration3Hours: '3 hours',
                    duration4Hours: '4 hours',
                    duration5Hours: '5 hours',
                    duration6Hours: '6 hours',
                    duration8Hours: '8 hours',
                    duration10Hours: '10 hours',
                    duration12Hours: '12 hours',
                    duration1Day: '1 day',
                    duration2Days: '2 days',
                    duration3Days: '3 days',
                    duration4Days: '4 days',
                    duration5Days: '5 days',
                    duration6Days: '6 days',
                    duration7Days1Week: '7 days (1 week)',
                    durationError: 'Duration is required',
                    pickupTime: 'Pickup Time',
                    pickupTimeSelect: 'Select pickup time',
                    pickupTimeAM: 'AM',
                    pickupTimePM: 'PM',
                    pickupTimeError: 'Pickup time is required',
                    driverOption: 'Driver Option',
                    driverOptionSchool: 'Request a School Driver',
                    driverOptionSelf: 'Self-Drive / Own Authorized Driver',
                    driverOptionError: 'Please select a driver option',
                    schoolDriverRequirements: 'School Driver Requirements',
                    pickupLocation: 'Pickup Location',
                    pickupLocationPlaceholder: 'e.g., Main School Gate, Building A Entrance',
                    pickupLocationError: 'Pickup location is required',
                    authorizedMessage: '‚úÖ You are authorized',
                    authorizedDesc: 'Self-Drive / Own Authorized Driver option is available for this vehicle type.',
                    notAuthorizedMessage: '‚ùå Not authorized for this vehicle class',
                    notAuthorizedDesc: 'Please select \'Request a School Driver\' instead.',
                    authorizationPending: '‚è≥ Self-Drive Authorization Pending',
                    authorizationPendingDesc: 'Your authorization status will be verified by HR. This option is not automatically approved.',
                    numberOfPassengers: 'Number of Passengers',
                    passengersPlaceholder: 'e.g., 45',
                    passengersError: 'Please enter a valid number of passengers',
                    additionalNotes: 'Additional Notes',
                    notesPlaceholder: 'Any special requirements or additional information...',
                    submitRequest: 'Submit Request',
                    cancel: 'Cancel',
                    bookingSummary: 'Booking Summary',
                    license: 'License:',
                    viewTripPolicy: 'View Trip Policy',
                    
                    // Status Labels
                    pending: 'Pending',
                    approved: 'Approved',
                    denied: 'Denied',
                    active: 'Active',
                    activeTrip: 'Active Trip',
                    completed: 'Completed',
                    cancelled: 'Cancelled',
                    scheduled: 'Scheduled',
                    
                    // Example Content
                    museumFieldTrip: 'Museum Field Trip',
                    sportsEvent: 'Sports Event',
                    weekendWorkshop: 'Weekend Workshop',
                    scienceMuseum: 'Science Museum',
                    shortNotice: '‚ö†Ô∏è Short Notice',
                    scienceDepartment: 'Science Department',
                    athleticsDepartment: 'Athletics Department',
                    educationDepartment: 'Education Department',
                    noBusesAvailableWeekend: 'No buses available for weekend trips. Please consider alternative dates or use a smaller vehicle.',
                    students: 'students',
                    mainSchoolGate: 'Main School Gate',
                    routeIsdMuseumIsd: 'ISD ‚Üí Museum ‚Üí ISD',
                    bus: 'Bus',
                    
                    // Booking Actions
                    viewDetails: 'View Details',
                    modifyRequest: 'Modify Request',
                    cancelRequest: 'Cancel Request',
                    approve: 'Approve',
                    deny: 'Deny',
                    quickDeny: 'Quick Deny (Availability)',
                    
                    // Booking Approvals Queue
                    bookingApprovalsQueue: 'Booking Approvals Queue',
                    sort: 'Sort:',
                    filter: 'Filter:',
                    mostUrgentFirst: 'Most Urgent First',
                    dateNewestFirst: 'Date (Newest First)',
                    requesterName: 'Requester Name',
                    allRequests: 'All Requests',
                    urgent48h: 'Urgent (48h)',
                    policyViolations: 'Policy Violations',
                    exceedsMaxDuration: 'Exceeds Max Duration',
                    pendingRequests: 'pending requests',
                    
                    // Stats
                    statsPending: 'Pending',
                    statsApproved: 'Approved',
                    statsActive: 'Active',
                    statsDenied: 'Denied',
                    statsCompleted: 'Completed',
                    
                    // Fleet Management
                    fleetManagement: 'Fleet Management',
                    fleetManagementDesc: 'View and manage your vehicle fleet',
                    vehicleFleet: 'Vehicle Fleet',
                    addVehicle: '+ Add Vehicle',
                    addNewVehicle: 'Add New Vehicle',
                    editVehicle: 'Edit Vehicle',
                    deleteVehicle: 'Delete Vehicle',
                    vehicleId: 'Vehicle ID',
                    vehicleIdPlaceholder: 'e.g., VH-001',
                    vehicleImage: 'Vehicle Image',
                    vehicleTypeSelect: 'Select vehicle type',
                    vehicleTypeMinibus: 'Minibus',
                    vehicleTypePassengerVan: 'Passenger Van',
                    vehicleTypeSedan: 'Sedan',
                    vehicleTypeSchoolBus: 'School Bus',
                    vehicleTypeSUV: 'SUV',
                    capacity: 'Capacity',
                    capacityPlaceholder: 'e.g., 50 seats',
                    status: 'Status',
                    statusAvailable: 'Available',
                    statusInMaintenance: 'In Maintenance',
                    statusInUse: 'In Use',
                    location: 'Location',
                    locationPlaceholder: 'e.g., Garage 1',
                    saveChanges: 'Save Changes',
                    edit: 'Edit',
                    delete: 'Delete',
                    vehicleIdDisplay: 'Vehicle ID',
                    image: 'Image',
                    vehicleIdCol: 'Vehicle ID',
                    type: 'Type',
                    capacityCol: 'Capacity',
                    statusCol: 'Status',
                    actions: 'Actions',
                    schoolBus: 'School Bus',
                    suv: 'SUV',
                    sedan: 'Sedan',
                    
                    // Driver Trip Status
                    tripStatusUpdates: 'Trip Status Updates',
                    startTrip: 'üöó Start Trip',
                    arrivedAtPickup: 'üìç Arrived at Pickup',
                    startDriving: 'üöô Start Driving',
                    arrivedDestination: 'üèÅ Arrived at Destination',
                    tripComplete: '‚úÖ Trip Complete',
                    runningLate: '‚è±Ô∏è Running 10 Mins Late',
                    delayNotificationSent: '‚è±Ô∏è Notification Sent!',
                    delayNotificationDesc: 'Tap to instantly notify employee and admin',
                    
                    // Safety Checks
                    safetyCheck: 'Vehicle Safety Check',
                    safetyCheckConfirmed: 'All Safety Checks Confirmed',
                    checkTires: 'Tires',
                    checkLights: 'Lights',
                    checkBrakes: 'Brakes',
                    checkFuel: 'Fuel',
                    checkMirrors: 'Mirrors',
                    checkFirstAid: 'First Aid Kit',
                    
                    // Trip Finalization
                    tripFinalization: 'Trip Finalization',
                    finalOdometer: 'Final Odometer Reading',
                    finalOdometerPlaceholder: 'e.g., 12500',
                    finalOdometerError: 'Please enter a valid odometer reading',
                    finalFuelLevel: 'Final Fuel Level',
                    finalFuelLevelFull: 'Full',
                    finalFuelLevelThreeQuarter: '3/4',
                    finalFuelLevelHalf: '1/2',
                    finalFuelLevelQuarter: '1/4',
                    finalFuelLevelEmpty: 'Empty',
                    finalFuelLevelError: 'Please select fuel level',
                    vehicleIssues: 'Vehicle Issues/Comments',
                    vehicleIssuesPlaceholder: 'Any issues or comments about the vehicle...',
                    vehicleIssuesError: 'Please provide vehicle issues or comments',
                    submitLogComplete: 'Submit Log and Complete',
                    
                    // Update Status Form
                    updateStatus: 'Update Trip Status',
                    selectTrip: 'Select Trip',
                    selectTripPlaceholder: 'Choose a trip',
                    currentStatus: 'Current Status',
                    currentStatusPlaceholder: 'Select status',
                    currentLocation: 'Current Location',
                    currentLocationPlaceholder: 'Enter current location',
                    statusNotes: 'Status Notes',
                    statusNotesPlaceholder: 'Any additional notes...',
                    
                    // Messages
                    submittedAgo: 'Submitted {hours} hours ago',
                    waitingForAdmin: 'Waiting for Admin Action',
                    adminNote: 'Admin Note:',
                    driverStatus: 'Driver Status:',
                    tripFinalizationLog: 'Trip Finalization Log:',
                    finalOdometerLabel: 'Final Odometer:',
                    finalFuelLevelLabel: 'Final Fuel Level:',
                    vehicleIssuesLabel: 'Vehicle Issues/Comments:',
                    vehicleIssuesComments: 'Vehicle Issues/Comments',
                    miles: 'miles',
                    noneReported: 'None reported',
                    
                    // Additional Employee Dashboard Labels
                    driverLabel: 'Driver',
                    schoolDriver: 'School Driver',
                    isCurrently: 'is currently',
                    viewFullDriverStatus: 'View Full Driver Status',
                    adminNoteRequiredJustification: 'Admin Note (Required Justification)',
                    waitingForAdminAction: 'Waiting for Admin Action',
                    waiting: 'Waiting',
                    day: 'day',
                    days: 'days',
                    hour: 'hour',
                    hours: 'hours',
                    minute: 'minute',
                    minutes: 'minutes',
                    waitingLessThan1Hour: 'Waiting less than 1 hour',
                    
                    // Resource Health
                    resourceHealth: 'Resource Health',
                    driverStatus: 'Driver Status',
                    driverAvailable: 'Available',
                    driverOnTrip: 'On Trip',
                    driverUnavailable: 'Unavailable',
                    vehicleWarnings: 'Vehicle Warnings',
                    maintenanceDue: 'Maintenance Due',
                    outOfCommission: 'Out of Commission',
                    days: 'days',
                    
                    // User Management
                    userManagement: 'User Management',
                    editUser: 'Edit User',
                    name: 'Name',
                    email: 'Email',
                    role: 'Role',
                    roleEmployee: 'Employee',
                    roleDriver: 'Driver',
                    addDriver: '+ Add Driver',
                    
                    // Common
                    date: 'Date',
                    time: 'Time',
                    vehicle: 'Vehicle',
                    passengers: 'Passengers',
                    driver: 'Driver',
                    route: 'Route',
                    pickupLocationLabel: 'Pickup Location:',
                    routeLabel: 'Route:',
                    dateLabel: 'Date:',
                    timeLabel: 'Time:',
                    vehicleLabel: 'Vehicle:',
                    passengersLabel: 'Passengers:',
                    tripPurposeLabel: 'Trip Purpose:',
                    pickupTimeLabel: 'Pickup Time:',
                    requestedBy: 'Requested by:',
                    ourFleet: 'Our Fleet',
                    fleetDesc: 'A diverse range of vehicles to meet all your transportation needs',
                    available: 'Available',
                    seats: 'seats',
                    perfectFor: 'Perfect for',
                    largeGroups: 'large groups',
                    smallGroups: 'small groups',
                    viewAllBookings: 'View All Bookings',
                    viewAllRequests: 'View All Requests',
                    urgent: 'URGENT',
                    waiting: 'Waiting',
                    hours: 'hours',
                    ago: 'ago',
                    since: 'since',
                    required: '*',
                    
                    // Error/Success Messages
                    errorRequired: 'This field is required',
                    errorInvalid: 'Please enter a valid value',
                    successBookingCreated: 'Booking request submitted successfully!',
                    successBookingApproved: 'Booking request has been approved successfully!',
                    successBookingDenied: 'Booking request has been denied successfully.',
                    successBookingCancelled: 'Booking cancelled successfully!',
                    successStatusUpdated: 'Status updated successfully!',
                    successTripFinalized: 'Trip finalized successfully!',
                    errorBookingFailed: 'Failed to create booking. Please try again.',
                    errorApprovalFailed: 'Failed to approve booking. Please try again.',
                    errorDenialFailed: 'Failed to deny booking. Please try again.',
                    errorCancellationFailed: 'Failed to cancel booking. Please try again.',
                    
                    // Booking Queue
                    pendingRequests: 'Pending Requests',
                    queueCount: 'Queue Count',
                    sortBy: 'Sort By',
                    sortUrgency: 'Urgency',
                    sortDate: 'Date',
                    filterBy: 'Filter By',
                    filterAll: 'All',
                    filterViolations: 'Policy Violations',
                    
                    // Vehicle Booking
                    selectVehicleType: 'Select a vehicle type',
                    selectDuration: 'Select duration',
                    selectPickupTime: 'Select pickup time',
                    checkingAvailability: 'Checking availability...',
                    availableSlot: '‚úì Time slot available',
                    conflictDetected: 'Conflicting bookings detected',
                    alternativeVehicles: 'Alternative Vehicles Available',
                    timeSuggestions: 'Time Suggestions',
                    
                    // Admin Detail View
                    requestDetails: 'Request Details',
                    dateTime: 'Date & Time',
                    duration: 'Duration',
                    vehicleTypeLabel: 'Vehicle Type',
                    passengersLabel: 'Passengers',
                    purpose: 'Purpose',
                    requesterProfile: 'Requester Profile',
                    nameDepartment: 'Name & Department',
                    contact: 'Contact',
                    totalBookings: 'Total Bookings',
                    bookingStatisticsLast90Days: 'Booking Statistics (Last 90 Days)',
                    cancelledBookings: 'Canceled/Denied Bookings (Lifetime)',
                    availabilityConflictsTimeline: 'Availability & Conflicts Timeline',
                    requestedTimeSlot: 'Requested Time Slot',
                    conflict: 'Conflict',
                    conflictingBookingsDetected: 'Conflicting Bookings Detected',
                    noConflictsDetected: 'No conflicts detected - Time slot available',
                    policyViolationFlags: 'Policy Violation Flags',
                    canceled: 'Canceled',
                    cancellationRate: 'Cancellation Rate',
                    canceledOutOf: 'canceled out of',
                    bookings: 'bookings',
                    denyRequest: 'Deny Request',
                    approveRequest: 'Approve Request',
                    dateTimeLabel: 'Date & Time',
                    at: 'at',
                    shortNotice: '‚ö†Ô∏è Short Notice Request',
                    exceedsMaxDuration: 'üö´ Exceeds Max Duration',
                    weekendBooking: 'üìÖ Weekend Booking',
                    
                    // Denial Modal
                    denyBookingRequest: 'Deny Booking Request',
                    denialTemplate: 'Denial Template',
                    denialMessage: 'Denial Message',
                    sendDenial: 'Send Denial',
                    vehicleUnavailable: 'Vehicle Unavailable',
                    insufficientLeadTime: 'Insufficient Lead Time',
                    missingDocumentation: 'Missing Documentation',
                    exceedsMaximumDuration: 'Exceeds Maximum Duration',
                    customMessage: 'Custom Message',
                    
                    // Driver Status Messages
                    enRoute: 'En Route',
                    arrivedAtPickup: 'Arrived at Pickup',
                    driving: 'Driving',
                    arrivedAtDestination: 'Arrived at Destination',
                    tripCompleted: 'Completed',
                    isCurrently: 'is currently',
                    viewFullStatus: 'View Full Driver Status',
                    
                    // Success Modal
                    bookingSubmitted: 'Booking Request Submitted Successfully!',
                    bookingSubmittedDesc: 'Your booking request has been submitted and is now pending admin approval.',
                    bookingId: 'Booking ID',
                    goToDashboard: 'Go to Dashboard',
                    viewBooking: 'View Booking',
                    
                    // Vehicle Types
                    busMinibus: 'Bus / Minibus',
                    van: 'Van',
                    sedanCar: 'Sedan / Car',
                    
                    // Home Page Vehicle Cards
                    schoolBus: 'School Bus',
                    schoolBusDesc: '50 seats ‚Ä¢ Perfect for field trips and large groups',
                    suv: 'SUV',
                    suvDesc: '7 seats ‚Ä¢ Comfortable for small groups',
                    sedan: 'Sedan',
                    sedanDesc: '5 seats ‚Ä¢ Ideal for staff travel',
                    
                    // Driver Trip Details Labels
                    dateLabel: 'Date:',
                    pickupTimeLabel: 'Pickup Time:',
                    vehicleLabel: 'Vehicle:',
                    passengersLabel: 'Passengers:',
                    pickupLocationLabel: 'Pickup Location:',
                    routeLabel: 'Route:',
                    
                    // Safety Checklist
                    preDepartureSafetyChecklist: 'Pre-Departure Safety Checklist',
                    completeAllChecks: 'Complete all checks before starting drive (Available after arriving at pickup)',
                    tiresChecked: 'Tires checked (pressure & condition)',
                    lightsFunctional: 'Lights functional (headlights, brake lights, indicators)',
                    brakesTested: 'Brakes tested',
                    fuelLevelAdequate: 'Fuel level adequate',
                    mirrorsAdjusted: 'Mirrors adjusted',
                    firstAidKitPresent: 'First aid kit present',
                    
                    // Button Helper Text
                    departingFromGarage: 'Departing from garage/depot',
                    arrivedAtPickupLocation: 'Arrived at pickup location',
                    passengersLoaded: 'Passengers loaded, trip underway',
                    arrivedAtDestinationText: 'Arrived at destination',
                    completeTripSubmitLog: 'Complete trip and submit log',
                    completeTripSubmitFinalLog: 'Complete trip and submit final log',
                    
                    // Trip Finalization
                    requiredTripMetrics: 'Required Trip Metrics',
                    
                    // Resource Health
                    resourceHealth: 'Resource Health',
                    driverStatusLabel: 'Driver Status',
                    
                    // Admin Dashboard
                    adminDashboard: 'Admin Dashboard',
                    decisionManagementHub: 'Decision and Management Hub',
                    
                    // Platform Features
                    platformFeatures: 'Platform Features',
                    easyBooking: 'Easy Booking',
                    easyBookingDesc: 'Book vehicles with just a few clicks',
                    quickApprovals: 'Quick Approvals',
                    quickApprovalsDesc: 'Streamlined approval workflow',
                    realTimeTracking: 'Real-time Tracking',
                    realTimeTrackingDesc: 'Monitor trip status in real-time',
                    
                    // Additional Labels
                    timeLabel: 'Time:',
                    requestedBy: 'Requested by:',
                    submittedAgo: 'Submitted 4 hours ago',
                    scheduled: 'Scheduled',
                    days: 'days',
                    
                    // Dynamic Messages
                    currentImage: 'Current image:',
                    noImageCurrently: 'No image currently',
                    newImagePreview: 'New image preview:',
                    vehicleCapacity: 'Vehicle capacity:',
                    passengers: 'passengers',
                    cannotExceedCapacity: 'Cannot exceed vehicle capacity of',
                    pleaseEnterValidPassengers: 'Please enter a valid number of passengers',
                    
                    // Modal Content
                    driverStatusTitle: 'Driver Status:',
                    realTimeStatusUpdates: 'Real-time Status Updates:',
                    driverStatusUpdatesDesc: 'Driver status updates automatically every 30 seconds. This replaces the need for direct employee/driver communication.',
                    tripPolicyTitle: 'Trip Policy & Documentation Requirements',
                    requiredDocumentation: 'Required Documentation:',
                    completedTripRequestForm: 'Completed trip request form',
                    parentalConsentForms: 'Parental consent forms (for student trips)',
                    emergencyContactInfo: 'Emergency contact information',
                    medicalInfoParticipants: 'Medical information for participants',
                    bookingGuidelines: 'Booking Guidelines:',
                    bookAtLeast2Weeks: 'Book at least 2 weeks in advance',
                    maximumCapacityRespected: 'Maximum capacity must be respected',
                    cancellation48Hours: 'Cancellation must be made 48 hours before trip',
                    selfDriveAuthorizationRequired: 'Self-drive authorization required for certain vehicle classes',
                    safetyRequirements: 'Safety Requirements:',
                    allPassengersWearSeatbelts: 'All passengers must wear seatbelts',
                    firstAidKitMustBePresent: 'First aid kit must be present',
                    emergencyContactNumbersAccessible: 'Emergency contact numbers must be accessible',
                    bookingSubmittedSuccessfully: 'Booking Request Submitted Successfully!',
                    requestReceivedPending: 'Your request has been received and is now pending admin approval.',
                    whatHappensNext: 'What happens next:',
                    emailNotificationOnReview: 'You will receive an email notification when the admin reviews your request',
                    trackStatusInDashboard: 'You can track the status in "My Bookings" dashboard',
                    statusUpdatesRealTime: 'Status updates will appear in real-time on the dashboard',
                    dashboardAutoRefreshes: 'The dashboard automatically refreshes when your booking status changes',
                    realTimeDashboardUpdates: 'Real-time Dashboard Updates',
                    noNeedCheckEmail: 'No need to check your email repeatedly - the dashboard will show all updates automatically!',
                    bookingAppearsInDashboard: 'Your booking will appear in "My Bookings" with live status updates. The dashboard refreshes automatically when your booking is approved, denied, or cancelled.',
                    
                    // Availability Messages
                    checkingAvailability: 'Checking availability...',
                    dateUnavailableSuggested: 'This date is unavailable. Suggested nearest available date:',
                    selectDate: 'Select',
                    busesUnavailablePeriod: 'Buses/Minibuses are unavailable from December 5-15, 2025',
                    selectDifferentDateOrVehicle: 'Please select a different date or choose Van/Car instead.',
                    busesUnavailable: 'Buses/Minibuses Unavailable',
                    busesUnavailableDesc: 'Buses and minibuses are unavailable from December 5-15, 2025. Please select a different date or choose Van/Car instead.',
                    alternativeVehiclesAvailable: 'Alternative Vehicles Available:',
                    vehicleAvailableForDateTime: 'Vehicle available for selected date and time!',
                    proceedSubmitBooking: 'You can proceed to submit your booking request.',
                    selectedVehicleNotAvailable: 'Selected vehicle type not available for this date/time',
                    timeSlotsAvailable: 'Time Slots Available:',
                    alternativeVehiclesSameTime: 'Alternative Vehicles Available for Same Time:'
                },
                fr: {
                    // Header & Navigation
                    title: 'Votre Plateforme de Transport Centralis√©e',
                    text: 'R√©servez facilement des v√©hicules pour les excursions, les √©v√©nements sportifs et les d√©placements du personnel. Une plateforme centralis√©e pour tous vos besoins de transport √† l\'√âcole Internationale de Dakar.',
                    admin: 'Acc√®s Administrateur',
                    employee: 'Connexion Employ√©',
                    driver: 'Connexion Chauffeur',
                    home: 'Accueil',
                    appName: 'ISD Car Booking',
                    langEn: 'EN',
                    langFr: 'FR',
                    
                    // Guest Mode
                    guestMode: 'MODE INVIT√â',
                    
                    // Admin Dashboard
                    adminDashboardTitle: 'Tableau de bord Admin Invit√©',
                    adminDashboardDesc: 'Bienvenue sur le tableau de bord Administrateur. Vous √™tes connect√© en tant qu\'administrateur invit√©.',
                    adminFleetTitle: 'Gestion de la Flotte',
                    adminFleetDesc: 'Voir et g√©rer la flotte de v√©hicules',
                    adminFleetBtn: 'G√©rer la Flotte',
                    manageFleet: 'G√©rer la Flotte',
                    adminApprovalsTitle: 'Approbations de R√©servation',
                    bookingApprovals: 'Approbations de R√©servation',
                    adminApprovalsDesc: 'Examiner et approuver les demandes de r√©servation',
                    adminApprovalsBtn: 'Voir les Demandes',
                    viewRequests: 'Voir les Demandes',
                    adminUsersTitle: 'Gestion des Utilisateurs',
                    adminUsersDesc: 'G√©rer les employ√©s et les chauffeurs',
                    adminUsersBtn: 'G√©rer les Utilisateurs',
                    manageUsers: 'G√©rer les Utilisateurs',
                    backToDashboard: '‚Üê Retour au Tableau de bord',
                    
                    // Employee Dashboard
                    employeeDashboardTitle: 'Tableau de bord Employ√© Invit√©',
                    employeeDashboardDesc: 'Bienvenue sur le tableau de bord Employ√©. Vous √™tes connect√© en tant qu\'employ√© invit√©.',
                    employeeBookingTitle: 'Nouvelle Demande de R√©servation',
                    employeeBookingDesc: 'Soumettre une nouvelle demande de r√©servation de v√©hicule',
                    employeeBookingBtn: 'Cr√©er une R√©servation',
                    employeeMyBookingsTitle: 'Mes R√©servations',
                    employeeMyBookingsDesc: 'Voir et suivre vos demandes de r√©servation',
                    employeeMyBookingsBtn: 'Voir les R√©servations',
                    newRequest: '+ Nouvelle Demande',
                    
                    // Driver Dashboard
                    driverDashboardTitle: 'Interface Chauffeur Invit√©',
                    guestDriverInterface: 'Interface Chauffeur Invit√©',
                    driverDashboardDesc: 'Bienvenue sur l\'interface Chauffeur. Vous √™tes connect√© en tant que chauffeur invit√©.',
                    guestDriverDesc: 'Bienvenue sur l\'interface Chauffeur. Vous √™tes connect√© en tant que chauffeur invit√©.',
                    driverTripsTitle: 'Trajets Assign√©s',
                    assignedTrips: 'Trajets Assign√©s',
                    driverTripsDesc: 'Voir vos trajets et itin√©raires assign√©s',
                    driverTripsBtn: 'Voir les Trajets',
                    viewTrips: 'Voir les Trajets',
                    driverStatusTitle: 'Mettre √† jour le Statut',
                    updateStatus: 'Mettre √† jour le Statut',
                    driverStatusDesc: 'Mettre √† jour le statut et la localisation du trajet',
                    driverStatusBtn: 'Mettre √† jour le Statut',
                    myActiveTrip: 'Mon Trajet Actif',
                    dashboard: 'Tableau de bord',
                    
                    // Booking Form
                    tripPurpose: 'Objectif du Trajet',
                    tripPurposePlaceholder: 'p. ex., Excursion au mus√©e, Affaires scolaires, Transfert a√©roport',
                    tripPurposeError: 'L\'objectif du trajet est requis',
                    vehicleType: 'Type de V√©hicule',
                    vehicleTypeSelect: 'S√©lectionner un type de v√©hicule',
                    vehicleTypeBus: 'Bus / Minibus (50 places)',
                    vehicleTypeVan: 'Fourgonnette (15 places)',
                    vehicleTypeCar: 'Berline / Voiture (5 places)',
                    vehicleTypeError: 'Veuillez s√©lectionner un type de v√©hicule',
                    startDate: 'Date de D√©but',
                    dateError: 'La date est requise',
                    duration: 'Dur√©e',
                    durationSelect: 'S√©lectionner la dur√©e',
                    durationHours: 'Heures',
                    durationDays: 'Jours',
                    durationHour: 'heure',
                    durationHoursPlural: 'heures',
                    durationDay: 'jour',
                    durationDaysPlural: 'jours',
                    durationWeek: 'semaine',
                    duration1Hour: '1 heure',
                    duration2Hours: '2 heures',
                    duration3Hours: '3 heures',
                    duration4Hours: '4 heures',
                    duration5Hours: '5 heures',
                    duration6Hours: '6 heures',
                    duration8Hours: '8 heures',
                    duration10Hours: '10 heures',
                    duration12Hours: '12 heures',
                    duration1Day: '1 jour',
                    duration2Days: '2 jours',
                    duration3Days: '3 jours',
                    duration4Days: '4 jours',
                    duration5Days: '5 jours',
                    duration6Days: '6 jours',
                    duration7Days1Week: '7 jours (1 semaine)',
                    durationError: 'La dur√©e est requise',
                    pickupTime: 'Heure de Prise en Charge',
                    pickupTimeSelect: 'S√©lectionner l\'heure de prise en charge',
                    pickupTimeAM: 'AM',
                    pickupTimePM: 'PM',
                    pickupTimeError: 'L\'heure de prise en charge est requise',
                    driverOption: 'Option de Chauffeur',
                    driverOptionSchool: 'Demander un Chauffeur de l\'√âcole',
                    driverOptionSelf: 'Conduite Personnelle / Chauffeur Autoris√©',
                    driverOptionError: 'Veuillez s√©lectionner une option de chauffeur',
                    schoolDriverRequirements: 'Exigences du Chauffeur de l\'√âcole',
                    pickupLocation: 'Lieu de Prise en Charge',
                    pickupLocationPlaceholder: 'p. ex., Porte Principale de l\'√âcole, Entr√©e B√¢timent A',
                    pickupLocationError: 'Le lieu de prise en charge est requis',
                    authorizedMessage: '‚úÖ Vous √™tes autoris√©',
                    authorizedDesc: 'L\'option Conduite Personnelle / Chauffeur Autoris√© est disponible pour ce type de v√©hicule.',
                    notAuthorizedMessage: '‚ùå Non autoris√© pour cette classe de v√©hicule',
                    notAuthorizedDesc: 'Veuillez s√©lectionner \'Demander un Chauffeur de l\'√âcole\' √† la place.',
                    authorizationPending: '‚è≥ Autorisation de Conduite Personnelle en Attente',
                    authorizationPendingDesc: 'Votre statut d\'autorisation sera v√©rifi√© par les RH. Cette option n\'est pas automatiquement approuv√©e.',
                    numberOfPassengers: 'Nombre de Passagers',
                    passengersPlaceholder: 'p. ex., 45',
                    passengersError: 'Veuillez entrer un nombre valide de passagers',
                    additionalNotes: 'Notes Suppl√©mentaires',
                    notesPlaceholder: 'Toute exigence sp√©ciale ou information suppl√©mentaire...',
                    submitRequest: 'Soumettre la Demande',
                    cancel: 'Annuler',
                    bookingSummary: 'R√©sum√© de la R√©servation',
                    license: 'Permis:',
                    viewTripPolicy: 'Voir la Politique de Voyage',
                    
                    // Status Labels
                    pending: 'En Attente',
                    approved: 'Approuv√©',
                    denied: 'Refus√©',
                    active: 'Actif',
                    activeTrip: 'Trajet Actif',
                    completed: 'Termin√©',
                    cancelled: 'Annul√©',
                    scheduled: 'Programm√©',
                    
                    // Example Content
                    museumFieldTrip: 'Excursion au Mus√©e',
                    sportsEvent: '√âv√©nement Sportif',
                    weekendWorkshop: 'Atelier de Week-end',
                    scienceMuseum: 'Visite du Mus√©e des Sciences',
                    shortNotice: '‚ö†Ô∏è Pr√©avis Court',
                    scienceDepartment: 'D√©partement des Sciences',
                    athleticsDepartment: 'D√©partement des Sports',
                    educationDepartment: 'D√©partement de l\'√âducation',
                    noBusesAvailableWeekend: 'Aucun bus disponible pour les voyages de week-end. Veuillez envisager des dates alternatives ou utiliser un v√©hicule plus petit.',
                    students: '√©tudiants',
                    mainSchoolGate: 'Porte Principale de l\'√âcole',
                    routeIsdMuseumIsd: 'ISD ‚Üí Mus√©e ‚Üí ISD',
                    bus: 'Bus',
                    
                    // Booking Actions
                    viewDetails: 'Voir les D√©tails',
                    modifyRequest: 'Modifier la Demande',
                    cancelRequest: 'Annuler la Demande',
                    approve: 'Approuver',
                    deny: 'Refuser',
                    quickDeny: 'Refus Rapide (Disponibilit√©)',
                    
                    // Stats
                    statsPending: 'En Attente',
                    statsApproved: 'Approuv√©',
                    statsActive: 'Actif',
                    statsDenied: 'Refus√©',
                    statsCompleted: 'Termin√©',
                    
                    // Fleet Management
                    fleetManagement: 'Gestion de la Flotte',
                    fleetManagementDesc: 'Voir et g√©rer votre flotte de v√©hicules',
                    vehicleFleet: 'Flotte de V√©hicules',
                    addVehicle: '+ Ajouter un V√©hicule',
                    addNewVehicle: 'Ajouter un Nouveau V√©hicule',
                    editVehicle: 'Modifier le V√©hicule',
                    deleteVehicle: 'Supprimer le V√©hicule',
                    vehicleId: 'ID du V√©hicule',
                    vehicleIdPlaceholder: 'p. ex., VH-001',
                    vehicleImage: 'Image du V√©hicule',
                    vehicleTypeSelect: 'S√©lectionner le type de v√©hicule',
                    vehicleTypeMinibus: 'Minibus',
                    vehicleTypePassengerVan: 'Fourgonnette',
                    vehicleTypeSedan: 'Berline',
                    vehicleTypeSchoolBus: 'Bus Scolaire',
                    vehicleTypeSUV: 'SUV',
                    capacity: 'Capacit√©',
                    capacityPlaceholder: 'p. ex., 50 places',
                    status: 'Statut',
                    statusAvailable: 'Disponible',
                    statusInMaintenance: 'En Maintenance',
                    statusInUse: 'En Utilisation',
                    location: 'Emplacement',
                    locationPlaceholder: 'p. ex., Garage 1',
                    saveChanges: 'Enregistrer les Modifications',
                    edit: 'Modifier',
                    delete: 'Supprimer',
                    vehicleIdDisplay: 'ID du V√©hicule',
                    image: 'Image',
                    vehicleIdCol: 'ID du V√©hicule',
                    type: 'Type',
                    capacityCol: 'Capacit√©',
                    statusCol: 'Statut',
                    actions: 'Actions',
                    schoolBus: 'Bus Scolaire',
                    schoolBusDesc: '50 places ‚Ä¢ Parfait pour les excursions et les grands groupes',
                    suv: 'SUV',
                    suvDesc: '7 places ‚Ä¢ Confortable pour les petits groupes',
                    sedan: 'Berline',
                    sedanDesc: '5 places ‚Ä¢ Id√©al pour les d√©placements du personnel',
                    available: 'Disponible',
                    
                    // Driver Trip Status
                    tripStatusUpdates: 'Mises √† jour du Statut du Trajet',
                    startTrip: 'üöó D√©marrer le Trajet',
                    arrivedAtPickup: 'üìç Arriv√© au Point de Prise en Charge',
                    startDriving: 'üöô Commencer √† Conduire',
                    arrivedDestination: 'üèÅ Arriv√© √† Destination',
                    tripComplete: '‚úÖ Trajet Termin√©',
                    runningLate: '‚è±Ô∏è En Retard de 10 Minutes',
                    delayNotificationSent: '‚è±Ô∏è Notification Envoy√©e!',
                    delayNotificationDesc: 'Appuyer pour notifier instantan√©ment l\'employ√© et l\'administrateur',
                    
                    // Safety Checks
                    safetyCheck: 'V√©rification de S√©curit√© du V√©hicule',
                    safetyCheckConfirmed: 'Toutes les V√©rifications de S√©curit√© Confirm√©es',
                    checkTires: 'Pneus',
                    checkLights: 'Phares',
                    checkBrakes: 'Freins',
                    checkFuel: 'Carburant',
                    checkMirrors: 'R√©troviseurs',
                    checkFirstAid: 'Trousse de Premiers Secours',
                    
                    // Trip Finalization
                    tripFinalization: 'Finalisation du Trajet',
                    finalOdometer: 'Lecture Finale du Compteur Kilom√©trique',
                    finalOdometerPlaceholder: 'p. ex., 12500',
                    finalOdometerError: 'Veuillez entrer une lecture valide du compteur kilom√©trique',
                    finalFuelLevel: 'Niveau Final de Carburant',
                    finalFuelLevelFull: 'Plein',
                    finalFuelLevelThreeQuarter: '3/4',
                    finalFuelLevelHalf: '1/2',
                    finalFuelLevelQuarter: '1/4',
                    finalFuelLevelEmpty: 'Vide',
                    finalFuelLevelError: 'Veuillez s√©lectionner le niveau de carburant',
                    vehicleIssues: 'Probl√®mes/Commentaires sur le V√©hicule',
                    vehicleIssuesPlaceholder: 'Tout probl√®me ou commentaire sur le v√©hicule...',
                    vehicleIssuesError: 'Veuillez fournir des probl√®mes ou commentaires sur le v√©hicule',
                    submitLogComplete: 'Soumettre le Journal et Terminer',
                    
                    // Update Status Form
                    updateStatus: 'Mettre √† jour le Statut du Trajet',
                    selectTrip: 'S√©lectionner le Trajet',
                    selectTripPlaceholder: 'Choisir un trajet',
                    currentStatus: 'Statut Actuel',
                    currentStatusPlaceholder: 'S√©lectionner le statut',
                    currentLocation: 'Localisation Actuelle',
                    currentLocationPlaceholder: 'Entrer la localisation actuelle',
                    statusNotes: 'Notes sur le Statut',
                    statusNotesPlaceholder: 'Toute note suppl√©mentaire...',
                    
                    // Messages
                    submittedAgo: 'Soumis il y a {hours} heures',
                    waitingForAdmin: 'En attente de l\'action de l\'administrateur',
                    adminNote: 'Note de l\'Administrateur:',
                    driverStatus: 'Statut du Chauffeur:',
                    tripFinalizationLog: 'Journal de Finalisation du Trajet:',
                    finalOdometerLabel: 'Compteur Kilom√©trique Final:',
                    finalFuelLevelLabel: 'Niveau Final de Carburant:',
                    vehicleIssuesLabel: 'Probl√®mes/Commentaires sur le V√©hicule:',
                    vehicleIssuesComments: 'Probl√®mes/Commentaires sur le V√©hicule',
                    miles: 'miles',
                    noneReported: 'Aucun signal√©',
                    
                    // Additional Employee Dashboard Labels
                    driverLabel: 'Chauffeur',
                    schoolDriver: 'Chauffeur Scolaire',
                    isCurrently: 'est actuellement',
                    viewFullDriverStatus: 'Voir le Statut Complet du Chauffeur',
                    adminNoteRequiredJustification: 'Note de l\'Administrateur (Justification Requise)',
                    waitingForAdminAction: 'En Attente de l\'Action de l\'Administrateur',
                    waiting: 'En Attente',
                    day: 'jour',
                    days: 'jours',
                    hour: 'heure',
                    hours: 'heures',
                    minute: 'minute',
                    minutes: 'minutes',
                    waitingLessThan1Hour: 'En attente depuis moins d\'une heure',
                    
                    // Fleet Section
                    ourFleet: 'Notre Flotte',
                    fleetDesc: 'Une gamme diversifi√©e de v√©hicules pour r√©pondre √† tous vos besoins de transport',
                    
                    // Platform Features
                    platformFeatures: 'Fonctionnalit√©s de la Plateforme',
                    easyBooking: 'R√©servation Facile',
                    easyBookingDesc: 'R√©servez des v√©hicules en quelques clics',
                    quickApprovals: 'Approbations Rapides',
                    quickApprovalsDesc: 'Processus d\'approbation rationalis√©',
                    realTimeTracking: 'Suivi en Temps R√©el',
                    realTimeTrackingDesc: 'Surveillez le statut du trajet en temps r√©el',
                    
                    // Booking Approvals Queue
                    bookingApprovalsQueue: 'File d\'Attente des Approbations de R√©servation',
                    sort: 'Trier:',
                    filter: 'Filtrer:',
                    mostUrgentFirst: 'Plus Urgent en Premier',
                    dateNewestFirst: 'Date (Plus R√©cent en Premier)',
                    requesterName: 'Nom du Demandeur',
                    allRequests: 'Toutes les Demandes',
                    urgent48h: 'Urgent (48h)',
                    policyViolations: 'Violations de Politique',
                    exceedsMaxDuration: 'D√©passe la Dur√©e Maximale',
                    pendingRequests: 'demandes en attente',
                    
                    // Booking Details View
                    requestDetails: 'D√©tails de la Demande',
                    requesterProfile: 'Profil du Demandeur',
                    nameDepartment: 'Nom et D√©partement',
                    contact: 'Contact',
                    totalBookings: 'Total des R√©servations',
                    bookingStatisticsLast90Days: 'Statistiques de R√©servation (90 Derniers Jours)',
                    requestedTimeSlot: 'Cr√©neau Horaire Demand√©',
                    availabilityConflictsTimeline: 'Disponibilit√© et Chronologie des Conflits',
                    conflict: 'Conflit',
                    conflictingBookingsDetected: 'R√©servations en Conflit D√©tect√©es',
                    noConflictsDetected: 'Aucun conflit d√©tect√© - Cr√©neau disponible',
                    canceled: 'Annul√©',
                    cancellationRate: 'Taux d\'Annulation',
                    canceledOutOf: 'annul√© sur',
                    bookings: 'r√©servations',
                    denyRequest: 'Refuser la Demande',
                    approveRequest: 'Approuver la Demande',
                    policyViolationFlags: 'Drapeaux de Violation de Politique',
                    dateTimeLabel: 'Date et Heure',
                    at: '√†'
                }
            },

            // Helper function to translate an element by key
            translateElement(element, key, data) {
                if (!element || !data[key]) return;
                
                // For input elements, update placeholder
                if (element.tagName === 'INPUT' && element.type !== 'submit' && element.type !== 'button') {
                    // Check for data-placeholder-key attribute first
                    const placeholderKey = element.getAttribute('data-placeholder-key');
                    if (placeholderKey && data[placeholderKey]) {
                        element.placeholder = data[placeholderKey];
                    } else if (element.placeholder && data[key]) {
                        element.placeholder = data[key];
                    }
                }
                // For textarea elements, update placeholder
                else if (element.tagName === 'TEXTAREA') {
                    // Check for data-placeholder-key attribute first
                    const placeholderKey = element.getAttribute('data-placeholder-key');
                    if (placeholderKey && data[placeholderKey]) {
                        element.placeholder = data[placeholderKey];
                    } else if (element.placeholder && data[key]) {
                        element.placeholder = data[key];
                    }
                }
                // For select elements, update option text
                else if (element.tagName === 'SELECT') {
                    // Update placeholder option
                    const placeholderOption = element.querySelector('option[value=""]');
                    if (placeholderOption && data[key]) {
                        placeholderOption.textContent = data[key];
                    }
                }
                // For label elements, update text
                else if (element.tagName === 'LABEL') {
                    // Preserve required asterisk if present
                    const requiredSpan = element.querySelector('span.text-red-600');
                    if (requiredSpan) {
                        element.innerHTML = data[key] + ' <span class="text-red-600">*</span>';
                    } else {
                        element.textContent = data[key];
                    }
                }
                // For other elements, update textContent or innerHTML
                else {
                    element.textContent = data[key];
                }
            },

            // Function to update text based on language
            setLanguage(lang) {
                try {
                    const data = this.content[lang];
                    
                    // Helper to translate by element ID
                    const translate = (id, key) => {
                        const el = document.getElementById(id);
                        if (el && data[key]) {
                            this.translateElement(el, key, data);
                        }
                    };
                    
                    // Helper to translate by selector
                    const translateSelector = (selector, key) => {
                        const el = document.querySelector(selector);
                        if (el && data[key]) {
                            this.translateElement(el, key, data);
                        }
                    };
                    
                    // Helper to translate all elements with data-translate attribute
                    const translateAll = () => {
                        document.querySelectorAll('[data-translate]').forEach(el => {
                            const key = el.getAttribute('data-translate');
                            if (data[key]) {
                                this.translateElement(el, key, data);
                            }
                        });
                    };
                    
                    // Home page content
                    translate('msg-title', 'title');
                    translate('msg-text', 'text');
                    translate('btn-admin', 'admin');
                    translate('btn-employee', 'employee');
                    translate('btn-driver', 'driver');
                    translate('home-link', 'home');
                    
                    // Header title
                    translate('header-title-link', 'appName');
                    
                    // Guest Mode badges
                    translate('guest-mode-badge', 'guestMode');
                    translate('guest-mode-badge-employee', 'guestMode');
                    translate('guest-mode-badge-driver', 'guestMode');
                    
                    // Admin Dashboard
                    translate('dashboard-admin-title', 'adminDashboardTitle');
                    translate('dashboard-admin-desc', 'adminDashboardDesc');
                    translate('admin-fleet-title', 'adminFleetTitle');
                    translate('admin-fleet-desc', 'adminFleetDesc');
                    translate('admin-fleet-btn', 'adminFleetBtn');
                    translate('admin-approvals-title', 'adminApprovalsTitle');
                    translate('admin-approvals-desc', 'adminApprovalsDesc');
                    translate('admin-approvals-btn', 'adminApprovalsBtn');
                    translate('admin-users-title', 'adminUsersTitle');
                    translate('admin-users-desc', 'adminUsersDesc');
                    translate('admin-users-btn', 'adminUsersBtn');

                // Employee Dashboard
                    translate('dashboard-employee-title', 'employeeDashboardTitle');
                    translate('dashboard-employee-desc', 'employeeDashboardDesc');
                    translate('employee-booking-title', 'employeeBookingTitle');
                    translate('employee-booking-desc', 'employeeBookingDesc');
                    translate('employee-booking-btn', 'employeeBookingBtn');
                    translate('employee-mybookings-title', 'employeeMyBookingsTitle');
                    translate('employee-mybookings-desc', 'employeeMyBookingsDesc');
                    translate('employee-mybookings-btn', 'employeeMyBookingsBtn');
                    translate('employee-booking-btn', 'newRequest');
                    
                    // Driver Dashboard
                    translate('dashboard-driver-title', 'driverDashboardTitle');
                    translate('dashboard-driver-desc', 'driverDashboardDesc');
                    translate('driver-trips-title', 'driverTripsTitle');
                    translate('driver-trips-desc', 'driverTripsDesc');
                    translate('driver-trips-btn', 'driverTripsBtn');
                    translate('driver-status-title', 'driverStatusTitle');
                    translate('driver-status-desc', 'driverStatusDesc');
                    translate('driver-status-btn', 'driverStatusBtn');
                    
                    // Booking Form
                    translateSelector('label[for="trip-purpose"]', 'tripPurpose');
                    translate('trip-purpose', 'tripPurposePlaceholder');
                    translate('trip-purpose-error', 'tripPurposeError');
                    translateSelector('label[for="vehicle-type"]', 'vehicleType');
                    translate('vehicle-type', 'vehicleTypeSelect');
                    translateSelector('label[for="trip-date"]', 'startDate');
                    translate('trip-date-error', 'dateError');
                    translateSelector('label[for="trip-duration"]', 'duration');
                    translate('trip-duration', 'durationSelect');
                    translateSelector('label[for="pickup-time"]', 'pickupTime');
                    translate('pickup-time', 'pickupTimeSelect');
                    translate('pickup-time-error', 'pickupTimeError');
                    translateSelector('label[for="driver-option"]', 'driverOption');
                    translate('driver-option', 'driverOptionSchool');
                    translateSelector('label[for="pickup-location"]', 'pickupLocation');
                    translate('pickup-location', 'pickupLocationPlaceholder');
                    translate('pickup-location-error', 'pickupLocationError');
                    translateSelector('label[for="passengers"]', 'numberOfPassengers');
                    translate('passengers', 'passengersPlaceholder');
                    translate('passengers-error', 'passengersError');
                    translateSelector('label[for="notes"]', 'additionalNotes');
                    translate('notes', 'notesPlaceholder');
                    translate('submit-booking-btn', 'submitRequest');
                    
                    // Stats labels
                    document.querySelectorAll('.stats-label').forEach(el => {
                        const stat = el.textContent.trim();
                        if (stat === 'Pending') el.textContent = data.statsPending;
                        else if (stat === 'Approved') el.textContent = data.statsApproved;
                        else if (stat === 'Active') el.textContent = data.statsActive;
                        else if (stat === 'Denied') el.textContent = data.statsDenied;
                        else if (stat === 'Completed') el.textContent = data.statsCompleted;
                    });
                    
                    // Translate all elements with data-translate attribute
                    translateAll();
                    
                    // Translate placeholders with data-placeholder-key
                    document.querySelectorAll('[data-placeholder-key]').forEach(el => {
                        const placeholderKey = el.getAttribute('data-placeholder-key');
                        if (data[placeholderKey]) {
                            el.placeholder = data[placeholderKey];
                        }
                    });
                    
                    // Translate select options with data-translate
                    document.querySelectorAll('select option[data-translate]').forEach(option => {
                        const key = option.getAttribute('data-translate');
                        if (data[key]) {
                            option.textContent = data[key];
                        }
                    });
                    
                    // Translate optgroup labels with data-translate
                    document.querySelectorAll('optgroup[data-translate]').forEach(optgroup => {
                        const key = optgroup.getAttribute('data-translate');
                        if (data[key]) {
                            optgroup.label = data[key];
                        }
                    });

                // Update active/inactive styles for language links
                const langEn = document.getElementById('lang-en');
                const langFr = document.getElementById('lang-fr');
                if (langEn) {
                    langEn.classList.toggle('text-white', lang === 'fr');
                    langEn.classList.toggle('text-isd-gold', lang === 'en');
                    langEn.classList.toggle('border-b', lang === 'en');
                }
                if (langFr) {
                    langFr.classList.toggle('text-white', lang === 'en');
                    langFr.classList.toggle('text-isd-gold', lang === 'fr');
                    langFr.classList.toggle('border-b', lang === 'fr');
                }
                    
                    // Store current language
                    window.currentLanguage = lang;
                } catch (error) {
                    console.error('Error in setLanguage:', error);
                }
            },

            // Global helper function to get translated text
            t(key) {
                const lang = window.currentLanguage || 'en';
                return this.content[lang]?.[key] || key;
            },

            // Function to handle routing based on hash
            handleRoute() {
                try {
                    const hash = window.location.hash.slice(1) || 'home';
                    const homeLink = document.getElementById('home-link');
                    
                    // Hide all views
                    document.querySelectorAll('.view-section').forEach(view => {
                        view.classList.remove('active');
                    });
                    
                    // Show appropriate view based on hash
                    if (hash === 'home' || hash === '') {
                        const viewHome = document.getElementById('view-home');
                        if (viewHome) viewHome.classList.add('active');
                        if (homeLink) homeLink.classList.add('hidden');
                    } else if (hash.startsWith('guest/')) {
                        const role = hash.split('/')[1];
                        const viewId = `view-guest-${role}`;
                        const viewElement = document.getElementById(viewId);
                        if (viewElement) {
                            viewElement.classList.add('active');
                            if (homeLink) homeLink.classList.remove('hidden');
                            
                            // Set current role in appState
                            setCurrentRole(role);
                            
                            // Start real-time data listeners for the current role
                            if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                                startDataListeners();
                            }
                            
                            // Populate dashboard data when navigating
                            setTimeout(async () => {
                                if (role === 'employee') {
                                    await populateEmployeeDashboard('emp_high');
                                } else if (role === 'admin') {
                                    await populateAdminDashboard();
                                } else if (role === 'driver') {
                                    populateDriverDashboard('driver_kore');
                                }
                            }, 50);
                        } else {
                            // Invalid role, show home
                            const viewHome = document.getElementById('view-home');
                            if (viewHome) viewHome.classList.add('active');
                            if (homeLink) homeLink.classList.add('hidden');
                        }
                    } else if (hash === 'my-bookings') {
                        // My Bookings view - also populate employee dashboard
                        const viewElement = document.getElementById('view-my-bookings');
                        if (viewElement) {
                            viewElement.classList.add('active');
                            if (homeLink) homeLink.classList.remove('hidden');
                            // Ensure role is set to employee for my-bookings view
                            setCurrentRole('employee');
                            
                            // Start real-time data listeners for employee role
                            if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                                startDataListeners();
                            }
                            
                            setTimeout(async () => {
                                await populateEmployeeDashboard('emp_high');
                            }, 50);
                        }
                    } else if (hash === 'fleet-management' || hash === 'booking-approvals' || hash === 'user-management' || 
                               hash === 'new-booking' || hash === 'my-bookings' || hash === 'assigned-trips' || hash === 'update-status' || hash === 'trip-finalization') {
                        // Handle feature views
                        let viewId = `view-${hash}`;
                        if (hash === 'trip-finalization') {
                            viewId = 'view-trip-finalization';
                        }
                        const viewElement = document.getElementById(viewId);
                        if (viewElement) {
                            viewElement.classList.add('active');
                            if (homeLink) homeLink.classList.remove('hidden');
                        } else {
                            // Invalid view, show home
                            const viewHome = document.getElementById('view-home');
                            if (viewHome) viewHome.classList.add('active');
                            if (homeLink) homeLink.classList.add('hidden');
                        }
                    } else {
                        // For other routes (like #login/admin), show home for now
                        const viewHome = document.getElementById('view-home');
                        if (viewHome) viewHome.classList.add('active');
                        if (homeLink) homeLink.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error in handleRoute:', error);
                    // Fallback to home view on error
                    const viewHome = document.getElementById('view-home');
                    if (viewHome) viewHome.classList.add('active');
                }
            },

        };
        
        // Global translation helper function
        window.t = function(key) {
            return app.t(key);
        };

        // MOCK DATA - Users, Vehicles, and Bookings
        const MOCK_USERS = {
            "admin_001": {
                "role": "Admin",
                "name": "Amelia Grant"
            },
            "emp_high": {
                "role": "Employee",
                "name": "Sarah Chen",
                "isAuthorizedDriver": true,
                "totalTrips90Days": 20,
                "cancelledTripsLifetime": 1
            },
            "emp_low": {
                "role": "Employee",
                "name": "Ben Harris",
                "isAuthorizedDriver": false,
                "totalTrips90Days": 10,
                "cancelledTripsLifetime": 5
            },
            "driver_kore": {
                "role": "Driver",
                "name": "Jake Olsen"
            },
            "driver_puck": {
                "role": "Driver",
                "name": "Maria Lee"
            }
        };
        
        const MOCK_VEHICLES = {
            "vh_m_001": {
                "type": "Minibus",
                "name": "Minibus Alpha",
                "status": "Available",
                "location": "Garage 1",
                "maintenanceDue": "2026-03-01"
            },
            "vh_v_002": {
                "type": "Passenger Van",
                "name": "Van Bravo",
                "status": "Available",
                "location": "Garage 2",
                "maintenanceDue": "2025-11-05"
            },
            "vh_s_003": {
                "type": "Sedan",
                "name": "Sedan Charlie",
                "status": "In Maintenance",
                "location": "Workshop",
                "maintenanceDue": "2025-11-15"
            }
        };
        
        // Current simulated date: 2025-11-05
        const CURRENT_DATE = new Date('2025-11-05');
        
        // ============================================
        // UTILITY FUNCTIONS - Security, Error Handling, Cleanup
        // ============================================
        
        /**
         * Sanitize HTML to prevent XSS attacks
         * @param {string} str - String to sanitize
         * @returns {string} - Sanitized string
         */
        function sanitizeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        /**
         * Safely set innerHTML with sanitization
         * @param {HTMLElement} element - Element to update
         * @param {string} html - HTML content (will be sanitized if contains user data)
         * @param {boolean} isTrusted - If true, skip sanitization (only for static templates)
         */
        function safeSetHTML(element, html, isTrusted = false) {
            if (!element) return;
            try {
                if (isTrusted) {
                    element.innerHTML = html;
                } else {
                    // For user-generated content, use textContent or sanitize
                    const temp = document.createElement('div');
                    temp.textContent = html;
                    element.innerHTML = temp.innerHTML;
                }
            } catch (error) {
                console.error('Error setting HTML:', error);
                element.textContent = html;
            }
        }
        
        /**
         * Safe DOM text content setter
         * @param {HTMLElement} element - Element to update
         * @param {string} text - Text content
         */
        function safeSetText(element, text) {
            if (!element) return;
            try {
                element.textContent = text || '';
            } catch (error) {
                console.error('Error setting text:', error);
            }
        }
        
        /**
         * Error handler wrapper for async functions
         * @param {Function} fn - Async function to wrap
         * @param {string} context - Context description for error messages
         * @returns {Function} - Wrapped function
         */
        function withErrorHandling(fn, context = 'Operation') {
            return async function(...args) {
                try {
                    return await fn.apply(this, args);
                } catch (error) {
                    console.error(`‚ùå ${context} failed:`, error);
                    // Show user-friendly error message
                    showError(`An error occurred: ${context}. Please try again.`);
                    throw error;
                }
            };
        }
        
        /**
         * Show user-friendly error message
         * @param {string} message - Error message
         * @param {number} duration - Duration in milliseconds
         */
        function showError(message, duration = 5000) {
            try {
                // Remove existing error message
                const existing = document.getElementById('error-message');
                if (existing) existing.remove();
                
                const errorDiv = document.createElement('div');
                errorDiv.id = 'error-message';
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
                errorDiv.setAttribute('role', 'alert');
                errorDiv.setAttribute('aria-live', 'assertive');
                errorDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="flex-1">
                            <p class="font-semibold">Error</p>
                            <p class="text-sm mt-1">${sanitizeHTML(message)}</p>
                        </div>
                        <button onclick="this.closest('#error-message').remove()" class="text-white hover:text-gray-200 ml-2" aria-label="Close error message">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                `;
                document.body.appendChild(errorDiv);
                
                // Auto-remove after duration
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, duration);
            } catch (error) {
                console.error('Error showing error message:', error);
                alert(message); // Fallback to alert
            }
        }
        
        /**
         * Show success message
         * @param {string} message - Success message
         * @param {number} duration - Duration in milliseconds
         */
        function showSuccess(message, duration = 3000) {
            try {
                const existing = document.getElementById('success-message');
                if (existing) existing.remove();
                
                const successDiv = document.createElement('div');
                successDiv.id = 'success-message';
                successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
                successDiv.setAttribute('role', 'status');
                successDiv.setAttribute('aria-live', 'polite');
                successDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <p>${sanitizeHTML(message)}</p>
                        <button onclick="this.closest('#success-message').remove()" class="text-white hover:text-gray-200 ml-2" aria-label="Close success message">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                `;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, duration);
            } catch (error) {
                console.error('Error showing success message:', error);
            }
        }
        
        /**
         * Event listener cleanup tracker
         */
        const eventListeners = new Map();
        
        /**
         * Safely add event listener with cleanup tracking
         * @param {HTMLElement} element - Element to attach listener to
         * @param {string} event - Event type
         * @param {Function} handler - Event handler
         * @param {string} key - Unique key for cleanup
         */
        function safeAddEventListener(element, event, handler, key) {
            if (!element || !key) return;
            try {
                element.addEventListener(event, handler);
                if (!eventListeners.has(key)) {
                    eventListeners.set(key, []);
                }
                eventListeners.get(key).push({ element, event, handler });
            } catch (error) {
                console.error('Error adding event listener:', error);
            }
        }
        
        /**
         * Clean up all event listeners for a given key
         * @param {string} key - Key to clean up
         */
        function cleanupEventListeners(key) {
            const listeners = eventListeners.get(key);
            if (!listeners) return;
            
            listeners.forEach(({ element, event, handler }) => {
                try {
                    element.removeEventListener(event, handler);
                } catch (error) {
                    console.error('Error removing event listener:', error);
                }
            });
            
            eventListeners.delete(key);
        }
        
        /**
         * Clean up all event listeners
         */
        function cleanupAllEventListeners() {
            eventListeners.forEach((listeners, key) => {
                cleanupEventListeners(key);
            });
        }
        
        /**
         * Validate input to prevent injection attacks
         * @param {string} input - Input to validate
         * @param {string} type - Type of validation ('text', 'email', 'number', 'date')
         * @returns {boolean} - True if valid
         */
        function validateInput(input, type = 'text') {
            if (typeof input !== 'string') return false;
            
            switch (type) {
                case 'email':
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input);
                case 'number':
                    return /^\d+$/.test(input);
                case 'date':
                    return /^\d{4}-\d{2}-\d{2}$/.test(input);
                case 'text':
                    return input.length > 0 && input.length < 1000;
                default:
                    return true;
            }
        }
        
        // ============================================
        // APPLICATION STATE
        // ============================================
        const appState = {
            currentRole: null, // 'employee', 'admin', 'driver', or null
            currentUserId: null, // Current authenticated user ID
            isAuthenticated: false
        };
        
        // Helper function to set current role
        function setCurrentRole(role) {
            appState.currentRole = role;
        }
        
        // Helper function to get current role
        function getCurrentRole() {
            return appState.currentRole;
        }
        
        // ============================================
        // FIREBASE HELPER FUNCTIONS
        // ============================================
        
        // Check if Firebase is configured and available
        function isFirebaseConfigured() {
            return window.firebaseDb && 
                   window.firebaseConfig && 
                   window.firebaseConfig.apiKey !== "YOUR_API_KEY";
        }
        
        // Get current authenticated user
        async function getCurrentUser() {
            if (!window.firebaseAuth) return null;
            return window.firebaseAuth.currentUser;
        }
        
        // Get user's role from custom claims
        async function getUserRole() {
            const user = await getCurrentUser();
            if (!user) return null;
            // Custom claims are set by Firebase Admin SDK
            // For now, we'll check the user document
            const userDoc = await window.firebaseFunctions.getDoc(
                window.firebaseFunctions.doc(window.firebaseDb, 'users', user.uid)
            );
            if (userDoc.exists()) {
                return userDoc.data().role;
            }
            return null;
        }
        
        // Firestore: Create booking (Employee can create their own requests)
        async function createBooking(bookingData) {
            // Ensure numeric fields are properly typed as numbers (not strings) before saving to Firebase
            if (bookingData.durationHours !== undefined) {
                bookingData.durationHours = Number(bookingData.durationHours);
                if (isNaN(bookingData.durationHours) || bookingData.durationHours <= 0) {
                    throw new Error('Invalid durationHours: must be a positive number');
                }
            }
            
            if (bookingData.passengers !== undefined) {
                bookingData.passengers = Number(bookingData.passengers);
                if (isNaN(bookingData.passengers) || bookingData.passengers <= 0) {
                    throw new Error('Invalid passengers: must be a positive number');
                }
            }
            
            if (!isFirebaseConfigured()) {
                // Fallback to mock data
                // Ensure requesterId is set for guest mode
                if (!bookingData.requesterId) {
                    bookingData.requesterId = 'emp_high'; // Default to emp_high in guest mode
                }
                
                // Ensure status is set
                if (!bookingData.status) {
                    bookingData.status = 'PENDING';
                }
                
                const bookingId = `B-${String(Object.keys(MOCK_BOOKINGS).length + 1).padStart(3, '0')}`;
                MOCK_BOOKINGS[bookingId] = {
                    ...bookingData,
                    id: bookingId,
                    requesterId: bookingData.requesterId, // Ensure requesterId is set
                    status: bookingData.status || 'PENDING', // Ensure status is set
                    submittedTime: new Date().toISOString()
                };
                
                console.log('‚úÖ Booking added to MOCK_BOOKINGS:', bookingId, MOCK_BOOKINGS[bookingId]);
                console.log('üìä Total bookings in MOCK_BOOKINGS:', Object.keys(MOCK_BOOKINGS).length);
                
                // Save to localStorage
                saveMockBookings();
                
                return bookingId;
            }
            
            const user = await getCurrentUser();
            if (!user) throw new Error('User not authenticated');
            
            // Ensure requesterId matches authenticated user
            bookingData.requesterId = user.uid;
            bookingData.status = 'PENDING';
            bookingData.submittedTime = new Date().toISOString();
            
            const bookingsRef = window.firebaseFunctions.collection(window.firebaseDb, 'all_requests');
            
            try {
                const docRef = await window.firebaseFunctions.addDoc(bookingsRef, bookingData);
                console.log('‚úÖ Booking successfully saved to Firebase:', docRef.id);
                return docRef.id;
            } catch (error) {
                // Enhanced error logging for Firebase operations
                console.error('‚ùå Firebase Error Details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack,
                    bookingData: bookingData
                });
                
                // Log specific error types
                if (error.code === 'permission-denied') {
                    console.error('üîí PERMISSION DENIED: Check Firebase Security Rules for all_requests collection');
                    console.error('   Expected: Employee can create with requesterId == auth.uid');
                    console.error('   Current user UID:', user.uid);
                    console.error('   Booking requesterId:', bookingData.requesterId);
                } else if (error.code === 'unauthenticated') {
                    console.error('üîê UNAUTHENTICATED: User is not logged in');
                } else if (error.code === 'invalid-argument') {
                    console.error('‚ö†Ô∏è INVALID ARGUMENT: Check data types (durationHours should be number)');
                    console.error('   durationHours type:', typeof bookingData.durationHours);
                    console.error('   passengers type:', typeof bookingData.passengers);
                }
                
                throw error; // Re-throw to be caught by calling function
            }
        }
        
        // Firestore: Get bookings by requester (Employee can read their own)
        async function getBookingsByRequesterFirestore(userId) {
            try {
                if (!isFirebaseConfigured()) {
                    return getBookingsByRequester(userId);
                }
                
                const user = await getCurrentUser();
                if (!user) return [];
                
                const bookingsRef = window.firebaseFunctions.collection(window.firebaseDb, 'all_requests');
                const q = window.firebaseFunctions.query(
                    bookingsRef,
                    window.firebaseFunctions.where('requesterId', '==', user.uid),
                    window.firebaseFunctions.orderBy('startTime', 'desc')
                );
                
                const querySnapshot = await window.firebaseFunctions.getDocs(q);
                const bookings = [];
                querySnapshot.forEach((doc) => {
                    bookings.push({ id: doc.id, ...doc.data() });
                });
                return bookings;
            } catch (error) {
                console.error('‚ùå Error in getBookingsByRequesterFirestore:', error);
                // Fallback to mock data on error
                return getBookingsByRequester(userId);
            }
        }
        
        // Firestore: Get bookings by status (Admin can read all)
        async function getBookingsByStatusFirestore(status) {
            try {
                if (!isFirebaseConfigured()) {
                    return getBookingsByStatus(status);
                }
                
                const user = await getCurrentUser();
                if (!user) return [];
                
                const bookingsRef = window.firebaseFunctions.collection(window.firebaseDb, 'all_requests');
                const q = window.firebaseFunctions.query(
                    bookingsRef,
                    window.firebaseFunctions.where('status', '==', status),
                    window.firebaseFunctions.orderBy('startTime', 'asc')
                );
                
                const querySnapshot = await window.firebaseFunctions.getDocs(q);
                const bookings = [];
                querySnapshot.forEach((doc) => {
                    bookings.push({ id: doc.id, ...doc.data() });
                });
                return bookings;
            } catch (error) {
                console.error('‚ùå Error in getBookingsByStatusFirestore:', error);
                // Fallback to mock data on error
                return getBookingsByStatus(status);
            }
        }
        
        // Firestore: Update booking (Employee can update their own PENDING, Admin can update any)
        async function updateBookingFirestore(bookingId, updates) {
            try {
                if (!isFirebaseConfigured()) {
                    if (MOCK_BOOKINGS[bookingId]) {
                        MOCK_BOOKINGS[bookingId] = { ...MOCK_BOOKINGS[bookingId], ...updates };
                        // Save to localStorage
                        saveMockBookings();
                    }
                    return;
                }
                
                const user = await getCurrentUser();
                if (!user) throw new Error('User not authenticated');
                
                const bookingRef = window.firebaseFunctions.doc(window.firebaseDb, 'all_requests', bookingId);
                await window.firebaseFunctions.updateDoc(bookingRef, updates);
            } catch (error) {
                console.error('‚ùå Error in updateBookingFirestore:', error);
                showError('Failed to update booking. Please try again.');
                throw error;
            }
        }
        
        // Firestore: Delete booking (Employee can delete their own PENDING/APPROVED)
        async function deleteBookingFirestore(bookingId) {
            try {
                if (!isFirebaseConfigured()) {
                    if (MOCK_BOOKINGS[bookingId]) {
                        delete MOCK_BOOKINGS[bookingId];
                        // Save to localStorage
                        saveMockBookings();
                    }
                    return;
                }
                
                const user = await getCurrentUser();
                if (!user) throw new Error('User not authenticated');
                
                const bookingRef = window.firebaseFunctions.doc(window.firebaseDb, 'all_requests', bookingId);
                await window.firebaseFunctions.deleteDoc(bookingRef);
            } catch (error) {
                console.error('‚ùå Error in deleteBookingFirestore:', error);
                showError('Failed to delete booking. Please try again.');
                throw error;
            }
        }
        
        // Firestore: Get single booking by ID
        async function getBookingByIdFirestore(bookingId) {
            try {
                if (!isFirebaseConfigured()) {
                    return getBookingById(bookingId);
                }
                
                const bookingRef = window.firebaseFunctions.doc(window.firebaseDb, 'all_requests', bookingId);
                const bookingDoc = await window.firebaseFunctions.getDoc(bookingRef);
                
                if (bookingDoc.exists()) {
                    return { id: bookingDoc.id, ...bookingDoc.data() };
                }
                return null;
            } catch (error) {
                console.error('‚ùå Error in getBookingByIdFirestore:', error);
                // Fallback to mock data on error
                return getBookingById(bookingId);
            }
        }
        
        // Set up real-time listener for bookings (optional)
        function setupBookingsListener(callback) {
            if (!isFirebaseConfigured()) return;
            
            const user = window.firebaseAuth.currentUser;
            if (!user) return;
            
            const bookingsRef = window.firebaseFunctions.collection(window.firebaseDb, 'all_requests');
            const q = window.firebaseFunctions.query(
                bookingsRef,
                window.firebaseFunctions.where('requesterId', '==', user.uid)
            );
            
            return window.firebaseFunctions.onSnapshot(q, (snapshot) => {
                const bookings = [];
                snapshot.forEach((doc) => {
                    bookings.push({ id: doc.id, ...doc.data() });
                });
                callback(bookings);
            });
        }
        
        // Start data listeners for real-time updates (role-specific scoping)
        function startDataListeners() {
            if (!isFirebaseConfigured()) return null;
            
            const user = window.firebaseAuth.currentUser;
            if (!user) {
                console.warn('startDataListeners: No authenticated user');
                return null;
            }
            
            const currentRole = getCurrentRole();
            if (!currentRole) {
                console.warn('startDataListeners: No role set in appState');
                return null;
            }
            
            const listeners = [];
            
            // Employee role: Listen to their own bookings only
            if (currentRole === 'employee') {
                const bookingsRef = window.firebaseFunctions.collection(window.firebaseDb, 'all_requests');
                const employeeQuery = window.firebaseFunctions.query(
                    bookingsRef,
                    window.firebaseFunctions.where('requesterId', '==', user.uid), // Scoped to employee's userId
                    window.firebaseFunctions.orderBy('startTime', 'desc')
                );
                
                const unsubscribe = window.firebaseFunctions.onSnapshot(employeeQuery, (snapshot) => {
                    const bookings = [];
                    snapshot.forEach((doc) => {
                        bookings.push({ id: doc.id, ...doc.data() });
                    });
                    // Update employee dashboard when bookings change
                    populateEmployeeDashboard(user.uid);
                }, (error) => {
                    console.error('‚ùå Employee bookings listener error:', error);
                    if (error.code === 'permission-denied') {
                        console.error('üîí PERMISSION DENIED: Employee cannot read bookings');
                        console.error('   Check Firebase Security Rules - Employee should be able to read where requesterId == auth.uid');
                        console.error('   Current user UID:', user.uid);
                    }
                });
                
                listeners.push({ type: 'employee_bookings', unsubscribe });
                console.log(`startDataListeners: Employee listener set up for userId: ${user.uid}`);
            }
            
            // Driver role: Listen to assigned trips only
            if (currentRole === 'driver') {
                const bookingsRef = window.firebaseFunctions.collection(window.firebaseDb, 'all_requests');
                const driverQuery = window.firebaseFunctions.query(
                    bookingsRef,
                    window.firebaseFunctions.where('assignedDriverId', '==', user.uid), // Scoped to driver's userId
                    window.firebaseFunctions.where('status', 'in', ['APPROVED', 'ACTIVE']),
                    window.firebaseFunctions.orderBy('startTime', 'asc')
                );
                
                const unsubscribe = window.firebaseFunctions.onSnapshot(driverQuery, (snapshot) => {
                    const trips = [];
                    snapshot.forEach((doc) => {
                        const booking = { id: doc.id, ...doc.data() };
                        // Double-check: Only include APPROVED or ACTIVE trips (exclude CANCELLED)
                        if (booking.status !== 'CANCELLED' && (booking.status === 'APPROVED' || booking.status === 'ACTIVE')) {
                            trips.push(booking);
                        }
                    });
                    
                    console.log(`üöó Driver Listener: ${trips.length} active/approved trips found (CANCELLED trips automatically excluded)`);
                    if (trips.length === 0) {
                        console.log(`   ‚ö†Ô∏è No active trips - Trip card should show "No Active Trips"`);
                    }
                    
                    // Update driver dashboard when assigned trips change
                    populateDriverDashboard(user.uid);
                }, (error) => {
                    console.error('‚ùå Driver trips listener error:', error);
                    if (error.code === 'permission-denied') {
                        console.error('üîí PERMISSION DENIED: Driver cannot read assigned trips');
                        console.error('   Check Firebase Security Rules - Driver should be able to read where assignedDriverId == auth.uid');
                        console.error('   Current user UID:', user.uid);
                    }
                });
                
                listeners.push({ type: 'driver_trips', unsubscribe });
                console.log(`startDataListeners: Driver listener set up for userId: ${user.uid}`);
            }
            
            // Admin role: Listen to all bookings (pending, approved, cancelled) for complete oversight
            if (currentRole === 'admin') {
                // Listener 1: Pending bookings (for queue management)
                const pendingBookingsRef = window.firebaseFunctions.collection(window.firebaseDb, 'all_requests');
                const pendingQuery = window.firebaseFunctions.query(
                    pendingBookingsRef,
                    window.firebaseFunctions.where('status', '==', 'PENDING'),
                    window.firebaseFunctions.orderBy('startTime', 'asc')
                );
                
                const unsubscribePending = window.firebaseFunctions.onSnapshot(pendingQuery, (snapshot) => {
                    const bookings = [];
                    snapshot.forEach((doc) => {
                        bookings.push({ id: doc.id, ...doc.data() });
                    });
                    console.log(`üìä Admin Pending Listener: ${bookings.length} pending bookings`);
                    // Update admin dashboard when pending bookings change
                    populateAdminDashboard();
                }, (error) => {
                    console.error('‚ùå Admin pending bookings listener error:', error);
                    if (error.code === 'permission-denied') {
                        console.error('üîí PERMISSION DENIED: Admin cannot read pending bookings');
                        console.error('   Check Firebase Security Rules - Admin should have full read/write access');
                    }
                });
                
                listeners.push({ type: 'admin_pending', unsubscribe: unsubscribePending });
                
                // Listener 2: All bookings including CANCELLED (for real-time status updates)
                // This allows admin to see status changes (like CANCELLED) in real-time
                const allBookingsRef = window.firebaseFunctions.collection(window.firebaseDb, 'all_requests');
                const allBookingsQuery = window.firebaseFunctions.query(
                    allBookingsRef,
                    window.firebaseFunctions.orderBy('startTime', 'desc')
                );
                
                const unsubscribeAll = window.firebaseFunctions.onSnapshot(allBookingsQuery, (snapshot) => {
                    const bookings = [];
                    snapshot.forEach((doc) => {
                        bookings.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Log cancelled bookings for real-time verification
                    const cancelledBookings = bookings.filter(b => b.status === 'CANCELLED');
                    if (cancelledBookings.length > 0) {
                        console.log(`üîÑ Admin All Bookings Listener: ${cancelledBookings.length} cancelled booking(s) detected`);
                        cancelledBookings.forEach(booking => {
                            console.log(`   - Booking ${booking.id} is CANCELLED (real-time update) - Purpose: ${booking.tripPurpose || 'N/A'}`);
                        });
                    }
                    
                    // Update admin dashboard to show all statuses including cancelled
                    populateAdminDashboard();
                }, (error) => {
                    console.error('‚ùå Admin all bookings listener error:', error);
                    if (error.code === 'permission-denied') {
                        console.error('üîí PERMISSION DENIED: Admin cannot read all bookings');
                        console.error('   Check Firebase Security Rules - Admin should have full read/write access');
                    }
                });
                
                listeners.push({ type: 'admin_all', unsubscribe: unsubscribeAll });
                console.log(`startDataListeners: Admin listeners set up (pending + all bookings for real-time status updates)`);
            }
            
            // Store listeners globally for cleanup
            window.dataListeners = listeners;
            
            return listeners; // Return listeners array for cleanup
        }
        
        // Stop all data listeners (cleanup function)
        function stopDataListeners(listeners) {
            if (!listeners || !Array.isArray(listeners)) {
                // Try to use global listeners if provided listeners is invalid
                listeners = window.dataListeners || [];
            }
            
            listeners.forEach(listener => {
                if (listener && listener.unsubscribe) {
                    try {
                        listener.unsubscribe();
                        console.log(`stopDataListeners: Stopped ${listener.type} listener`);
                    } catch (error) {
                        console.error('Error stopping listener:', error);
                    }
                }
            });
            
            window.dataListeners = [];
        }
        
        // LocalStorage persistence for MOCK_BOOKINGS
        const STORAGE_KEY = 'smartcar_mock_bookings';
        
        // Default/Initial bookings (for first-time users or reset)
        const DEFAULT_MOCK_BOOKINGS = {
            "B-001": {
                "requesterId": "emp_high",
                "vehicleType": "Minibus",
                "startTime": "2025-11-06T08:00:00Z",
                "durationHours": 4,
                "driverOption": "Request Driver",
                "status": "PENDING",
                "adminNotes": "",
                "scenario": "Admin URGENT Flag / Employee Pending Status Check",
                "passengers": 30,
                "tripPurpose": "Field Trip to Museum"
            },
            "B-002": {
                "requesterId": "emp_low",
                "vehicleType": "Passenger Van",
                "startTime": "2025-11-06T09:00:00Z",
                "durationHours": 8,
                "driverOption": "Self-Drive",
                "status": "PENDING",
                "adminNotes": "",
                "scenario": "Admin Context Check (High Cancellation) / Vehicle Maintenance Conflict",
                "passengers": 12,
                "tripPurpose": "Sports Event"
            },
            "B-003": {
                "requesterId": "emp_high",
                "vehicleType": "Minibus",
                "startTime": "2025-11-07T10:00:00Z",
                "durationHours": 3,
                "driverOption": "Request Driver",
                "status": "APPROVED",
                "assignedDriverId": "driver_puck",
                "scenario": "Employee Approved Status / Driver Upcoming Trip Check",
                "passengers": 25,
                "tripPurpose": "Workshop"
            },
            "B-004": {
                "requesterId": "emp_low",
                "vehicleType": "Sedan",
                "startTime": "2025-11-05T15:30:00Z",
                "durationHours": 1,
                "driverOption": "Self-Drive",
                "status": "DENIED",
                "adminNotes": "Denied: Vehicle Sedan Charlie is in maintenance until 11/15. Please select an alternate vehicle or date.",
                "scenario": "Employee Denied Status Check / Admin Templated Denial",
                "passengers": 3,
                "tripPurpose": "Quick Trip"
            },
            "B-005": {
                "requesterId": "emp_high",
                "vehicleType": "Minibus",
                "startTime": "2025-11-05T13:00:00Z",
                "durationHours": 2,
                "driverOption": "Request Driver",
                "status": "ACTIVE",
                "assignedDriverId": "driver_kore",
                "driverStatus": "En Route",
                "scenario": "Driver Active Trip / Employee Real-Time Status Check",
                "passengers": 20,
                "tripPurpose": "School Event"
            },
            "B-006": {
                "requesterId": "emp_high",
                "vehicleType": "Minibus",
                "startTime": "2025-11-04T09:00:00Z",
                "durationHours": 3,
                "driverOption": "Request Driver",
                "status": "COMPLETED",
                "assignedDriverId": "driver_kore",
                "finalLog": {
                    "odometerEnd": 12150,
                    "fuelLevelEnd": "3/4",
                    "issuesComments": "Vehicle ran great, no issues."
                },
                "scenario": "Driver Log Enforcement Check / Employee History",
                "passengers": 28,
                "tripPurpose": "Past Trip"
            },
            "B-007": {
                "requesterId": "emp_high",
                "vehicleType": "Minibus",
                "startTime": "2025-11-06T09:00:00Z",
                "durationHours": 4,
                "driverOption": "Request Driver",
                "status": "PENDING",
                "adminNotes": "",
                "scenario": "Employee Proactive Check / Admin Booking Conflict Test (Minibus Alpha booked 08:00-12:00 by B-001)",
                "passengers": 35,
                "tripPurpose": "Museum Field Trip"
            }
        };
        
        // Load MOCK_BOOKINGS from localStorage or use default
        function loadMockBookings() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const savedBookings = JSON.parse(saved);
                    // Merge: saved bookings take precedence, but include any new default bookings not in saved
                    return { ...DEFAULT_MOCK_BOOKINGS, ...savedBookings };
                }
            } catch (error) {
                console.warn('Failed to load bookings from localStorage:', error);
            }
            // Return default bookings if localStorage is empty or error
            return { ...DEFAULT_MOCK_BOOKINGS };
        }
        
        // Save MOCK_BOOKINGS to localStorage
        function saveMockBookings() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(MOCK_BOOKINGS));
                console.log('üíæ Bookings saved to localStorage');
            } catch (error) {
                console.error('Failed to save bookings to localStorage:', error);
            }
        }
        
        // Initialize MOCK_BOOKINGS from localStorage
        const MOCK_BOOKINGS = loadMockBookings();
        console.log('üì¶ Loaded bookings from localStorage:', Object.keys(MOCK_BOOKINGS).length, 'bookings');
        
        // Helper function to get user by ID
        function getUserById(userId) {
            return MOCK_USERS[userId] || null;
        }
        
        // Helper function to get vehicle by ID
        function getVehicleById(vehicleId) {
            return MOCK_VEHICLES[vehicleId] || null;
        }
        
        // Helper function to get booking by ID
        function getBookingById(bookingId) {
            return MOCK_BOOKINGS[bookingId] || null;
        }
        
        // Helper function to format date/time
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return {
                date: date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
                time: date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }),
                dateShort: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                dateTime: date.toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true })
            };
        }
        
        // Helper function to check if booking is urgent (within 48 hours)
        function isUrgentBooking(startTime) {
            const bookingDate = new Date(startTime);
            const hoursUntilBooking = (bookingDate - CURRENT_DATE) / (1000 * 60 * 60);
            return hoursUntilBooking <= 48 && hoursUntilBooking >= 0;
        }
        
        // Helper function to get bookings by status
        function getBookingsByStatus(status) {
            return Object.entries(MOCK_BOOKINGS)
                .filter(([id, booking]) => booking.status === status)
                .map(([id, booking]) => ({ id, ...booking }));
        }
        
        // Helper function to get bookings by requester
        function getBookingsByRequester(requesterId) {
            return Object.entries(MOCK_BOOKINGS)
                .filter(([id, booking]) => booking.requesterId === requesterId)
                .map(([id, booking]) => ({ id, ...booking }));
        }

        // Helper function to open edit modal from table row
        function openEditVehicleModalFromRow(button) {
            const row = button.closest('tr');
            const vehicleId = row.querySelector('td:nth-child(2)').textContent.trim();
            const type = row.querySelector('td:nth-child(3)').textContent.trim();
            const capacity = row.querySelector('td:nth-child(4)').textContent.trim();
            const statusElement = row.querySelector('td:nth-child(5) span');
            const status = statusElement ? statusElement.textContent.trim() : 'Available';
            const imageElement = row.querySelector('td:first-child img');
            const currentImageUrl = imageElement ? imageElement.src : '';
            
            openEditVehicleModal(vehicleId, type, capacity, status, currentImageUrl);
        }

        // Edit Vehicle Functions
        function openEditVehicleModal(vehicleId, type, capacity, status, currentImageUrl = '') {
            document.getElementById('edit-vehicle-id').value = vehicleId;
            document.getElementById('edit-vehicle-id-display').value = vehicleId;
            document.getElementById('edit-vehicle-type').value = type;
            document.getElementById('edit-vehicle-capacity').value = capacity;
            document.getElementById('edit-vehicle-status').value = status;
            
            // Handle image preview
            const imagePreview = document.getElementById('edit-vehicle-image-preview');
            const imageCurrent = document.getElementById('edit-vehicle-image-current');
            const imageInput = document.getElementById('edit-vehicle-image');
            const currentImageInput = document.getElementById('edit-vehicle-current-image');
            
            if (currentImageUrl) {
                currentImageInput.value = currentImageUrl;
                imagePreview.src = currentImageUrl;
                imagePreview.classList.remove('hidden');
                imageCurrent.textContent = window.t('currentImage');
            } else {
                // Default images based on type
                let defaultImage = '';
                if (type === 'School Bus') {
                    defaultImage = 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=100&h=100&fit=crop';
                } else if (type === 'SUV') {
                    defaultImage = 'https://images.unsplash.com/photo-1503376780353-7e6692767b70?w=100&h=100&fit=crop';
                } else if (type === 'Sedan') {
                    defaultImage = 'https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?w=100&h=100&fit=crop';
                }
                if (defaultImage) {
                    imagePreview.src = defaultImage;
                    imagePreview.classList.remove('hidden');
                    imageCurrent.textContent = window.t('currentImage');
                } else {
                    imagePreview.classList.add('hidden');
                    imageCurrent.textContent = window.t('noImageCurrently');
                }
            }
            
            // Reset file input
            imageInput.value = '';
            
            document.getElementById('edit-vehicle-modal').classList.add('open');
        }

        function closeEditVehicleModal() {
            document.getElementById('edit-vehicle-modal').classList.remove('open');
        }

        // Add Vehicle Modal Functions
        function openAddVehicleModal() {
            const modal = document.getElementById('add-vehicle-modal');
            if (modal) {
                // Reset form
                const form = document.getElementById('add-vehicle-form');
                if (form) {
                    form.reset();
                    // Clear image preview
                    const preview = document.getElementById('add-vehicle-image-preview');
                    if (preview) {
                        preview.src = '';
                        preview.classList.add('hidden');
                    }
                }
                modal.classList.add('open');
            }
        }
        
        function closeAddVehicleModal() {
            const modal = document.getElementById('add-vehicle-modal');
            if (modal) {
                modal.classList.remove('open');
                // Reset form
                const form = document.getElementById('add-vehicle-form');
                if (form) {
                    form.reset();
                    // Clear image preview
                    const preview = document.getElementById('add-vehicle-image-preview');
                    if (preview) {
                        preview.src = '';
                        preview.classList.add('hidden');
                    }
                }
            }
        }

        async function deleteVehicle(vehicleId) {
            if (confirm(`Are you sure you want to delete vehicle ${vehicleId}?`)) {
                try {
                    // In a real app, this would make an API call to delete from Firebase
                    // For now, just show success message
                    showSuccess(`Vehicle ${vehicleId} has been deleted.`);
                    
                    // In production, would refresh the vehicle list
                    // For now, just show success
                } catch (error) {
                    console.error('Error deleting vehicle:', error);
                    showError('Failed to delete vehicle. Please try again.');
                }
            }
        }

        // Booking approval functions
        // Queue Management Functions
        function sortQueue() {
            const sortValue = document.getElementById('queue-sort')?.value;
            const queue = document.getElementById('pending-queue');
            if (!queue) return;
            
            const items = Array.from(queue.children);
            
            items.sort((a, b) => {
                if (sortValue === 'urgency') {
                    const aUrgency = a.dataset.urgency === 'urgent' ? 0 : 1;
                    const bUrgency = b.dataset.urgency === 'urgent' ? 0 : 1;
                    if (aUrgency !== bUrgency) return aUrgency - bUrgency;
                    // Then sort by date
                    return new Date(a.dataset.date) - new Date(b.dataset.date);
                } else if (sortValue === 'date') {
                    return new Date(b.dataset.date) - new Date(a.dataset.date);
                } else if (sortValue === 'requester') {
                    const aName = a.querySelector('h3')?.textContent || '';
                    const bName = b.querySelector('h3')?.textContent || '';
                    return aName.localeCompare(bName);
                }
                return 0;
            });
            
            items.forEach(item => queue.appendChild(item));
        }
        
        function filterQueue() {
            const filterValue = document.getElementById('queue-filter')?.value;
            const queue = document.getElementById('pending-queue');
            if (!queue) return;
            
            const items = queue.children;
            let visibleCount = 0;
            
            for (let item of items) {
                let show = false;
                
                if (filterValue === 'all') {
                    show = true;
                } else if (filterValue === 'urgent') {
                    show = item.dataset.urgency === 'urgent';
                } else if (filterValue === 'violations') {
                    show = item.dataset.violations !== 'none';
                } else if (filterValue === 'short-notice') {
                    show = item.dataset.violations === 'short-notice';
                } else if (filterValue === 'max-duration') {
                    show = item.dataset.violations === 'max-duration';
                }
                
                if (show) {
                    item.classList.remove('hidden');
                    visibleCount++;
                } else {
                    item.classList.add('hidden');
                }
            }
            
            document.getElementById('queue-count').textContent = visibleCount;
        }
        
        // Quick Action Functions
        async function quickApprove(bookingId) {
            if (confirm('Are you sure you want to approve this booking request?')) {
                try {
                    // Get booking to check if it needs a driver
                    const booking = getBookingById(bookingId);
                    if (!booking) {
                        showError('Booking not found.');
                        return;
                    }
                    
                    // Auto-assign driver if booking requires school driver
                    let assignedDriverId = booking.assignedDriverId;
                    if (!assignedDriverId && booking.driverOption === 'Request Driver') {
                        // Auto-assign first available driver (in production, would use smart assignment logic)
                        const availableDrivers = Object.keys(MOCK_USERS).filter(id => MOCK_USERS[id].role === 'Driver');
                        if (availableDrivers.length > 0) {
                            // Assign first driver (could be improved with availability checking)
                            assignedDriverId = availableDrivers[0];
                            console.log(`üöó Auto-assigning driver ${assignedDriverId} to booking ${bookingId}`);
                        }
                    }
                    
                    // Update booking status to APPROVED
                    const updates = {
                        status: 'APPROVED',
                        approvedAt: new Date().toISOString(),
                        adminNotes: 'Booking approved by admin'
                    };
                    
                    // Add driver assignment if applicable
                    if (assignedDriverId) {
                        updates.assignedDriverId = assignedDriverId;
                    }
                    
                    await updateBookingFirestore(bookingId, updates);
                    
                    showSuccess(`Booking request has been approved successfully!${assignedDriverId ? ` Driver ${MOCK_USERS[assignedDriverId]?.name || assignedDriverId} has been assigned.` : ''}`);
                    
                    // Refresh admin dashboard to remove from pending queue
                    await populateAdminDashboard();
                    
                    // Refresh employee dashboard if it's open
                    const employeeDashboard = document.getElementById('view-employee-dashboard');
                    if (employeeDashboard && employeeDashboard.classList.contains('active')) {
                        await populateEmployeeDashboard(appState.currentUserId || 'emp_high');
                    }
                    
                    // Refresh driver dashboard if it's open and driver was assigned
                    if (assignedDriverId) {
                        const driverDashboard = document.getElementById('view-assigned-trips');
                        if (driverDashboard && driverDashboard.classList.contains('active')) {
                            await populateDriverDashboard(assignedDriverId);
                        }
                    }
                    
                    // Close detail view if open
                    closeRequestDetailView();
                } catch (error) {
                    console.error('Error approving booking:', error);
                    showError('Failed to approve booking. Please try again.');
                }
            }
        }
        
        function quickDenyAvailability(bookingId) {
            openDenialModal(bookingId, 'availability');
        }
        
        // Enhanced Request Detail View - uses MOCK_BOOKINGS data
        function openRequestDetailView(bookingId) {
            // Get booking from MOCK_BOOKINGS
            const booking = getBookingById(bookingId);
            if (!booking) {
                showError('Booking not found.');
                return;
            }
            
            const requester = getUserById(booking.requesterId);
            const driver = booking.assignedDriverId ? getUserById(booking.assignedDriverId) : null;
            const dt = formatDateTime(booking.startTime);
            
            // Calculate end time
            const endTime = new Date(new Date(booking.startTime).getTime() + booking.durationHours * 60 * 60 * 1000);
            const endDt = formatDateTime(endTime.toISOString());
            
            // Check for conflicts with other bookings
            const conflicts = [];
            Object.entries(MOCK_BOOKINGS).forEach(([id, otherBooking]) => {
                if (id !== bookingId && otherBooking.status !== 'DENIED' && otherBooking.status !== 'COMPLETED') {
                    const otherStart = new Date(otherBooking.startTime);
                    const otherEnd = new Date(otherStart.getTime() + otherBooking.durationHours * 60 * 60 * 1000);
                    const bookingStart = new Date(booking.startTime);
                    const bookingEnd = new Date(bookingStart.getTime() + booking.durationHours * 60 * 60 * 1000);
                    
                    // Check if time ranges overlap
                    if (bookingStart < otherEnd && bookingEnd > otherStart && otherBooking.vehicleType === booking.vehicleType) {
                        conflicts.push({
                            date: formatDateTime(otherBooking.startTime).dateShort,
                            time: `${formatDateTime(otherBooking.startTime).time} - ${endDt.time}`,
                            vehicle: otherBooking.vehicleType,
                            booking: otherBooking.tripPurpose || `Booking ${id}`
                        });
                    }
                }
            });
            
            // Get alternative vehicles
            const alternatives = [];
            Object.values(MOCK_VEHICLES).forEach(vehicle => {
                if (vehicle.type !== booking.vehicleType && vehicle.status === 'Available') {
                    alternatives.push(`${vehicle.type} (${vehicle.name}) - Available`);
                }
            });
            
            // Check for violations (compliance flagging)
            const violations = [];
            const hoursUntilBooking = (new Date(booking.startTime) - CURRENT_DATE) / (1000 * 60 * 60);
            const daysUntilBooking = hoursUntilBooking / 24;
            
            // Short Notice Request (less than 48 hours)
            if (hoursUntilBooking < 48 && hoursUntilBooking >= 0) {
                violations.push('Short Notice Request');
            }
            
            // Exceeds Max Duration (more than 7 days or 168 hours)
            if (booking.durationHours > 168) {
                violations.push('Exceeds Max Duration');
            }
            
            // Weekend booking (optional flag - can be added)
            const bookingDate = new Date(booking.startTime);
            const dayOfWeek = bookingDate.getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                violations.push('Weekend Booking');
            }
            
            // Build data object
            const data = {
                title: booking.tripPurpose || 'Trip',
                requester: requester ? requester.name : 'Unknown',
                department: requester ? `${requester.role} Department` : 'Unknown',
                email: requester ? `${booking.requesterId}@isd.edu` : 'unknown@isd.edu',
                phone: '+1 (555) 123-4567',
                date: dt.dateShort,
                time: dt.time,
                vehicle: booking.vehicleType,
                passengers: booking.passengers,
                duration: `${booking.durationHours} ${booking.durationHours === 1 ? 'hour' : 'hours'}`,
                purpose: booking.tripPurpose || 'Trip',
                driverOption: booking.driverOption === 'Request Driver' ? 'School Driver' : 'Self-Drive',
                pickupLocation: 'Main School Gate', // Default
                pickupTime: dt.time,
                totalBookings90Days: requester && requester.totalTrips90Days ? requester.totalTrips90Days : 0,
                canceledBookings: requester && requester.cancelledTripsLifetime ? requester.cancelledTripsLifetime : 0,
                deniedBookings: 0,
                violations: violations,
                conflicts: conflicts,
                alternatives: alternatives.length > 0 ? alternatives : ['No alternative vehicles available']
            };
            
            const modalContent = `
                <div class="max-w-6xl max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-200 p-4 mb-4 z-10">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-gray-800">${data.title}</h3>
                            <button onclick="closeRequestDetailView()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        ${data.violations.length > 0 ? `
                            <div class="mt-3 p-3 bg-red-50 border-2 border-red-400 rounded-lg">
                                <h4 class="text-sm font-bold text-red-900 mb-2 flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    ${window.t('policyViolationFlags')}
                                </h4>
                                <div class="flex flex-wrap gap-2">
                                    ${data.violations.map(v => {
                                        let icon = '‚ö†Ô∏è';
                                        let bgColor = 'bg-yellow-100';
                                        let textColor = 'text-yellow-900';
                                        let borderColor = 'border-yellow-400';
                                        let translatedText = v;
                                        
                                        if (v.includes('Short Notice')) {
                                            icon = '‚ö†Ô∏è';
                                            bgColor = 'bg-yellow-100';
                                            textColor = 'text-yellow-900';
                                            borderColor = 'border-yellow-400';
                                            translatedText = window.t('shortNotice');
                                        } else if (v.includes('Exceeds Max Duration')) {
                                            icon = 'üö´';
                                            bgColor = 'bg-red-100';
                                            textColor = 'text-red-900';
                                            borderColor = 'border-red-400';
                                            translatedText = window.t('exceedsMaxDuration');
                                        } else if (v.includes('Weekend')) {
                                            icon = 'üìÖ';
                                            bgColor = 'bg-orange-100';
                                            textColor = 'text-orange-900';
                                            borderColor = 'border-orange-400';
                                            translatedText = window.t('weekendBooking');
                                        }
                                        
                                        return `<span class="px-3 py-2 ${bgColor} ${textColor} border-2 ${borderColor} rounded-full text-sm font-bold shadow-md">${icon} ${translatedText}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Main Content -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Request Details -->
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h4 class="text-lg font-bold text-gray-800 mb-4">${window.t('requestDetails')}</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <p class="text-gray-600">${window.t('dateTimeLabel')}</p>
                                        <p class="font-semibold text-gray-800">${data.date} ${window.t('at')} ${data.time}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">${window.t('duration')}</p>
                                        <p class="font-semibold text-gray-800">${data.duration}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">${window.t('vehicleType')}</p>
                                        <p class="font-semibold text-gray-800">${data.vehicle}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">${window.t('passengersLabel')}</p>
                                        <p class="font-semibold text-gray-800">${data.passengers}</p>
                                    </div>
                                    <div class="col-span-2">
                                        <p class="text-gray-600">${window.t('tripPurpose')}</p>
                                        <p class="font-semibold text-gray-800">${data.purpose}</p>
                                    </div>
                                    ${data.driverOption === 'School Driver' ? `
                                        <div>
                                            <p class="text-gray-600">${window.t('pickupLocation')}</p>
                                            <p class="font-semibold text-gray-800">${data.pickupLocation}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-600">${window.t('pickupTime')}</p>
                                            <p class="font-semibold text-gray-800">${data.pickupTime}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Availability Panel with Timeline -->
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                    </svg>
                                    ${window.t('availabilityConflictsTimeline')}
                                </h4>
                                
                                <!-- Timeline View -->
                                <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                    <div class="space-y-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-3 h-3 rounded-full ${data.conflicts.length > 0 ? 'bg-red-500' : 'bg-green-500'}"></div>
                                            <div class="flex-1">
                                                <p class="text-sm font-semibold text-gray-800">${window.t('requestedTimeSlot')}</p>
                                                <p class="text-xs text-gray-600">${data.date} ${window.t('at')} ${data.time} (${data.duration})</p>
                                            </div>
                                        </div>
                                        ${data.conflicts.map((c, idx) => `
                                            <div class="flex items-center gap-3 ml-4">
                                                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                                <div class="flex-1">
                                                    <p class="text-sm font-semibold text-red-800">${window.t('conflict')} ${idx + 1}</p>
                                                    <p class="text-xs text-red-600">${c.date} ${c.time} - ${c.vehicle}</p>
                                                    <p class="text-xs text-red-500">${c.booking}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                ${data.conflicts.length > 0 ? `
                                    <div class="mb-4 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                                        <p class="text-sm font-bold text-red-900 mb-2 flex items-center gap-2">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                            ${window.t('conflictingBookingsDetected')}
                                        </p>
                                        <div class="space-y-2">
                                            ${data.conflicts.map(c => `
                                                <div class="text-sm text-red-800 bg-white p-2 rounded border border-red-200">
                                                    <span class="font-semibold">${c.date} ${c.time}</span> - ${c.vehicle}<br>
                                                    <span class="text-xs text-red-600">${c.booking}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : `
                                    <div class="mb-4 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                                        <p class="text-sm font-bold text-green-900 flex items-center gap-2">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                            </svg>
                                            ‚úì ${window.t('noConflictsDetected')}
                                        </p>
                                    </div>
                                `}
                                
                                <div class="p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
                                    <p class="text-sm font-bold text-blue-900 mb-3 flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
                                            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"></path>
                                        </svg>
                                        ${window.t('alternativeVehiclesAvailable')}
                                    </p>
                                    <div class="space-y-2">
                                        ${data.alternatives.map(a => `
                                            <div class="bg-white p-2 rounded border border-blue-200">
                                                <p class="text-sm font-semibold text-blue-800">‚úì ${a}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Requester Reliability Snapshot (Sidebar) -->
                        <div class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 sticky top-4">
                                <h4 class="text-lg font-bold text-gray-800 mb-4">${window.t('requesterProfile')}</h4>
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-xs text-gray-600 mb-1">${window.t('nameDepartment')}</p>
                                        <p class="font-semibold text-gray-800">${data.requester}</p>
                                        <p class="text-sm text-gray-600">${data.department}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600 mb-1">${window.t('contact')}</p>
                                        <p class="text-sm text-gray-800">${data.email}</p>
                                        <p class="text-sm text-gray-800">${data.phone}</p>
                                    </div>
                                    <div class="pt-4 border-t border-gray-200">
                                        <p class="text-xs text-gray-600 mb-2">${window.t('bookingStatisticsLast90Days')}</p>
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-700">${window.t('totalBookings')}</span>
                                                <span class="font-semibold text-gray-800">${data.totalBookings90Days}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-700">${window.t('canceled')}</span>
                                                <span class="font-semibold text-gray-600">${data.canceledBookings}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-700">${window.t('denied')}</span>
                                                <span class="font-semibold text-gray-600">${data.deniedBookings}</span>
                                            </div>
                                            <div class="mt-2 pt-2 border-t border-gray-200">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm font-semibold text-gray-700">${window.t('cancellationRate')}</span>
                                                    <span class="font-bold ${data.canceledBookings === 0 ? 'text-green-600' : data.canceledBookings < 2 ? 'text-yellow-600' : 'text-red-600'}">
                                                        ${data.totalBookings90Days > 0 ? Math.round((data.canceledBookings / data.totalBookings90Days) * 100) : 0}%
                                                    </span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">${data.canceledBookings} ${window.t('canceledOutOf')} ${data.totalBookings90Days} ${window.t('bookings')}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-6 flex gap-3 justify-end border-t border-gray-200 pt-4">
                        <button onclick="closeRequestDetailView(); openDenialModal('${bookingId}', 'custom')" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">${window.t('denyRequest')}</button>
                        <button onclick="closeRequestDetailView(); approveBooking('${bookingId}')" class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">${window.t('approveRequest')}</button>
                    </div>
                </div>
            `;
            
            let modal = document.getElementById('request-detail-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'request-detail-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal-content max-w-6xl">${modalContent}</div>`;
                document.body.appendChild(modal);
                
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeRequestDetailView();
                    }
                });
            } else {
                modal.querySelector('.modal-content').innerHTML = modalContent;
            }
            
            modal.classList.add('open');
        }
        
        function closeRequestDetailView() {
            const modal = document.getElementById('request-detail-modal');
            if (modal) modal.classList.remove('open');
        }
        
        // Templated Denial Responses
        function openDenialModal(bookingId, templateType) {
            const templates = {
                'availability': {
                    title: 'Vehicle Unavailable',
                    message: 'We regret to inform you that the requested vehicle type is not available for the selected date and time. Please consider alternative dates or vehicle types.'
                },
                'short-notice': {
                    title: 'Insufficient Lead Time',
                    message: 'This request requires a minimum of 2 weeks advance notice. Unfortunately, your request does not meet this requirement. Please resubmit with an earlier date.'
                },
                'missing-docs': {
                    title: 'Missing Documentation',
                    message: 'Your booking request is missing required documentation. Please submit all necessary forms before resubmitting your request.'
                },
                'max-duration': {
                    title: 'Exceeds Maximum Duration',
                    message: 'This request exceeds the maximum allowed booking duration. Please adjust the duration or contact the admin for special arrangements.'
                },
                'custom': {
                    title: 'Custom Denial Reason',
                    message: ''
                }
            };
            
            const template = templates[templateType] || templates['custom'];
            
            const modalContent = `
                <h3 class="text-xl font-bold mb-4 text-gray-800">Deny Booking Request</h3>
                <div class="text-left space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Denial Template</label>
                        <select id="denial-template-select" onchange="updateDenialTemplate()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold">
                            <option value="availability" ${templateType === 'availability' ? 'selected' : ''}>Vehicle Unavailable</option>
                            <option value="short-notice" ${templateType === 'short-notice' ? 'selected' : ''}>Short Notice</option>
                            <option value="missing-docs" ${templateType === 'missing-docs' ? 'selected' : ''}>Missing Documentation</option>
                            <option value="max-duration" ${templateType === 'max-duration' ? 'selected' : ''}>Exceeds Max Duration</option>
                            <option value="custom">Custom Message</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Denial Message</label>
                        <textarea id="denial-message" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-isd-gold">${template.message}</textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeDenialModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
                    <button onclick="submitDenial('${bookingId}')" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">Send Denial</button>
                </div>
            `;
            
            let modal = document.getElementById('denial-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'denial-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
                document.body.appendChild(modal);
                
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeDenialModal();
                    }
                });
            } else {
                modal.querySelector('.modal-content').innerHTML = modalContent;
            }
            
            modal.classList.add('open');
        }
        
        function updateDenialTemplate() {
            const select = document.getElementById('denial-template-select');
            const textarea = document.getElementById('denial-message');
            if (!select || !textarea) return;
            
            const templates = {
                'availability': 'We regret to inform you that the requested vehicle type is not available for the selected date and time. Please consider alternative dates or vehicle types.',
                'short-notice': 'This request requires a minimum of 2 weeks advance notice. Unfortunately, your request does not meet this requirement. Please resubmit with an earlier date.',
                'missing-docs': 'Your booking request is missing required documentation. Please submit all necessary forms before resubmitting your request.',
                'max-duration': 'This request exceeds the maximum allowed booking duration. Please adjust the duration or contact the admin for special arrangements.',
                'custom': ''
            };
            
            textarea.value = templates[select.value] || '';
        }
        
        async function submitDenial(bookingId) {
            const messageInput = document.getElementById('denial-message');
            const message = messageInput ? messageInput.value.trim() : '';
            const template = document.getElementById('denial-template-select')?.value;
            
            if (!message) {
                showError('Please provide a denial message.');
                return;
            }
            
            if (confirm('Are you sure you want to deny this booking request?')) {
                try {
                    // Sanitize the denial message
                    const safeMessage = sanitizeHTML(message);
                    
                    // Update booking status to DENIED
                    const updates = {
                        status: 'DENIED',
                        deniedAt: new Date().toISOString(),
                        adminNotes: `Denied: ${safeMessage}`
                    };
                    
                    await updateBookingFirestore(bookingId, updates);
                    
                    showSuccess('Booking request has been denied successfully.');
                    
                    // Refresh admin dashboard to remove from pending queue
                    await populateAdminDashboard();
                    
                    // Refresh employee dashboard if it's open
                    const employeeDashboard = document.getElementById('view-employee-dashboard');
                    if (employeeDashboard && employeeDashboard.classList.contains('active')) {
                        await populateEmployeeDashboard(appState.currentUserId || 'emp_high');
                    }
                    
                    closeDenialModal();
                    closeRequestDetailView();
                } catch (error) {
                    console.error('Error denying booking:', error);
                    showError('Failed to deny booking. Please try again.');
                }
            }
        }
        
        function closeDenialModal() {
            const modal = document.getElementById('denial-modal');
            if (modal) modal.classList.remove('open');
        }

        async function approveBooking(bookingId) {
            if (confirm('Are you sure you want to approve this booking request?')) {
                try {
                    // Get booking to check if it needs a driver
                    const booking = getBookingById(bookingId);
                    if (!booking) {
                        showError('Booking not found.');
                        return;
                    }
                    
                    // Auto-assign driver if booking requires school driver
                    let assignedDriverId = booking.assignedDriverId;
                    if (!assignedDriverId && booking.driverOption === 'Request Driver') {
                        // Auto-assign first available driver (in production, would use smart assignment logic)
                        const availableDrivers = Object.keys(MOCK_USERS).filter(id => MOCK_USERS[id].role === 'Driver');
                        if (availableDrivers.length > 0) {
                            // Assign first driver (could be improved with availability checking)
                            assignedDriverId = availableDrivers[0];
                            console.log(`üöó Auto-assigning driver ${assignedDriverId} to booking ${bookingId}`);
                        }
                    }
                    
                    // Update booking status to APPROVED
                    const updates = {
                        status: 'APPROVED',
                        approvedAt: new Date().toISOString(),
                        adminNotes: 'Booking approved by admin'
                    };
                    
                    // Add driver assignment if applicable
                    if (assignedDriverId) {
                        updates.assignedDriverId = assignedDriverId;
                    }
                    
                    await updateBookingFirestore(bookingId, updates);
                    
                    showSuccess(`Booking request has been approved successfully!${assignedDriverId ? ` Driver ${MOCK_USERS[assignedDriverId]?.name || assignedDriverId} has been assigned.` : ''}`);
                    
                    // Refresh admin dashboard to remove from pending queue
                    await populateAdminDashboard();
                    
                    // Refresh employee dashboard if it's open
                    const employeeDashboard = document.getElementById('view-employee-dashboard');
                    if (employeeDashboard && employeeDashboard.classList.contains('active')) {
                        await populateEmployeeDashboard(appState.currentUserId || 'emp_high');
                    }
                    
                    // Refresh driver dashboard if it's open and driver was assigned
                    if (assignedDriverId) {
                        const driverDashboard = document.getElementById('view-assigned-trips');
                        if (driverDashboard && driverDashboard.classList.contains('active')) {
                            await populateDriverDashboard(assignedDriverId);
                        }
                    }
                    
                    // Close detail view if open
                    closeRequestDetailView();
                } catch (error) {
                    console.error('Error approving booking:', error);
                    showError('Failed to approve booking. Please try again.');
                }
            }
        }

        function rejectBooking(bookingId) {
            openDenialModal(bookingId, 'custom');
        }

        function viewBookingDetails(bookingId) {
            openRequestDetailView(bookingId);
        }

        // Edit User Functions
        function openEditUserModal(name, email, role) {
            document.getElementById('edit-user-id').value = email;
            document.getElementById('edit-user-name').value = name;
            document.getElementById('edit-user-email').value = email;
            document.getElementById('edit-user-role').value = role;
            document.getElementById('edit-user-modal').classList.add('open');
        }

        function closeEditUserModal() {
            document.getElementById('edit-user-modal').classList.remove('open');
        }

        // Handle edit form submissions
        document.addEventListener('DOMContentLoaded', function() {
            // Add image preview handler for vehicle image upload
            const imageInput = document.getElementById('edit-vehicle-image');
            const imagePreview = document.getElementById('edit-vehicle-image-preview');
            const imageCurrent = document.getElementById('edit-vehicle-image-current');
            
            if (imageInput && imagePreview && imageCurrent) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imagePreview.src = e.target.result;
                            imagePreview.classList.remove('hidden');
                            imageCurrent.textContent = window.t('newImagePreview');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            const editVehicleForm = document.getElementById('edit-vehicle-form');
            if (editVehicleForm) {
                editVehicleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const vehicleId = document.getElementById('edit-vehicle-id').value;
                    const type = document.getElementById('edit-vehicle-type').value;
                    const capacity = document.getElementById('edit-vehicle-capacity').value;
                    const status = document.getElementById('edit-vehicle-status').value;
                    const imageFile = document.getElementById('edit-vehicle-image').files[0];
                    
                    // In a real app, this would make an API call with FormData
                    if (imageFile) {
                        // Create FormData for file upload
                        const formData = new FormData();
                        formData.append('vehicleId', vehicleId);
                        formData.append('type', type);
                        formData.append('capacity', capacity);
                        formData.append('status', status);
                        formData.append('image', imageFile);
                        
                        // In production, you would send this to your backend:
                        // fetch('/api/vehicles/update', { method: 'POST', body: formData })
                        
                        showSuccess(`Vehicle ${vehicleId} has been updated with new image!`);
                    } else {
                        showSuccess(`Vehicle ${vehicleId} has been updated!`);
                    }
                    
                    closeEditVehicleModal();
                    
                    // In production, would refresh the vehicle list
                    // For now, just show success
                });
            }

            const editUserForm = document.getElementById('edit-user-form');
            if (editUserForm) {
                editUserForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const name = document.getElementById('edit-user-name').value;
                    const email = document.getElementById('edit-user-email').value;
                    const role = document.getElementById('edit-user-role').value;
                    
                    // In a real app, this would make an API call
                    showSuccess(`User ${name} has been updated!`);
                    closeEditUserModal();
                    
                    // In production, would refresh the user list
                    // For now, just show success
                });
            }

            // Close modals when clicking outside
            const editVehicleModal = document.getElementById('edit-vehicle-modal');
            if (editVehicleModal) {
                editVehicleModal.addEventListener('click', function(e) {
                    if (e.target === editVehicleModal) {
                        closeEditVehicleModal();
                    }
                });
            }

            const editUserModal = document.getElementById('edit-user-modal');
            if (editUserModal) {
                editUserModal.addEventListener('click', function(e) {
                    if (e.target === editUserModal) {
                        closeEditUserModal();
                    }
                });
            }
        });

        // Check date availability and disable unavailable dates
        function checkDateAvailability() {
            const tripDateInput = document.getElementById('trip-date');
            if (!tripDateInput) return;
            
            const selectedDate = tripDateInput.value;
            
            // Check if date is in the bus unavailability period (Dec 5-15, 2025)
            const selectedDateObj = selectedDate ? new Date(selectedDate) : null;
            const busUnavailableStart = new Date('2025-12-05');
            const busUnavailableEnd = new Date('2025-12-15');
            busUnavailableStart.setHours(0, 0, 0, 0);
            busUnavailableEnd.setHours(23, 59, 59, 999);
            
            const vehicleType = document.getElementById('vehicle-type')?.value;
            const isBusType = vehicleType === 'bus';
            const isInBusUnavailablePeriod = selectedDateObj && selectedDateObj >= busUnavailableStart && selectedDateObj <= busUnavailableEnd;
            
            // Special case: November 6th, 2025 - all vehicles are unavailable
            if (selectedDate === '2025-11-06') {
                // Mark input as unavailable (gray it out) - keep the date selected but disabled
                // This makes it look exactly like a past date
                tripDateInput.classList.add('unavailable-date');
                tripDateInput.setAttribute('readonly', 'readonly');
                tripDateInput.setAttribute('disabled', 'disabled');
                
                // Don't clear immediately - keep it selected so user can see it's unavailable
                // Clear it only when user clicks the suggestion button
                
                // Find nearest available date (check next 7 days)
                // Start from November 7th (skip November 6th)
                const nov6 = new Date('2025-11-06');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let suggestedDate = null;
                
                // Get all booked dates from MOCK_BOOKINGS to check availability
                const bookedDates = new Set();
                Object.values(MOCK_BOOKINGS).forEach(booking => {
                    if (booking.status !== 'DENIED' && booking.status !== 'COMPLETED') {
                        const bookingDate = new Date(booking.startTime).toISOString().split('T')[0];
                        bookedDates.add(bookingDate);
                    }
                });
                
                // Check the next 14 days starting from November 7th (skip November 6th)
                for (let i = 1; i <= 14; i++) {
                    const checkDate = new Date(nov6);
                    checkDate.setDate(checkDate.getDate() + i);
                    const dateStr = checkDate.toISOString().split('T')[0];
                    
                    // Ensure we're not suggesting a past date
                    const checkDateObj = new Date(checkDate);
                    checkDateObj.setHours(0, 0, 0, 0);
                    
                    // Skip November 6th and past dates, check if date is available
                    if (dateStr !== '2025-11-06' && checkDateObj >= today && !bookedDates.has(dateStr)) {
                        suggestedDate = dateStr;
                        break;
                    }
                }
                
                // If no available date found in the next 14 days, default to November 7th
                if (!suggestedDate) {
                    const nov7 = new Date(nov6);
                    nov7.setDate(nov7.getDate() + 1);
                    suggestedDate = nov7.toISOString().split('T')[0];
                }
                
                // Show suggestion for nearest available date next to the date input
                const dateAvailabilityMessage = document.getElementById('date-availability-message');
                if (dateAvailabilityMessage && suggestedDate) {
                    dateAvailabilityMessage.classList.remove('hidden');
                    const suggestedDateFormatted = new Date(suggestedDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                    dateAvailabilityMessage.className = 'p-3 bg-blue-50 border border-blue-200 rounded-lg mt-2';
                    dateAvailabilityMessage.innerHTML = `
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm text-blue-800 font-semibold mb-1">${window.t('dateUnavailableSuggested')}</p>
                                <p class="text-sm text-blue-700 font-medium mb-2"><strong>${suggestedDateFormatted}</strong></p>
                                <button type="button" onclick="const dateInput = document.getElementById('trip-date'); dateInput.value='${suggestedDate}'; dateInput.classList.remove('unavailable-date'); dateInput.removeAttribute('disabled'); dateInput.removeAttribute('readonly'); document.getElementById('date-availability-message').classList.add('hidden'); autoCheckAvailability();" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 text-sm">${window.t('selectDate')} ${suggestedDateFormatted}</button>
                            </div>
                        </div>
                    `;
                }
                
                // Disable submit button
                const submitBtn = document.getElementById('submit-booking-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                }
                
                return;
            } else if (isInBusUnavailablePeriod && isBusType) {
                // Special case: December 5-15, 2025 - buses/minibuses are unavailable
                // Mark input as unavailable if bus type is selected
                tripDateInput.classList.add('unavailable-date');
                tripDateInput.setAttribute('readonly', 'readonly');
                tripDateInput.setAttribute('disabled', 'disabled');
                
                // Show message next to date input
                const dateAvailabilityMessage = document.getElementById('date-availability-message');
                if (dateAvailabilityMessage) {
                    dateAvailabilityMessage.classList.remove('hidden');
                    dateAvailabilityMessage.className = 'p-3 bg-yellow-50 border border-yellow-200 rounded-lg mt-2';
                    dateAvailabilityMessage.innerHTML = `
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm text-yellow-800 font-semibold mb-1">${window.t('busesUnavailablePeriod')}</p>
                                <p class="text-xs text-yellow-700 mb-2">${window.t('selectDifferentDateOrVehicle')}</p>
                            </div>
                        </div>
                    `;
                }
                
                // Disable submit button
                const submitBtn = document.getElementById('submit-booking-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                }
                
                return;
            } else {
                // Remove unavailable date class if a valid date is selected
                tripDateInput.classList.remove('unavailable-date');
                tripDateInput.removeAttribute('disabled');
                tripDateInput.removeAttribute('readonly');
                
                // Hide the date availability message if it's showing
                const dateAvailabilityMessage = document.getElementById('date-availability-message');
                if (dateAvailabilityMessage) {
                    dateAvailabilityMessage.classList.add('hidden');
                }
            }
            
            // Check if the selected date has no available vehicles
            // Get all bookings for the selected date
            if (selectedDate) {
                const selectedDateObj = new Date(selectedDate);
                const bookingsOnDate = Object.values(MOCK_BOOKINGS).filter(booking => {
                    if (booking.status === 'DENIED' || booking.status === 'COMPLETED') {
                        return false;
                    }
                    const bookingDate = new Date(booking.startTime).toISOString().split('T')[0];
                    return bookingDate === selectedDate;
                });
                
                // Get all available vehicle types from MOCK_VEHICLES
                const availableVehicleTypes = new Set();
                Object.values(MOCK_VEHICLES).forEach(vehicle => {
                    // Only count vehicles that are available (not in maintenance)
                    if (vehicle.status === 'Available') {
                        // Map vehicle types to form values
                        if (vehicle.type === 'Minibus') {
                            availableVehicleTypes.add('bus');
                        } else if (vehicle.type === 'Passenger Van') {
                            availableVehicleTypes.add('van');
                        } else if (vehicle.type === 'Sedan') {
                            availableVehicleTypes.add('car');
                        }
                    }
                });
                
                // Get booked vehicle types on this date
                const bookedVehicleTypes = new Set();
                bookingsOnDate.forEach(booking => {
                    // Map booking vehicle types to form values
                    if (booking.vehicleType === 'Minibus') {
                        bookedVehicleTypes.add('bus');
                    } else if (booking.vehicleType === 'Passenger Van') {
                        bookedVehicleTypes.add('van');
                    } else if (booking.vehicleType === 'Sedan') {
                        bookedVehicleTypes.add('car');
                    }
                });
                
                // Check if all available vehicle types are booked
                // Also check if the date is in bus unavailability period (Dec 5-15)
                const busUnavailableStart = new Date('2025-12-05');
                const busUnavailableEnd = new Date('2025-12-15');
                busUnavailableStart.setHours(0, 0, 0, 0);
                busUnavailableEnd.setHours(23, 59, 59, 999);
                const isInBusUnavailablePeriod = selectedDateObj >= busUnavailableStart && selectedDateObj <= busUnavailableEnd;
                
                // If bus is in unavailable period, consider it as "booked" for this check
                if (isInBusUnavailablePeriod && availableVehicleTypes.has('bus')) {
                    bookedVehicleTypes.add('bus');
                }
                
                // Check if all available vehicle types are booked
                const allVehiclesBooked = availableVehicleTypes.size > 0 && 
                    Array.from(availableVehicleTypes).every(type => bookedVehicleTypes.has(type));
                
                if (allVehiclesBooked && selectedDate !== '2025-11-06') {
                    // All vehicles are booked on this date - mark as unavailable
                    tripDateInput.classList.add('unavailable-date');
                    tripDateInput.setAttribute('readonly', 'readonly');
                    tripDateInput.setAttribute('disabled', 'disabled');
                    
                    // Find nearest available date
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    let suggestedDate = null;
                    
                    // Check the next 30 days for an available date
                    for (let i = 1; i <= 30; i++) {
                        const checkDate = new Date(selectedDateObj);
                        checkDate.setDate(checkDate.getDate() + i);
                        const dateStr = checkDate.toISOString().split('T')[0];
                        
                        // Skip November 6th and check if date is in bus unavailability period
                        if (dateStr === '2025-11-06') continue;
                        
                        const checkDateObj = new Date(checkDate);
                        checkDateObj.setHours(0, 0, 0, 0);
                        if (checkDateObj < today) continue;
                        
                        // Check if this date has any available vehicles
                        const checkBookingsOnDate = Object.values(MOCK_BOOKINGS).filter(booking => {
                            if (booking.status === 'DENIED' || booking.status === 'COMPLETED') {
                                return false;
                            }
                            const bookingDate = new Date(booking.startTime).toISOString().split('T')[0];
                            return bookingDate === dateStr;
                        });
                        
                        const checkBookedTypes = new Set();
                        checkBookingsOnDate.forEach(booking => {
                            if (booking.vehicleType === 'Minibus') {
                                checkBookedTypes.add('bus');
                            } else if (booking.vehicleType === 'Passenger Van') {
                                checkBookedTypes.add('van');
                            } else if (booking.vehicleType === 'Sedan') {
                                checkBookedTypes.add('car');
                            }
                        });
                        
                        // Check if date is in bus unavailability period
                        const checkBusUnavailableStart = new Date('2025-12-05');
                        const checkBusUnavailableEnd = new Date('2025-12-15');
                        checkBusUnavailableStart.setHours(0, 0, 0, 0);
                        checkBusUnavailableEnd.setHours(23, 59, 59, 999);
                        const checkIsInBusUnavailablePeriod = checkDateObj >= checkBusUnavailableStart && checkDateObj <= checkBusUnavailableEnd;
                        
                        if (checkIsInBusUnavailablePeriod && availableVehicleTypes.has('bus')) {
                            checkBookedTypes.add('bus');
                        }
                        
                        // Check if this date has at least one available vehicle type
                        const hasAvailableVehicle = Array.from(availableVehicleTypes).some(type => !checkBookedTypes.has(type));
                        
                        if (hasAvailableVehicle) {
                            suggestedDate = dateStr;
                            break;
                        }
                    }
                    
                    // Show suggestion for nearest available date
                    const dateAvailabilityMessage = document.getElementById('date-availability-message');
                    if (dateAvailabilityMessage) {
                        dateAvailabilityMessage.classList.remove('hidden');
                        if (suggestedDate) {
                            const suggestedDateFormatted = new Date(suggestedDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                            dateAvailabilityMessage.className = 'p-3 bg-blue-50 border border-blue-200 rounded-lg mt-2';
                            dateAvailabilityMessage.innerHTML = `
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm text-blue-800 font-semibold mb-1">All vehicles are unavailable on this date. Suggested nearest available date:</p>
                                        <p class="text-sm text-blue-700 font-medium mb-2"><strong>${suggestedDateFormatted}</strong></p>
                                        <button type="button" onclick="const dateInput = document.getElementById('trip-date'); dateInput.value='${suggestedDate}'; dateInput.classList.remove('unavailable-date'); dateInput.removeAttribute('disabled'); dateInput.removeAttribute('readonly'); document.getElementById('date-availability-message').classList.add('hidden'); checkDateAvailability(); autoCheckAvailability();" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 text-sm">Select ${suggestedDateFormatted}</button>
                                    </div>
                                </div>
                            `;
                        } else {
                            dateAvailabilityMessage.className = 'p-3 bg-red-50 border border-red-200 rounded-lg mt-2';
                            dateAvailabilityMessage.innerHTML = `
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm text-red-800 font-semibold mb-1">All vehicles are unavailable on this date.</p>
                                        <p class="text-xs text-red-700">Please contact the administrator for assistance.</p>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // Disable submit button
                    const submitBtn = document.getElementById('submit-booking-btn');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                    }
                    
                    return;
                }
            }
            
            // Get all existing bookings from MOCK_BOOKINGS (for other checks)
            const bookedDates = new Set();
            Object.values(MOCK_BOOKINGS).forEach(booking => {
                if (booking.status !== 'DENIED' && booking.status !== 'COMPLETED') {
                    const bookingDate = new Date(booking.startTime).toISOString().split('T')[0];
                    bookedDates.add(bookingDate);
                }
            });
            
            // For date input, we need to use a different approach
            // We'll check availability when the date is selected
            if (bookedDates.has(selectedDate)) {
                // Show warning but allow selection (Admin can override)
                const feedback = document.getElementById('availability-feedback');
                if (feedback) {
                    feedback.classList.remove('hidden');
                    const status = document.getElementById('availability-status');
                    if (status) {
                        status.innerHTML = `
                            <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p class="text-sm text-yellow-800">‚ö†Ô∏è This date has existing bookings. Please check availability.</p>
                            </div>
                        `;
                    }
                }
            }
        }
        
        // Auto-check availability when date and vehicle type are selected
        function autoCheckAvailability() {
            const vehicleType = document.getElementById('vehicle-type')?.value;
            const tripDate = document.getElementById('trip-date')?.value;
            const pickupTime = document.getElementById('pickup-time')?.value;
            const duration = document.getElementById('trip-duration')?.value;
            const passengers = document.getElementById('passengers')?.value;
            const driverOption = document.getElementById('driver-option')?.value;
            const tripPurpose = document.getElementById('trip-purpose')?.value.trim();
            
            // Auto-check if we have minimum required fields: date, vehicle type, and pickup time
            // November 6th is handled by checkDateAvailability() which clears the date
            if (vehicleType && tripDate && pickupTime && tripDate !== '2025-11-06') {
                // For other dates, check if we have minimum required fields
                // Show availability feedback area
                const availabilityFeedback = document.getElementById('availability-feedback');
                if (availabilityFeedback) {
                    availabilityFeedback.classList.remove('hidden');
                }
                // Small delay to ensure UI is updated
                setTimeout(() => {
                    checkAvailability();
                }, 300);
            }
        }
        
        // Check if all required fields are filled for availability check
        function canCheckAvailability() {
            const tripPurpose = document.getElementById('trip-purpose')?.value.trim();
            const vehicleType = document.getElementById('vehicle-type')?.value;
            const driverOption = document.getElementById('driver-option')?.value;
            const tripDate = document.getElementById('trip-date')?.value;
            const pickupTime = document.getElementById('pickup-time')?.value;
            const duration = document.getElementById('trip-duration')?.value;
            const passengers = document.getElementById('passengers')?.value;
            
            // Check school driver requirements if selected
            if (driverOption === 'school-driver') {
                const pickupLocation = document.getElementById('pickup-location')?.value.trim();
                if (!pickupLocation || !pickupTime) return false;
            }
            
            return tripPurpose && vehicleType && driverOption && tripDate && pickupTime && duration && passengers;
        }
        
        // Update availability check button state
        function updateAvailabilityButtonState() {
            const checkBtn = document.getElementById('check-availability-btn');
            if (checkBtn) {
                checkBtn.disabled = !canCheckAvailability();
            }
        }
        
        // Availability checking functions (automatically called by system)
        function checkAvailability() {
            const tripDate = document.getElementById('trip-date')?.value;
            const vehicleType = document.getElementById('vehicle-type')?.value;
            const pickupTime = document.getElementById('pickup-time')?.value;
            const duration = document.getElementById('trip-duration')?.value;
            const availabilityFeedback = document.getElementById('availability-feedback');
            const availabilityStatus = document.getElementById('availability-status');
            const alternativeVehicles = document.getElementById('alternative-vehicles');
            const timeSuggestions = document.getElementById('time-suggestions');
            const submitBtn = document.getElementById('submit-booking-btn');
            
            // For November 6th, check immediately even without all fields
            if (tripDate === '2025-11-06') {
                // Continue with check even if not all fields are filled
            } else if (!canCheckAvailability()) {
                // For other dates, need minimum fields: date, vehicle type, and pickup time
                if (!tripDate || !vehicleType || !pickupTime) {
                    return; // Don't show error, just wait for more fields
                }
            }
            
            if (!availabilityFeedback || !availabilityStatus) return;
            
            // Show availability feedback area
            availabilityFeedback.classList.remove('hidden');
            availabilityStatus.className = 'p-4 bg-blue-50 border border-blue-200 rounded-lg';
            availabilityStatus.innerHTML = `
                <div class="flex items-center gap-2">
                    <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-blue-800 font-semibold">${window.t('checkingAvailability')}</span>
                </div>
            `;
            
            // Check availability against mock bookings
            setTimeout(() => {
                // Special case: November 6th, 2025 - all vehicles are unavailable
                // Compare dates directly (YYYY-MM-DD format)
                const isNov6 = tripDate === '2025-11-06';
                
                // Check if date is in the bus unavailability period (Dec 5-15, 2025)
                const selectedDateObj = tripDate ? new Date(tripDate) : null;
                const busUnavailableStart = new Date('2025-12-05');
                const busUnavailableEnd = new Date('2025-12-15');
                busUnavailableStart.setHours(0, 0, 0, 0);
                busUnavailableEnd.setHours(23, 59, 59, 999);
                
                const isBusType = vehicleType === 'bus';
                const isInBusUnavailablePeriod = selectedDateObj && selectedDateObj >= busUnavailableStart && selectedDateObj <= busUnavailableEnd;
                
                let isAvailable = false;
                
                if (isNov6) {
                    // November 6th, 2025 - all vehicles are unavailable
                    // This should be handled by checkDateAvailability() which clears the date
                    // But if somehow it gets here, just return early
                    return;
                } else if (isInBusUnavailablePeriod && isBusType) {
                    // December 5-15, 2025 - buses/minibuses are unavailable
                    availabilityStatus.className = 'p-4 bg-yellow-50 border border-yellow-200 rounded-lg';
                    availabilityStatus.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-yellow-800 font-semibold">${window.t('busesUnavailable')}</span>
                        </div>
                        <p class="text-sm text-yellow-700 mb-3">${window.t('busesUnavailableDesc')}</p>
                    `;
                    
                    // Show alternative vehicles (Van/Car)
                    if (alternativeVehicles) {
                        alternativeVehicles.classList.remove('hidden');
                        alternativeVehicles.className = 'p-4 bg-blue-50 border border-blue-200 rounded-lg';
                        alternativeVehicles.innerHTML = `
                            <h4 class="text-sm font-semibold text-blue-800 mb-2">${window.t('alternativeVehiclesAvailable')}:</h4>
                            <div class="space-y-2">
                                <button type="button" onclick="document.getElementById('vehicle-type').value='van'; checkAvailability();" class="w-full text-left p-3 bg-white rounded-lg hover:bg-blue-50 border border-blue-200 text-sm">
                                    <span class="font-semibold text-blue-800">${window.t('vehicleTypeVan')}</span>
                                    <span class="text-blue-600 text-xs ml-2">${window.t('statusAvailable')}</span>
                                </button>
                                <button type="button" onclick="document.getElementById('vehicle-type').value='car'; checkAvailability();" class="w-full text-left p-3 bg-white rounded-lg hover:bg-blue-50 border border-blue-200 text-sm">
                                    <span class="font-semibold text-blue-800">${window.t('vehicleTypeCar')}</span>
                                    <span class="text-blue-600 text-xs ml-2">${window.t('statusAvailable')}</span>
                                </button>
                            </div>
                        `;
                    }
                    
                    // Disable submit button
                    if (submitBtn) {
                        submitBtn.disabled = true;
                    }
                    
                    return;
                } else {
                    // Check against existing bookings for conflicts
                    const selectedDateTime = new Date(`${tripDate}T${pickupTime}`);
                    const durationHours = parseInt(duration);
                    const endDateTime = new Date(selectedDateTime.getTime() + durationHours * 60 * 60 * 1000);
                    
                    // Map vehicle type to match mock data format
                    const vehicleTypeMap = {
                        'bus': 'Minibus',
                        'van': 'Passenger Van',
                        'car': 'Sedan'
                    };
                    const mappedVehicleType = vehicleTypeMap[vehicleType] || vehicleType;
                    
                    // Check for conflicts with existing bookings
                    const hasConflict = Object.values(MOCK_BOOKINGS).some(booking => {
                        // Skip denied and completed bookings
                        if (booking.status === 'DENIED' || booking.status === 'COMPLETED') {
                            return false;
                        }
                        
                        // Check if same vehicle type
                        if (booking.vehicleType !== mappedVehicleType) {
                            return false;
                        }
                        
                        // Check if time ranges overlap
                        const bookingStart = new Date(booking.startTime);
                        const bookingEnd = new Date(bookingStart.getTime() + booking.durationHours * 60 * 60 * 1000);
                        
                        // Check if dates are the same
                        const bookingDate = bookingStart.toISOString().split('T')[0];
                        const selectedDateStr = tripDate;
                        
                        if (bookingDate !== selectedDateStr) {
                            return false;
                        }
                        
                        // Check if time ranges overlap
                        return selectedDateTime < bookingEnd && endDateTime > bookingStart;
                    });
                    
                    isAvailable = !hasConflict;
                }
                
                if (isAvailable) {
                    availabilityStatus.className = 'p-4 bg-green-50 border border-green-200 rounded-lg';
                    availabilityStatus.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-green-800 font-semibold">${window.t('vehicleAvailableForDateTime')}</span>
                        </div>
                        <p class="text-sm text-green-700 mt-2">${window.t('proceedSubmitBooking')}</p>
                    `;
                    alternativeVehicles.classList.add('hidden');
                    timeSuggestions.classList.add('hidden');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        generateBookingSummary();
                    }
                } else {
                    availabilityStatus.className = 'p-4 bg-yellow-50 border border-yellow-200 rounded-lg';
                    availabilityStatus.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-yellow-800 font-semibold">${window.t('selectedVehicleNotAvailable')}</span>
                        </div>
                    `;
                    
                    // Show alternative vehicles
                    alternativeVehicles.classList.remove('hidden');
                    alternativeVehicles.className = 'p-4 bg-blue-50 border border-blue-200 rounded-lg';
                    alternativeVehicles.innerHTML = `
                        <p class="text-blue-800 font-semibold mb-2 text-sm">Alternative vehicles available:</p>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-2 bg-white rounded">
                                <span class="text-sm">${window.t('vehicleTypeVan')}</span>
                                <span class="text-xs text-green-600 font-semibold">${window.t('statusAvailable')}</span>
                            </div>
                            <div class="flex items-center justify-between p-2 bg-white rounded">
                                <span class="text-sm">${window.t('vehicleTypeCar')}</span>
                                <span class="text-xs text-green-600 font-semibold">${window.t('statusAvailable')}</span>
                            </div>
                        </div>
                    `;
                    
                    // Show time suggestions
                    if (pickupTime) {
                        showTimeSuggestions(pickupTime);
                    }
                    
                    if (submitBtn) submitBtn.disabled = true;
                }
            }, 1000); // Simulate 1 second API call
        }
        
        function showTimeSuggestions(requestedTime) {
            const timeSuggestions = document.getElementById('time-suggestions');
            if (!timeSuggestions) return;
            
            timeSuggestions.classList.remove('hidden');
            timeSuggestions.className = 'p-4 bg-purple-50 border border-purple-200 rounded-lg';
            
            // Generate 3 alternative time suggestions (1 hour, 2 hours, 3 hours later)
            const [hours, minutes] = requestedTime.split(':');
            const suggestions = [];
            for (let i = 1; i <= 3; i++) {
                const newHour = parseInt(hours) + i;
                const timeStr = `${newHour.toString().padStart(2, '0')}:${minutes}`;
                suggestions.push(timeStr);
            }
            
            timeSuggestions.innerHTML = `
                <p class="text-purple-800 font-semibold mb-2 text-sm">Suggested alternative times:</p>
                <div class="space-y-2">
                    ${suggestions.map(time => `
                        <button type="button" onclick="document.getElementById('pickup-time').value='${time}'; checkAvailability();" class="w-full text-left p-2 bg-white rounded hover:bg-purple-50 text-sm">
                            ${formatTime(time)}
                        </button>
                    `).join('')}
                </div>
            `;
        }
        
        function formatTime(timeStr) {
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }
        
        // Driver option handler
        function handleDriverOption() {
            const driverOption = document.getElementById('driver-option')?.value;
            const schoolDriverDetails = document.getElementById('school-driver-details');
            const authStatus = document.getElementById('driver-authorization-status');
            const vehicleType = document.getElementById('vehicle-type')?.value;
            
            // Hide all driver option details first
            if (schoolDriverDetails) schoolDriverDetails.classList.add('hidden');
            if (authStatus) authStatus.classList.add('hidden');
            
            if (driverOption === 'school-driver') {
                // Show school driver requirements
                if (schoolDriverDetails) schoolDriverDetails.classList.remove('hidden');
            } else if (driverOption === 'self-drive') {
                // Show authorization status
                if (authStatus) {
                    authStatus.classList.remove('hidden');
                    checkDriverAuthorization(vehicleType);
                }
            }
            
            updateAvailabilityButtonState();
        }
        
        // Driver authorization check - Self Drive is NOT auto-approved
        // Shows appropriate status: authorized (green), not authorized (red), or pending (yellow)
        function checkDriverAuthorization(vehicleType) {
            const authStatus = document.getElementById('driver-authorization-status');
            const authAuthorized = document.getElementById('authorization-authorized');
            const authNotAuthorized = document.getElementById('authorization-not-authorized');
            const authPending = document.getElementById('authorization-pending');
            
            if (!authStatus || !vehicleType) return;
            
            // Hide all authorization status messages first
            if (authAuthorized) authAuthorized.classList.add('hidden');
            if (authNotAuthorized) authNotAuthorized.classList.add('hidden');
            if (authPending) authPending.classList.add('hidden');
            
            // Get current user (in guest mode, default to emp_high - Sarah Chen)
            // In production, this would get the logged-in user ID
            const currentUserId = 'emp_high'; // Guest mode - using Sarah Chen
            const user = getUserById(currentUserId);
            
            if (!user || user.role !== 'Employee') {
                // Show "not authorized" if user is not an employee
                if (authNotAuthorized) authNotAuthorized.classList.remove('hidden');
                return;
            }
            
            // Check authorization based on user's isAuthorizedDriver flag
            const isAuthorized = user.isAuthorizedDriver === true;
            
            // Self-drive is NOT automatically approved - show pending status by default
            // Only show authorized/not authorized if explicitly verified
            if (isAuthorized) {
                // User is authorized - show green checkmark
                if (authAuthorized) authAuthorized.classList.remove('hidden');
            } else {
                // User is not authorized - show red X
                if (authNotAuthorized) authNotAuthorized.classList.remove('hidden');
            }
        }
        
        // Generate booking summary for review
        function generateBookingSummary() {
            const summaryDiv = document.getElementById('booking-summary');
            const summaryContent = document.getElementById('summary-content');
            const reviewBtn = document.getElementById('review-booking-btn');
            
            if (!summaryDiv || !summaryContent) return;
            
            const tripPurpose = document.getElementById('trip-purpose')?.value;
            const vehicleType = document.getElementById('vehicle-type')?.value;
            const driverOption = document.getElementById('driver-option')?.value;
            const tripDate = document.getElementById('trip-date')?.value;
            const pickupTime = document.getElementById('pickup-time')?.value;
            const duration = document.getElementById('trip-duration')?.value;
            const passengers = document.getElementById('passengers')?.value;
            const notes = document.getElementById('notes')?.value;
            
            if (!tripPurpose || !vehicleType || !driverOption || !tripDate || !pickupTime || !duration || !passengers) {
                summaryDiv.classList.add('hidden');
                if (reviewBtn) reviewBtn.classList.add('hidden');
                return;
            }
            
            const vehicleTypeMap = {
                'bus': 'Bus / Minibus (50 seats)',
                'van': 'Van (15 seats)',
                'car': 'Sedan / Car (5 seats)'
            };
            
            const driverOptionMap = {
                'school-driver': 'Request a School Driver',
                'self-drive': 'Self-Drive / Own Authorized Driver'
            };
            
            const durationText = duration < 24 ? `${duration} hour${duration > 1 ? 's' : ''}` : `${Math.floor(duration / 24)} day${Math.floor(duration / 24) > 1 ? 's' : ''}`;
            
            let pickupInfo = '';
            if (driverOption === 'school-driver') {
                const pickupLocation = document.getElementById('pickup-location')?.value;
                if (pickupLocation) {
                    pickupInfo = `<p><strong>Pickup Location:</strong> ${pickupLocation}</p>`;
                }
            }
            
            // Calculate end time
            let endTimeDisplay = 'N/A';
            try {
                const startDateTime = new Date(`${tripDate}T${pickupTime}`);
                const durationHours = parseInt(duration);
                if (!isNaN(startDateTime.getTime()) && !isNaN(durationHours)) {
                    const endDateTime = new Date(startDateTime.getTime() + durationHours * 60 * 60 * 1000);
                    const endDate = endDateTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const endTime = endDateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    endTimeDisplay = `${endDate} at ${endTime}`;
                }
            } catch (error) {
                endTimeDisplay = 'N/A';
            }
            
            summaryContent.innerHTML = `
                <div class="space-y-2">
                    <p><strong>Trip Purpose:</strong> ${tripPurpose}</p>
                    <p><strong>Vehicle Type:</strong> ${vehicleTypeMap[vehicleType] || vehicleType}</p>
                    <p><strong>Driver Option:</strong> ${driverOptionMap[driverOption] || driverOption}</p>
                    ${pickupInfo}
                    <p><strong>Start Date:</strong> ${new Date(tripDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                    <p><strong>Pickup Time:</strong> ${formatTime(pickupTime)}</p>
                    <p><strong>Duration:</strong> ${durationText}</p>
                    <p><strong>End Time:</strong> ${endTimeDisplay}</p>
                    <p><strong>Number of Passengers:</strong> ${passengers}</p>
                    ${notes ? `<p><strong>Additional Notes:</strong> ${notes}</p>` : ''}
                </div>
            `;
            
            summaryDiv.classList.remove('hidden');
            if (reviewBtn) reviewBtn.classList.remove('hidden');
        }
        
        // Post-Submission Management: Modify Request (only for Pending bookings)
        function modifyBooking(bookingId) {
            // Check if booking is in Pending status
            const bookingElement = document.querySelector(`button[onclick*="${bookingId}"]`)?.closest('.bg-white');
            const isPending = bookingElement?.querySelector('span')?.textContent.includes('Pending');
            
            if (!isPending) {
                showError('Modify Request is only available for bookings with Pending status. This booking has already been approved or denied.');
                return;
            }
            
            const confirmed = confirm(`Modify Request: ${bookingId}\n\nYou are about to modify this pending booking request. Changes will require re-approval by the Admin.\n\nDo you want to continue?`);
            
            if (confirmed) {
                showSuccess(`Opening modification form for: ${bookingId}. The form will be pre-filled with current booking details.`);
                window.location.hash = 'new-booking';
            }
        }
        
        // Post-Submission Management: Cancel Request (for Pending or Approved bookings)
        async function cancelBooking(bookingId, currentStatus) {
            // Check if booking is in Pending or Approved status
            if (currentStatus !== 'Pending' && currentStatus !== 'Approved' && currentStatus !== 'PENDING' && currentStatus !== 'APPROVED') {
                showError(`Cancel Request is only available for bookings with Pending or Approved status. Current Status: ${currentStatus}. This booking cannot be cancelled.`);
                return;
            }
            
            const confirmed = confirm(`Cancel Request: ${bookingId}\n\nCurrent Status: ${currentStatus}\n\nAre you sure you want to cancel this booking request?\n\nThis action will:\n- Send an immediate notification to the Admin\n- If a driver is assigned, notify them to free up the vehicle\n- Cancel the booking permanently\n\nThis action cannot be undone.`);
            
            if (confirmed) {
                try {
                    // Update booking status to CANCELLED in Firebase
                    const updates = {
                        status: 'CANCELLED',
                        cancelledAt: new Date().toISOString(),
                        adminNotes: (currentStatus === 'APPROVED' || currentStatus === 'Approved') 
                            ? 'Booking cancelled by employee.' 
                            : 'Booking cancelled by employee before approval.'
                    };
                    
                    console.log(`üîÑ Cancelling booking ${bookingId}...`, updates);
                    
                    // Update in Firebase (or mock data if not configured)
                    await updateBookingFirestore(bookingId, updates);
                    
                    console.log(`‚úÖ Booking ${bookingId} cancelled successfully. Status updated to CANCELLED.`);
                    console.log(`üì° Real-time listeners should automatically update:\n   - Driver window: Trip will disappear from "Upcoming Trips"\n   - Admin window: Status will change to "Cancelled"`);
                    
                    showSuccess('Booking cancelled successfully! Notifications have been sent to Admin and assigned Driver (if applicable).');
                    
                    // Refresh all dashboards
                    await populateEmployeeDashboard(appState.currentUserId || 'emp_high');
                    
                    // Refresh admin dashboard if open
                    const adminDashboard = document.getElementById('view-admin-dashboard');
                    if (adminDashboard && adminDashboard.classList.contains('active')) {
                        await populateAdminDashboard();
                    }
                    
                    // Refresh driver dashboard if open and driver was assigned
                    const booking = getBookingById(bookingId);
                    if (booking && booking.assignedDriverId) {
                        const driverDashboard = document.getElementById('view-assigned-trips');
                        if (driverDashboard && driverDashboard.classList.contains('active')) {
                            await populateDriverDashboard(booking.assignedDriverId);
                        }
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error cancelling booking:', error);
                    let errorMessage = 'Failed to cancel booking. Please try again.';
                    
                    if (error.code === 'permission-denied') {
                        errorMessage = 'Permission Denied: You do not have permission to cancel this booking.\n\nCheck Network Tab for 403 Forbidden response.';
                        console.error('üîí PERMISSION DENIED: Check Firebase Security Rules for update permissions');
                    } else if (error.message) {
                        errorMessage += '\n\nError: ' + error.message;
                    }
                    
                    alert(errorMessage);
                }
            }
        }
        
        // Post-Submission Management: View Driver Status (for Approved bookings with school driver)
        function viewDriverStatus(bookingId) {
            let driverStatus = '';
            let driverName = '';
            let statusDetails = '';
            
            if (bookingId === 'museum-field-trip') {
                driverName = 'John Smith';
                driverStatus = 'En Route';
                statusDetails = `
Driver: John Smith
Status: En Route
Current Location: 2.5 km from pickup location
Estimated Arrival: 8:55 AM (5 minutes)
Vehicle: Bus VH-001
Contact: +1 (555) 123-4567

Last Updated: 8:50 AM
Next Update: Real-time GPS tracking active
                `;
            } else if (bookingId === 'science-museum') {
                driverName = 'Sarah Johnson';
                driverStatus = 'Arrived';
                statusDetails = `
Driver: Sarah Johnson
Status: Arrived
Location: Main School Gate
Arrival Time: 10:00 AM
Vehicle: Bus VH-003
Contact: +1 (555) 987-6543

Current Activity: Passengers boarding
Estimated Departure: 10:15 AM
                `;
            } else {
                driverStatus = 'Assigned';
                statusDetails = `
Driver: Not yet assigned
Status: Assigned (awaiting driver assignment)
Vehicle: To be assigned

The admin will assign a driver closer to the trip date.
                `;
            }
            
            const modalContent = `
                <h3 class="text-xl font-bold mb-4 text-gray-800">${window.t('driverStatusTitle')} ${bookingId}</h3>
                <div class="text-left space-y-3">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <pre class="text-sm text-gray-700 whitespace-pre-wrap">${statusDetails}</pre>
                    </div>
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-800 font-semibold mb-1">${window.t('realTimeStatusUpdates')}</p>
                        <p class="text-xs text-blue-700">${window.t('driverStatusUpdatesDesc')}</p>
                    </div>
                </div>
                <button onclick="document.getElementById('driver-status-modal').classList.remove('open')" class="mt-4 px-6 py-2 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400" data-translate="close">Close</button>
            `;
            
            let modal = document.getElementById('driver-status-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'driver-status-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
                document.body.appendChild(modal);
                
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.remove('open');
                    }
                });
            } else {
                modal.querySelector('.modal-content').innerHTML = modalContent;
            }
            
            modal.classList.add('open');
        }
        
        // Trip policy modal
        function showTripPolicy() {
            const policyContent = `
                <h3 class="text-xl font-bold mb-4 text-gray-800">${window.t('tripPolicyTitle')}</h3>
                <div class="text-left space-y-4 text-sm">
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">${window.t('requiredDocumentation')}</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-700">
                            <li>${window.t('completedTripRequestForm')}</li>
                            <li>${window.t('parentalConsentForms')}</li>
                            <li>${window.t('emergencyContactInfo')}</li>
                            <li>${window.t('medicalInfoParticipants')}</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">${window.t('bookingGuidelines')}</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-700">
                            <li>${window.t('bookAtLeast2Weeks')}</li>
                            <li>${window.t('maximumCapacityRespected')}</li>
                            <li>${window.t('cancellation48Hours')}</li>
                            <li>${window.t('selfDriveAuthorizationRequired')}</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">${window.t('safetyRequirements')}</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-700">
                            <li>${window.t('allPassengersWearSeatbelts')}</li>
                            <li>${window.t('firstAidKitMustBePresent')}</li>
                            <li>${window.t('emergencyContactNumbersAccessible')}</li>
                        </ul>
                    </div>
                </div>
                <button onclick="document.getElementById('trip-policy-modal').classList.remove('open')" class="mt-6 px-6 py-2 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400" data-translate="close">Close</button>
            `;
            
            // Create or update modal
            let modal = document.getElementById('trip-policy-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'trip-policy-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal-content">${policyContent}</div>`;
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.remove('open');
                    }
                });
            } else {
                modal.querySelector('.modal-content').innerHTML = policyContent;
            }
            
            modal.classList.add('open');
        }
        
        // Show scrollable booking success modal
        function showBookingSuccessModal() {
            const modalContent = `
                <div class="flex items-center justify-center mb-4">
                    <svg class="w-16 h-16 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold mb-4 text-gray-800">${window.t('bookingSubmittedSuccessfully')}</h3>
                <div class="text-left space-y-3 text-sm text-gray-700 max-h-96 overflow-y-auto pr-2" style="-webkit-overflow-scrolling: touch; max-height: 400px;">
                    <p class="font-semibold text-gray-800">${window.t('requestReceivedPending')}</p>
                    <div>
                        <p class="font-semibold text-gray-800 mb-2">${window.t('whatHappensNext')}</p>
                        <ul class="list-disc list-inside space-y-1 ml-2">
                            <li>${window.t('emailNotificationOnReview')}</li>
                            <li>${window.t('trackStatusInDashboard')}</li>
                            <li>${window.t('statusUpdatesRealTime')}</li>
                            <li>${window.t('dashboardAutoRefreshes')}</li>
                        </ul>
                    </div>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded mt-3">
                        <p class="text-blue-800 font-semibold text-sm flex items-center gap-2">
                            <span>üìä</span>
                            <span>${window.t('realTimeDashboardUpdates')}</span>
                        </p>
                        <p class="text-blue-700 text-sm mt-2">${window.t('noNeedCheckEmail')}</p>
                        <p class="text-blue-600 text-xs mt-2 italic">${window.t('bookingAppearsInDashboard')}</p>
                    </div>
                </div>
                <button onclick="closeBookingSuccessModal(); setTimeout(() => { window.location.hash = 'guest/employee'; setTimeout(async () => { console.log('üîÑ Refreshing dashboard after modal close...'); await populateEmployeeDashboard('emp_high'); }, 300); }, 100);" class="mt-6 px-6 py-3 bg-isd-gold text-isd-black rounded-lg font-semibold hover:bg-yellow-400 w-full" data-translate="goToDashboard">Go to Dashboard</button>
            `;
            
            // Create or update modal
            let modal = document.getElementById('booking-success-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'booking-success-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeBookingSuccessModal();
                    }
                });
            } else {
                modal.querySelector('.modal-content').innerHTML = modalContent;
            }
            
            // Ensure modal is visible
            modal.style.display = 'flex';
            modal.classList.add('open');
            
            // Force a reflow to ensure the modal is rendered
            void modal.offsetHeight;
            
            console.log('‚úÖ Booking success modal displayed');
        }
        
        // Close booking success modal
        function closeBookingSuccessModal() {
            const modal = document.getElementById('booking-success-modal');
            if (modal) {
                modal.classList.remove('open');
                // Also hide with display none after transition
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }

        // Initialize when DOM is ready
        function initializeApp() {
            // Set minimum date to today for booking form
            const tripDateInput = document.getElementById('trip-date');
            if (tripDateInput) {
                const today = new Date().toISOString().split('T')[0];
                tripDateInput.setAttribute('min', today);
                
                // Check date availability and auto-check availability on date change
                tripDateInput.addEventListener('change', function() {
                    // Check if November 6th was selected - keep it selected but disabled
                    if (this.value === '2025-11-06') {
                        this.classList.add('unavailable-date');
                        this.setAttribute('readonly', 'readonly');
                        this.setAttribute('disabled', 'disabled');
                        checkDateAvailability();
                        return;
                    }
                    // Remove unavailable date class if a valid date is selected
                    this.classList.remove('unavailable-date');
                    this.removeAttribute('disabled');
                    this.removeAttribute('readonly');
                    
                    // Hide the date availability message if it's showing
                    const dateAvailabilityMessage = document.getElementById('date-availability-message');
                    if (dateAvailabilityMessage) {
                        dateAvailabilityMessage.classList.add('hidden');
                    }
                    
                    checkDateAvailability();
                    // Auto-check availability immediately when date is selected
                    autoCheckAvailability();
                });
                
                // Also check on input event to catch any programmatic changes
                tripDateInput.addEventListener('input', function() {
                    if (this.value === '2025-11-06') {
                        this.classList.add('unavailable-date');
                        this.setAttribute('readonly', 'readonly');
                        this.setAttribute('disabled', 'disabled');
                        checkDateAvailability();
                    } else if (this.value && this.value !== '2025-11-06') {
                        this.classList.remove('unavailable-date');
                        this.removeAttribute('disabled');
                        this.removeAttribute('readonly');
                        
                        // Hide the date availability message if it's showing
                        const dateAvailabilityMessage = document.getElementById('date-availability-message');
                        if (dateAvailabilityMessage) {
                            dateAvailabilityMessage.classList.add('hidden');
                        }
                    }
                });
            }
            
            // Auto-check availability on pickup time change
            const pickupTimeInput = document.getElementById('pickup-time');
            if (pickupTimeInput) {
                pickupTimeInput.addEventListener('change', () => {
                    autoCheckAvailability();
                });
            }
            
            // Auto-check availability on duration change
            const durationInput = document.getElementById('trip-duration');
            if (durationInput) {
                durationInput.addEventListener('change', () => {
                    autoCheckAvailability();
                });
            }
            
            // Initialize school driver details to be visible by default
            const driverOptionInput = document.getElementById('driver-option');
            if (driverOptionInput && driverOptionInput.value === 'school-driver') {
                handleDriverOption();
            }
            
            // Add passenger capacity validation based on vehicle type
            const vehicleTypeInput = document.getElementById('vehicle-type');
            const passengersInput = document.getElementById('passengers');
            const capacityInfo = document.getElementById('passengers-capacity-info');
            
            if (vehicleTypeInput && passengersInput && capacityInfo) {
                const vehicleCapacities = {
                    'bus': 50,
                    'van': 15,
                    'car': 5
                };
                
                function updatePassengerCapacity() {
                    const vehicleType = vehicleTypeInput.value;
                    const capacity = vehicleCapacities[vehicleType];
                    
                    if (capacity) {
                        capacityInfo.textContent = `${window.t('vehicleCapacity')} ${capacity} ${window.t('passengers')}`;
                        passengersInput.setAttribute('max', capacity);
                    } else {
                        capacityInfo.textContent = '';
                        passengersInput.removeAttribute('max');
                    }
                }
                
                vehicleTypeInput.addEventListener('change', updatePassengerCapacity);
                passengersInput.addEventListener('input', function() {
                    const vehicleType = vehicleTypeInput.value;
                    const capacity = vehicleCapacities[vehicleType];
                    const passengers = parseInt(this.value);
                    
                    if (capacity && passengers > capacity) {
                        this.setCustomValidity(`${window.t('cannotExceedCapacity')} ${capacity} ${window.t('passengers')}`);
                        this.classList.add('border-red-500');
                        const errorMsg = document.getElementById('passengers-error');
                        if (errorMsg) {
                            errorMsg.textContent = `${window.t('cannotExceedCapacity')} ${capacity} ${window.t('passengers')}`;
                            errorMsg.classList.remove('hidden');
                        }
                    } else {
                        this.setCustomValidity('');
                        this.classList.remove('border-red-500');
                        const errorMsg = document.getElementById('passengers-error');
                        if (errorMsg && (!this.value || parseInt(this.value) < 1)) {
                            errorMsg.textContent = window.t('pleaseEnterValidPassengers');
                        } else if (errorMsg && this.value && parseInt(this.value) >= 1) {
                            errorMsg.classList.add('hidden');
                        }
                    }
                });
                
                // Initialize capacity info on page load
                updatePassengerCapacity();
            }
            
            // Vehicle type change handler (additional event listener for authorization check)
            if (vehicleTypeInput) {
                vehicleTypeInput.addEventListener('change', () => {
                    const driverOption = document.getElementById('driver-option')?.value;
                    if (driverOption === 'self-drive') {
                        checkDriverAuthorization(vehicleTypeInput.value);
                    }
                    // Check date availability when vehicle type changes (for bus unavailability period)
                    checkDateAvailability();
                    // Auto-check availability when vehicle type is selected
                    autoCheckAvailability();
                });
            }
            
            // Driver option change handler (additional event listener)
            if (driverOptionInput) {
                driverOptionInput.addEventListener('change', handleDriverOption);
            }
            
            // Pickup location change handler
            const pickupLocationInput = document.getElementById('pickup-location');
            if (pickupLocationInput) {
                pickupLocationInput.addEventListener('input', updateAvailabilityButtonState);
            }
            
            // Pickup time change handler (additional event listener for availability button state)
            if (pickupTimeInput) {
                pickupTimeInput.addEventListener('change', updateAvailabilityButtonState);
            }
            
            // Form field change handlers for availability button
            const tripPurposeInput = document.getElementById('trip-purpose');
            if (tripPurposeInput) {
                tripPurposeInput.addEventListener('input', updateAvailabilityButtonState);
            }
            
            // Passengers change handler (additional event listener for availability button state)
            if (passengersInput) {
                passengersInput.addEventListener('input', updateAvailabilityButtonState);
            }
            
            // Availability check button
            const checkAvailabilityBtn = document.getElementById('check-availability-btn');
            if (checkAvailabilityBtn) {
                checkAvailabilityBtn.addEventListener('click', checkAvailability);
            }
            
            // Review booking button
            const reviewBtn = document.getElementById('review-booking-btn');
            if (reviewBtn) {
                reviewBtn.addEventListener('click', () => {
                    generateBookingSummary();
                    document.getElementById('booking-summary')?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });
            }
            
            // Event Listeners for Language
            const langEn = document.getElementById('lang-en');
            const langFr = document.getElementById('lang-fr');
            if (langEn) {
                langEn.addEventListener('click', (e) => {
                    e.preventDefault();
                    app.setLanguage('en');
                });
            }
            if (langFr) {
                langFr.addEventListener('click', (e) => {
                    e.preventDefault();
                    app.setLanguage('fr');
                });
            }
            
            // Form validation for New Booking
            const newBookingForm = document.getElementById('new-booking-form');
            if (newBookingForm) {
                newBookingForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Clear previous errors
                    document.querySelectorAll('[id$="-error"]').forEach(el => {
                        el.classList.add('hidden');
                    });
                    // Clear red borders from all form inputs
                    document.querySelectorAll('#new-booking-form input, #new-booking-form select, #new-booking-form textarea').forEach(input => {
                        input.classList.remove('border-red-500');
                    });
                    
                    let isValid = true;
                    
                    // Validate Trip Purpose
                    const tripPurpose = document.getElementById('trip-purpose');
                    if (!tripPurpose.value.trim()) {
                        document.getElementById('trip-purpose-error').classList.remove('hidden');
                        tripPurpose.classList.add('border-red-500');
                        isValid = false;
                    }
                    
                    // Validate Date
                    const tripDate = document.getElementById('trip-date');
                    if (!tripDate.value) {
                        document.getElementById('trip-date-error').classList.remove('hidden');
                        document.getElementById('trip-date-error').textContent = 'Date is required';
                        tripDate.classList.add('border-red-500');
                        isValid = false;
                    } else {
                        // Check if date is in the past
                        const selectedDate = new Date(tripDate.value);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        if (selectedDate < today) {
                            document.getElementById('trip-date-error').classList.remove('hidden');
                            document.getElementById('trip-date-error').textContent = 'Cannot book for a past date';
                            tripDate.classList.add('border-red-500');
                            isValid = false;
                        }
                    }
                    
                    // Validate Pickup Time
                    const pickupTime = document.getElementById('pickup-time');
                    if (!pickupTime.value) {
                        document.getElementById('pickup-time-error').classList.remove('hidden');
                        document.getElementById('pickup-time-error').textContent = 'Pickup time is required';
                        pickupTime.classList.add('border-red-500');
                        isValid = false;
                    } else if (tripDate.value) {
                        // Check if date and time combination is in the past
                        const selectedDate = new Date(tripDate.value);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        if (selectedDate.getTime() === today.getTime()) {
                            // Same day, check time
                            const [hours, minutes] = pickupTime.value.split(':');
                            const selectedDateTime = new Date();
                            selectedDateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                            const now = new Date();
                            
                            if (selectedDateTime < now) {
                                document.getElementById('pickup-time-error').classList.remove('hidden');
                                document.getElementById('pickup-time-error').textContent = 'Cannot book for a past time';
                                pickupTime.classList.add('border-red-500');
                                isValid = false;
                            }
                        }
                    }
                    
                    // Validate Passengers
                    const passengers = document.getElementById('passengers');
                    if (!passengers.value || parseInt(passengers.value) < 1) {
                        document.getElementById('passengers-error').classList.remove('hidden');
                        passengers.classList.add('border-red-500');
                        isValid = false;
                    }
                    
                    // Validate Duration
                    const tripDuration = document.getElementById('trip-duration');
                    if (!tripDuration.value) {
                        document.getElementById('trip-duration-error').classList.remove('hidden');
                        tripDuration.classList.add('border-red-500');
                        isValid = false;
                    } else {
                        // Validate that duration is a valid number
                        const durationValue = parseInt(tripDuration.value, 10);
                        if (isNaN(durationValue) || durationValue <= 0) {
                            document.getElementById('trip-duration-error').classList.remove('hidden');
                            document.getElementById('trip-duration-error').textContent = 'Duration must be a valid number';
                        tripDuration.classList.add('border-red-500');
                        isValid = false;
                        }
                    }
                    
                    // Validate Vehicle Type
                    const vehicleType = document.getElementById('vehicle-type');
                    if (!vehicleType.value) {
                        document.getElementById('vehicle-type-error').classList.remove('hidden');
                        vehicleType.classList.add('border-red-500');
                        isValid = false;
                    }
                    
                    // Validate Driver Option
                    const driverOption = document.getElementById('driver-option');
                    if (driverOption && !driverOption.value) {
                        if (!document.getElementById('driver-option-error')) {
                            const errorMsg = document.createElement('p');
                            errorMsg.id = 'driver-option-error';
                            errorMsg.className = 'text-red-600 text-sm mt-1';
                            errorMsg.textContent = 'Please select a driver option';
                            driverOption.parentElement.appendChild(errorMsg);
                        }
                        document.getElementById('driver-option-error').classList.remove('hidden');
                        driverOption.classList.add('border-red-500');
                        isValid = false;
                    } else if (driverOption && driverOption.value === 'school-driver') {
                        // Validate pickup location and time for school driver
                        const pickupLocation = document.getElementById('pickup-location');
                        const pickupTime = document.getElementById('pickup-time');
                        
                        if (!pickupLocation || !pickupLocation.value.trim()) {
                            const errorEl = document.getElementById('pickup-location-error');
                            if (errorEl) errorEl.classList.remove('hidden');
                            if (pickupLocation) pickupLocation.classList.add('border-red-500');
                            isValid = false;
                        }
                        
                        if (!pickupTime || !pickupTime.value) {
                            const errorEl = document.getElementById('pickup-time-error');
                            if (errorEl) errorEl.classList.remove('hidden');
                            if (pickupTime) pickupTime.classList.add('border-red-500');
                            isValid = false;
                        }
                    } else if (driverOption && driverOption.value === 'self-drive') {
                        // Check authorization status if self-drive is selected
                        const authStatus = document.getElementById('driver-authorization-status');
                        const authNotAuthorized = document.getElementById('authorization-not-authorized');
                        if (authStatus && !authStatus.classList.contains('hidden') && 
                            authNotAuthorized && !authNotAuthorized.classList.contains('hidden')) {
                            showError('You are not authorized for self-drive with the selected vehicle type. Please select "Request a School Driver" or choose a different vehicle type.');
                            isValid = false;
                        }
                    }
                    
                    // Availability is automatically checked by the system
                    // No need to validate button click - check availability status directly
                    const availabilityStatus = document.getElementById('availability-status');
                    const submitBtn = document.getElementById('submit-booking-btn');
                    if (submitBtn && submitBtn.disabled) {
                        // Check if we have November 6th (which should be cleared by checkDateAvailability)
                        const tripDate = document.getElementById('trip-date')?.value;
                        if (tripDate === '2025-11-06') {
                            // This shouldn't happen as checkDateAvailability clears it, but just in case
                            showError('November 6th, 2025 is unavailable. Please select the suggested date or another available date.');
                        } else if (availabilityStatus && !availabilityStatus.classList.contains('bg-green-50')) {
                            showError('Please ensure vehicle availability is confirmed before submitting. The system will check availability automatically when all fields are filled.');
                        }
                        isValid = false;
                    }
                    
                    if (isValid) {
                        // Collect form data with input validation
                        const tripPurposeInput = document.getElementById('trip-purpose');
                        const tripPurpose = tripPurposeInput ? tripPurposeInput.value.trim() : '';
                        
                        // Validate trip purpose input
                        if (!validateInput(tripPurpose, 'text')) {
                            showError('Trip purpose is required and must be less than 1000 characters.');
                            return;
                        }
                        
                        const vehicleType = document.getElementById('vehicle-type').value;
                        const tripDate = document.getElementById('trip-date').value;
                        
                        // Validate date input
                        if (!validateInput(tripDate, 'date')) {
                            showError('Please select a valid date.');
                            return;
                        }
                        
                        const pickupTime = document.getElementById('pickup-time').value;
                        
                        // Parse duration as integer - ensure it's a number, not a string
                        const tripDurationValue = document.getElementById('trip-duration').value;
                        const tripDuration = parseInt(tripDurationValue, 10); // Explicit radix 10 for base-10 parsing
                        
                        // Validate duration is a valid number
                        if (isNaN(tripDuration) || tripDuration <= 0) {
                            showError('Invalid duration. Please select a valid duration.');
                            return;
                        }
                        
                        const driverOption = document.getElementById('driver-option').value;
                        const passengersInput = document.getElementById('passengers');
                        const passengers = passengersInput ? parseInt(passengersInput.value, 10) : 0;
                        
                        // Validate passengers is a valid number
                        if (isNaN(passengers) || passengers <= 0) {
                            showError('Invalid number of passengers. Please enter a valid number.');
                            return;
                        }
                        
                        const notesInput = document.getElementById('notes');
                        const notes = notesInput ? notesInput.value.trim() : '';
                        
                        // Validate notes input length if provided
                        if (notes && !validateInput(notes, 'text')) {
                            showError('Notes must be less than 1000 characters.');
                            return;
                        }
                        
                        const pickupLocationInput = document.getElementById('pickup-location');
                        const pickupLocation = pickupLocationInput ? pickupLocationInput.value.trim() : '';
                        
                        // Validate pickup location if school driver
                        if (driverOption === 'school-driver' && pickupLocation) {
                            if (!validateInput(pickupLocation, 'text')) {
                                showError('Pickup location must be less than 1000 characters.');
                                return;
                            }
                        }
                        
                        // Map vehicle type to booking format
                        const vehicleTypeMap = {
                            'bus': 'Minibus',
                            'van': 'Passenger Van',
                            'car': 'Sedan'
                        };
                        const mappedVehicleType = vehicleTypeMap[vehicleType] || vehicleType;
                        
                        // Map driver option to booking format
                        const driverOptionMap = {
                            'school-driver': 'Request Driver',
                            'self-drive': 'Self-Drive'
                        };
                        const mappedDriverOption = driverOptionMap[driverOption] || driverOption;
                        
                        // Create start time string (ISO format)
                        const startDateTime = new Date(`${tripDate}T${pickupTime}:00Z`);
                        const startTimeISO = startDateTime.toISOString();
                        
                        // Sanitize all text inputs before creating booking
                        const safeTripPurpose = sanitizeHTML(tripPurpose);
                        const safePickupLocation = pickupLocation ? sanitizeHTML(pickupLocation) : '';
                        const safeNotes = notes ? sanitizeHTML(notes) : '';
                        
                        // Create booking object
                        // Ensure all numeric fields are explicitly numbers (not strings) for Firebase
                        const newBooking = {
                            vehicleType: mappedVehicleType,
                            startTime: startTimeISO,
                            durationHours: Number(tripDuration), // Explicitly convert to number type
                            driverOption: mappedDriverOption,
                            adminNotes: '',
                            passengers: Number(passengers), // Explicitly convert to number type
                            tripPurpose: safeTripPurpose, // Sanitized
                            requesterId: 'emp_high' // Set requesterId for guest mode (default to emp_high)
                        };
                        
                        // Add pickup location if school driver (already sanitized)
                        if (driverOption === 'school-driver' && safePickupLocation) {
                            newBooking.pickupLocation = safePickupLocation;
                        }
                        
                        // Add notes if provided (already sanitized)
                        if (safeNotes) {
                            newBooking.notes = safeNotes;
                        }
                        
                        // Create booking in Firestore (or mock data if Firebase not configured)
                        try {
                            const bookingId = await createBooking(newBooking);
                            console.log('New booking created:', bookingId, newBooking);
                            
                            // Show success message
                            showSuccess('Booking request submitted successfully!');
                            
                            // Reset form first
                            newBookingForm.reset();
                            
                            // Show scrollable success modal
                            showBookingSuccessModal();
                            
                            // Don't auto-navigate - let user click "Go to Dashboard" button
                            // The modal will handle navigation when user clicks the button
                            
                            // Force refresh dashboard immediately and multiple times to ensure it updates
                            console.log('üîÑ Scheduling dashboard refreshes...');
                            
                            // Immediate refresh (before navigation)
                            setTimeout(async () => {
                                console.log('üîÑ First refresh - Refreshing dashboard after booking submission');
                                console.log('   Current MOCK_BOOKINGS count:', Object.keys(MOCK_BOOKINGS).length);
                                await populateEmployeeDashboard('emp_high');
                            }, 50);
                            
                            // Additional refreshes after navigation
                            setTimeout(async () => {
                                console.log('üîÑ Second refresh - Refreshing dashboard after booking submission');
                                await populateEmployeeDashboard('emp_high');
                            }, 300);
                            
                            setTimeout(async () => {
                                console.log('üîÑ Third refresh - Refreshing dashboard after booking submission');
                                await populateEmployeeDashboard('emp_high');
                            }, 800);
                            
                            setTimeout(async () => {
                                console.log('üîÑ Fourth refresh - Final refresh after booking submission');
                                await populateEmployeeDashboard('emp_high');
                            }, 1500);
                        } catch (error) {
                            console.error('Error creating booking:', error);
                            
                            // Enhanced error handling for Firebase permission issues
                            let errorMessage = 'Failed to create booking. Please try again.';
                            
                            if (error.code === 'permission-denied') {
                                errorMessage = 'Permission Denied: You do not have permission to create bookings. Please check your authentication and role.\n\n' +
                                    'Console Error Code: ' + error.code + '\n' +
                                    'Check Network Tab for 403 Forbidden response.';
                                console.error('Firebase Permission Denied - Check security rules:', error);
                            } else if (error.code === 'unauthenticated') {
                                errorMessage = 'Authentication Error: You are not logged in. Please refresh the page and try again.';
                                console.error('Firebase Unauthenticated Error:', error);
                            } else if (error.message) {
                                errorMessage += '\n\nError: ' + error.message;
                            }
                            
                            showError(errorMessage);
                        }
                    }
                });
            }
            
            // Handle admin/employee/driver header link clicks
            const btnAdmin = document.getElementById('btn-admin');
            const btnEmployee = document.getElementById('btn-employee');
            const btnDriver = document.getElementById('btn-driver');
            
            if (btnAdmin) {
                btnAdmin.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Show admin login form - for now, navigate to guest admin for demo
                    window.location.hash = 'guest/admin';
                });
            }
            
            if (btnEmployee) {
                btnEmployee.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Show employee login form - for now, navigate to guest employee for demo
                    window.location.hash = 'guest/employee';
                });
            }
            
            if (btnDriver) {
                btnDriver.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Show driver login form - for now, navigate to guest driver for demo
                    window.location.hash = 'guest/driver';
                });
            }
            
            // Hash change listener for routing (moved to initApp to avoid duplicates)
            
            // Prevent default navigation on header links
            const headerTitleLink = document.getElementById('header-title-link');
            const homeLink = document.getElementById('home-link');
            
            if (headerTitleLink) {
                headerTitleLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.hash = 'home';
                });
            }
            
            if (homeLink) {
                homeLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.hash = 'home';
                });
            }
            
            // Admin Dashboard Button Listeners
            const adminFleetBtn = document.getElementById('admin-fleet-btn');
            const adminApprovalsBtn = document.getElementById('admin-approvals-btn');
            const adminUsersBtn = document.getElementById('admin-users-btn');
            
            if (adminFleetBtn) {
                adminFleetBtn.addEventListener('click', () => {
                    window.location.hash = 'fleet-management';
                });
            }
            
            if (adminApprovalsBtn) {
                adminApprovalsBtn.addEventListener('click', () => {
                    window.location.hash = 'booking-approvals';
                });
            }
            
            if (adminUsersBtn) {
                adminUsersBtn.addEventListener('click', () => {
                    window.location.hash = 'user-management';
                });
            }
            
            // Employee Dashboard Button Listeners
            const employeeBookingBtn = document.getElementById('employee-booking-btn');
            const employeeMyBookingsBtn = document.getElementById('employee-mybookings-btn');
            
            if (employeeBookingBtn) {
                employeeBookingBtn.addEventListener('click', () => {
                    window.location.hash = 'new-booking';
                });
            }
            
            if (employeeMyBookingsBtn) {
                employeeMyBookingsBtn.addEventListener('click', () => {
                    window.location.hash = 'my-bookings';
                });
            }
            
            // Driver Dashboard Button Listeners
            const driverTripsBtn = document.getElementById('driver-trips-btn');
            const driverStatusBtn = document.getElementById('driver-status-btn');
            
            if (driverTripsBtn) {
                driverTripsBtn.addEventListener('click', () => {
                    window.location.hash = 'assigned-trips';
                });
            }
            
            if (driverStatusBtn) {
                driverStatusBtn.addEventListener('click', () => {
                    window.location.hash = 'update-status';
                });
            }
            
            // Add Vehicle Button Handler
            const addVehicleBtn = document.getElementById('add-vehicle-btn');
            if (addVehicleBtn) {
                addVehicleBtn.addEventListener('click', () => {
                    openAddVehicleModal();
                });
            }
            
            // Add Vehicle Image Preview Handler
            const addVehicleImageInput = document.getElementById('add-vehicle-image');
            const addVehicleImagePreview = document.getElementById('add-vehicle-image-preview');
            if (addVehicleImageInput && addVehicleImagePreview) {
                addVehicleImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            addVehicleImagePreview.src = e.target.result;
                            addVehicleImagePreview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        addVehicleImagePreview.src = '';
                        addVehicleImagePreview.classList.add('hidden');
                    }
                });
            }
            
            // Add Vehicle Form Handler
            const addVehicleForm = document.getElementById('add-vehicle-form');
            if (addVehicleForm) {
                addVehicleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        const vehicleId = document.getElementById('add-vehicle-id').value.trim();
                        const vehicleType = document.getElementById('add-vehicle-type').value;
                        const capacity = document.getElementById('add-vehicle-capacity').value.trim();
                        const status = document.getElementById('add-vehicle-status').value;
                        const location = document.getElementById('add-vehicle-location').value.trim();
                        const imageFile = document.getElementById('add-vehicle-image').files[0];
                        
                        // Validate required fields
                        if (!vehicleId || !vehicleType || !capacity || !status) {
                            showError('Please fill in all required fields (Vehicle ID, Type, Capacity, and Status).');
                            return;
                        }
                        
                        // In production, this would save to Firebase
                        // For now, we'll add it to MOCK_VEHICLES (if it exists as a mutable object)
                        // Since MOCK_VEHICLES is a const, we'll just show success
                        // In a real app, this would be:
                        // await addVehicleToFirestore({ vehicleId, vehicleType, capacity, status, location, imageFile });
                        
                        console.log('Adding vehicle:', { vehicleId, vehicleType, capacity, status, location, hasImage: !!imageFile });
                        
                        showSuccess(`Vehicle ${vehicleId} has been added successfully! Type: ${vehicleType}, Capacity: ${capacity}, Status: ${status}`);
                        
                        closeAddVehicleModal();
                        
                        // In production, would refresh the vehicle list
                        // For now, just show success message
                    } catch (error) {
                        console.error('Error adding vehicle:', error);
                        showError('Failed to add vehicle. Please try again.');
                    }
                });
            }
            
            // Close Add Vehicle Modal when clicking outside
            const addVehicleModal = document.getElementById('add-vehicle-modal');
            if (addVehicleModal) {
                addVehicleModal.addEventListener('click', function(e) {
                    if (e.target === addVehicleModal) {
                        closeAddVehicleModal();
                    }
                });
            }
            
            // Update Status Form Handler
        // Driver Trip Status Management Functions
        let tripStatusSequence = {
            'museum-trip': {
                currentStep: 0,
                steps: ['start-trip', 'arrived-pickup', 'start-driving', 'arrived-destination', 'trip-complete']
            }
        };
        
        // Update Trip Status (Sequential Workflow)
        async function updateTripStatus(statusType) {
            try {
                const tripCard = document.getElementById('active-trip-card');
                const tripId = tripCard?.dataset.tripId;
                if (!tripId) {
                    showError('Trip ID not found.');
                    return;
                }
                const statusBadge = document.getElementById('trip-status-badge');
            
            // Update status sequence
            if (!tripStatusSequence[tripId]) {
                tripStatusSequence[tripId] = { currentStep: 0, steps: [] };
            }
            
            const statusMap = {
                'start-trip': { step: 0, status: 'En Route', badge: 'bg-green-100 text-green-800', nextButton: 'arrived-pickup-btn', message: 'Trip started! Departing from garage/depot.' },
                'arrived-pickup': { step: 1, status: 'Arrived at Pickup', badge: 'bg-blue-100 text-blue-800', nextButton: null, message: 'Arrived at pickup location. Please complete safety check before starting drive.' },
                'start-driving': { step: 2, status: 'Driving', badge: 'bg-purple-100 text-purple-800', nextButton: 'arrived-destination-btn', message: 'Driving started! Trip is underway.' },
                'arrived-destination': { step: 3, status: 'Arrived at Destination', badge: 'bg-indigo-100 text-indigo-800', nextButton: 'trip-complete-btn', message: 'Arrived at destination.' },
                'trip-complete': { step: 4, status: 'Completed', badge: 'bg-gray-100 text-gray-800', nextButton: null, message: 'Trip completed!' }
            };
            
            const statusInfo = statusMap[statusType];
            if (!statusInfo) return;
            
            // Update status badge
            if (statusBadge) {
                statusBadge.textContent = statusInfo.status;
                statusBadge.className = `px-3 py-1 ${statusInfo.badge} rounded-full text-sm font-semibold`;
            }
            
            // Disable current button and enable next button
            const buttonIdMap = {
                'start-trip': 'start-trip-btn',
                'arrived-pickup': 'arrived-pickup-btn',
                'start-driving': 'start-driving-btn',
                'arrived-destination': 'arrived-destination-btn',
                'trip-complete': 'trip-complete-btn'
            };
            
            const currentBtnId = buttonIdMap[statusType];
            const currentBtn = currentBtnId ? document.getElementById(currentBtnId) : null;
            
            if (currentBtn) {
                currentBtn.disabled = true;
                currentBtn.classList.add('opacity-50');
            }
            
            if (statusInfo.nextButton) {
                const nextBtn = document.getElementById(statusInfo.nextButton);
                if (nextBtn) {
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50');
                }
            }
            
            // Special handling: When "Arrived at Pickup" is clicked, enable safety check
            if (statusType === 'arrived-pickup') {
                // Safety check section becomes visible/enabled
                const safetyCheckSection = document.getElementById('safety-check-section');
                if (safetyCheckSection) {
                    safetyCheckSection.classList.remove('opacity-50');
                }
                
                // Enable all individual safety check checkboxes
                const checkBoxes = [
                    'check-tires',
                    'check-lights',
                    'check-brakes',
                    'check-fuel',
                    'check-mirrors',
                    'check-first-aid'
                ];
                
                checkBoxes.forEach(checkId => {
                    const checkBox = document.getElementById(checkId);
                    if (checkBox) {
                        checkBox.disabled = false;
                        // Add event listener to check all checks when any individual check is toggled
                        checkBox.addEventListener('change', checkAllSafetyChecks);
                    }
                });
                
                // Initialize check for all safety checks
                checkAllSafetyChecks();
            }
            
            // Special handling: When "Start Driving" is clicked, enable "Arrived at Destination"
            if (statusType === 'start-driving') {
                const arrivedDestinationBtn = document.getElementById('arrived-destination-btn');
                if (arrivedDestinationBtn) {
                    arrivedDestinationBtn.disabled = false;
                    arrivedDestinationBtn.classList.remove('opacity-50');
                }
            }
            
            // Special handling: When "Arrived at Destination" is clicked, enable "Trip Complete"
            if (statusType === 'arrived-destination') {
                const tripCompleteBtn = document.getElementById('trip-complete-btn');
                if (tripCompleteBtn) {
                    tripCompleteBtn.disabled = false;
                    tripCompleteBtn.classList.remove('opacity-50');
                }
            }
            
            // Update trip card status
            if (tripCard) {
                tripCard.dataset.status = statusInfo.status.toLowerCase().replace(/\s+/g, '-');
            }
            
            // Update booking in database with new status
            const tripStatusMap = {
                'start-trip': { status: 'ACTIVE', driverStatus: 'En Route' },
                'arrived-pickup': { status: 'ACTIVE', driverStatus: 'Arrived at Pickup' },
                'start-driving': { status: 'ACTIVE', driverStatus: 'Driving' },
                'arrived-destination': { status: 'ACTIVE', driverStatus: 'Arrived at Destination' },
                'trip-complete': { status: 'COMPLETED', driverStatus: 'Completed' }
            };
            
            const statusUpdate = tripStatusMap[statusType];
            if (statusUpdate) {
                const updates = {
                    driverStatus: statusUpdate.driverStatus,
                    status: statusUpdate.status,
                    lastDriverUpdate: new Date().toISOString()
                };
                
                // Only update to COMPLETED if trip is actually complete
                if (statusType === 'trip-complete') {
                    updates.status = 'COMPLETED';
                    updates.completedAt = new Date().toISOString();
                }
                
                try {
                    await updateBookingFirestore(tripId, updates);
                    
                    // Refresh driver dashboard
                    const driverId = appState.currentUserId || 'driver_kore';
                    await populateDriverDashboard(driverId);
                    
                    // Refresh employee dashboard to show updated status
                    const booking = getBookingById(tripId);
                    if (booking && booking.requesterId) {
                        const employeeDashboard = document.getElementById('view-employee-dashboard');
                        if (employeeDashboard && employeeDashboard.classList.contains('active')) {
                            await populateEmployeeDashboard(booking.requesterId);
                        }
                    }
                    
                    showSuccess(`Status updated: ${statusInfo.status}`);
                } catch (error) {
                    console.error('Error updating trip status:', error);
                    showError('Failed to update trip status. Please try again.');
                }
            } else {
                showSuccess(`Status updated: ${statusInfo.status}`);
            }
            } catch (error) {
                console.error('Error in updateTripStatus:', error);
                showError('Failed to update trip status. Please try again.');
            }
        }
        
        // Check if all individual safety checks are completed
        function checkAllSafetyChecks() {
            const checks = [
                document.getElementById('check-tires'),
                document.getElementById('check-lights'),
                document.getElementById('check-brakes'),
                document.getElementById('check-fuel'),
                document.getElementById('check-mirrors'),
                document.getElementById('check-first-aid')
            ];
            
            const allChecked = checks.every(check => check && check.checked);
            const safetyCheckConfirmed = document.getElementById('safety-check-confirmed');
            
            // Enable "All Safety Checks Confirmed" only if all individual checks are completed
            if (safetyCheckConfirmed) {
                if (allChecked) {
                    safetyCheckConfirmed.disabled = false;
                } else {
                    safetyCheckConfirmed.disabled = true;
                    safetyCheckConfirmed.checked = false;
                }
            }
            
            // Update Start Driving button state
            toggleStartDrivingButton();
        }
        
        // Toggle Start Driving Button (Safety Gate)
        function toggleStartDrivingButton() {
            const safetyCheck = document.getElementById('safety-check-confirmed');
            const startDrivingBtn = document.getElementById('start-driving-btn');
            
            if (safetyCheck && startDrivingBtn) {
                // Start Driving button is enabled only when "All Safety Checks Confirmed" is checked
                if (safetyCheck.checked) {
                    startDrivingBtn.disabled = false;
                    startDrivingBtn.classList.remove('opacity-50');
                } else {
                    startDrivingBtn.disabled = true;
                    startDrivingBtn.classList.add('opacity-50');
                }
            }
        }
        
        // Single-Tap Delay Notification
        async function sendDelayNotification() {
            try {
                const delayBtn = document.getElementById('delay-notification-btn');
                if (!delayBtn) return;
                
                const tripCard = document.getElementById('active-trip-card');
                const tripId = tripCard?.dataset.tripId;
                if (!tripId) {
                    showError('Trip ID not found.');
                    return;
                }
                
                // Disable button temporarily to prevent double-taps
                delayBtn.disabled = true;
                delayBtn.textContent = '‚è±Ô∏è Sending...';
                
                // Update booking with delay notification
                const updates = {
                    delayNotification: true,
                    delayNotificationTime: new Date().toISOString(),
                    delayMessage: 'Driver is experiencing a short delay (approximately 10 minutes).'
                };
                
                await updateBookingFirestore(tripId, updates);
                
                // Update button state
                delayBtn.textContent = '‚è±Ô∏è Notification Sent!';
                delayBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                delayBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                
                showSuccess('Delay notification sent! Employee and Admin have been notified.');
                
                // Refresh dashboards
                const driverId = appState.currentUserId || 'driver_kore';
                await populateDriverDashboard(driverId);
                
                // Refresh employee dashboard if open
                const booking = getBookingById(tripId);
                if (booking && booking.requesterId) {
                    const employeeDashboard = document.getElementById('view-employee-dashboard');
                    if (employeeDashboard && employeeDashboard.classList.contains('active')) {
                        await populateEmployeeDashboard(booking.requesterId);
                    }
                }
                
                // Re-enable button after 3 seconds
                setTimeout(() => {
                    delayBtn.disabled = false;
                    delayBtn.textContent = '‚è±Ô∏è Running 10 Mins Late';
                    delayBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    delayBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                }, 3000);
            } catch (error) {
                console.error('Error sending delay notification:', error);
                showError('Failed to send delay notification. Please try again.');
                // Re-enable button on error
                const delayBtn = document.getElementById('delay-notification-btn');
                if (delayBtn) {
                    delayBtn.disabled = false;
                    delayBtn.textContent = '‚è±Ô∏è Running 10 Mins Late';
                }
            }
        }
        
        // Open Trip Finalization Screen
        function openTripFinalization() {
            window.location.hash = 'trip-finalization';
        }
        
        // Validate Trip Finalization Form
        function validateTripFinalization() {
            const odometer = document.getElementById('final-odometer')?.value;
            const fuelLevel = document.querySelector('input[name="final-fuel-level"]:checked')?.value;
            const vehicleIssues = document.getElementById('vehicle-issues')?.value.trim();
            const submitBtn = document.getElementById('submit-trip-log-btn');
            
            if (!submitBtn) return;
            
            // Enable submit button only if all fields are filled
            if (odometer && fuelLevel && vehicleIssues) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50');
            }
        }
        
        // Initialize Start Trip Button (enable by default)
        function initializeDriverTrip() {
            const startTripBtn = document.getElementById('start-trip-btn');
            if (startTripBtn) {
                startTripBtn.disabled = false;
                startTripBtn.classList.remove('opacity-50');
            }
        }

            const updateStatusForm = document.getElementById('update-status-form');
            if (updateStatusForm) {
                updateStatusForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Clear previous errors
                    document.querySelectorAll('[id$="-error"]').forEach(el => {
                        el.classList.add('hidden');
                    });
                    // Clear red borders from all form inputs
                    document.querySelectorAll('#update-status-form input, #update-status-form select').forEach(input => {
                        input.classList.remove('border-red-500');
                    });
                    
                    let isValid = true;
                    
                    // Validate Trip Select
                    const tripSelect = document.getElementById('trip-select');
                    if (!tripSelect.value) {
                        document.getElementById('trip-select-error').classList.remove('hidden');
                        tripSelect.classList.add('border-red-500');
                        isValid = false;
                    }
                    
                    // Validate Status Select
                    const statusSelect = document.getElementById('status-select');
                    if (!statusSelect.value) {
                        document.getElementById('status-select-error').classList.remove('hidden');
                        statusSelect.classList.add('border-red-500');
                        isValid = false;
                    }
                    
                    if (isValid) {
                        try {
                            const tripId = tripSelect.value;
                            const status = statusSelect.value;
                            const location = document.getElementById('current-location').value;
                            const notes = document.getElementById('status-notes')?.value.trim() || '';
                            
                            // Update booking with status
                            const updates = {
                                driverStatus: status,
                                driverLocation: location || undefined,
                                driverNotes: notes || undefined,
                                lastDriverUpdate: new Date().toISOString()
                            };
                            
                            await updateBookingFirestore(tripId, updates);
                            
                            showSuccess(`Trip status updated successfully! Status: ${status}`);
                            
                            // Refresh dashboards
                            const driverId = appState.currentUserId || 'driver_kore';
                            await populateDriverDashboard(driverId);
                            
                            // Refresh employee dashboard if open
                            const booking = getBookingById(tripId);
                            if (booking && booking.requesterId) {
                                const employeeDashboard = document.getElementById('view-employee-dashboard');
                                if (employeeDashboard && employeeDashboard.classList.contains('active')) {
                                    await populateEmployeeDashboard(booking.requesterId);
                                }
                            }
                            
                            // Navigate back to driver dashboard
                            window.location.hash = 'guest/driver';
                        } catch (error) {
                            console.error('Error updating trip status:', error);
                            showError('Failed to update trip status. Please try again.');
                        }
                    }
                });
            }
            
            // Trip Finalization Form Handler
            const tripFinalizationForm = document.getElementById('trip-finalization-form');
            if (tripFinalizationForm) {
                // Validate form on input changes
                const odometerInput = document.getElementById('final-odometer');
                const vehicleIssuesInput = document.getElementById('vehicle-issues');
                const fuelLevelRadios = document.querySelectorAll('input[name="final-fuel-level"]');
                
                if (odometerInput) {
                    odometerInput.addEventListener('input', validateTripFinalization);
                }
                if (vehicleIssuesInput) {
                    vehicleIssuesInput.addEventListener('input', validateTripFinalization);
                }
                fuelLevelRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        // Update visual state of fuel level options
                        document.querySelectorAll('.fuel-level-option').forEach(option => {
                            option.classList.remove('border-isd-gold', 'bg-isd-gold', 'bg-opacity-10');
                        });
                        if (this.checked) {
                            this.closest('.fuel-level-option').classList.add('border-isd-gold', 'bg-isd-gold', 'bg-opacity-10');
                        }
                        validateTripFinalization();
                    });
                });
                
                // Form submission
                tripFinalizationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const odometer = document.getElementById('final-odometer')?.value;
                    const fuelLevel = document.querySelector('input[name="final-fuel-level"]:checked')?.value;
                    const vehicleIssues = document.getElementById('vehicle-issues')?.value.trim();
                    
                    // Clear previous errors
                    document.querySelectorAll('[id$="-error"]').forEach(el => {
                        el.classList.add('hidden');
                    });
                    document.querySelectorAll('#trip-finalization-form input, #trip-finalization-form textarea').forEach(input => {
                        input.classList.remove('border-red-500');
                    });
                    
                    let isValid = true;
                    
                    // Validate Odometer
                    if (!odometer || parseFloat(odometer) < 0) {
                        document.getElementById('odometer-error').classList.remove('hidden');
                        document.getElementById('final-odometer').classList.add('border-red-500');
                        isValid = false;
                    }
                    
                    // Validate Fuel Level
                    if (!fuelLevel) {
                        document.getElementById('fuel-level-error').classList.remove('hidden');
                        isValid = false;
                    }
                    
                    // Validate Vehicle Issues
                    if (!vehicleIssues) {
                        document.getElementById('vehicle-issues-error').classList.remove('hidden');
                        document.getElementById('vehicle-issues').classList.add('border-red-500');
                        isValid = false;
                    }
                    
                    if (isValid) {
                        try {
                            const tripCard = document.getElementById('active-trip-card');
                            const tripId = tripCard?.dataset.tripId;
                            
                            if (!tripId) {
                                showError('Trip ID not found.');
                                return;
                            }
                            
                            // Sanitize inputs
                            const safeOdometer = parseFloat(odometer) || 0;
                            const safeFuelLevel = sanitizeHTML(fuelLevel);
                            const safeIssues = sanitizeHTML(vehicleIssues);
                            
                            // Validate odometer
                            if (safeOdometer <= 0) {
                                showError('Please enter a valid odometer reading.');
                                return;
                            }
                            
                            // Update booking with final log
                            const updates = {
                                status: 'COMPLETED',
                                completedAt: new Date().toISOString(),
                                finalLog: {
                                    odometerEnd: safeOdometer,
                                    fuelLevelEnd: safeFuelLevel,
                                    issuesComments: safeIssues,
                                    submittedAt: new Date().toISOString()
                                }
                            };
                            
                            await updateBookingFirestore(tripId, updates);
                            
                            showSuccess('Trip finalized successfully! Trip log has been submitted and trip is now complete.');
                            
                            // Refresh dashboards
                            const driverId = appState.currentUserId || 'driver_kore';
                            await populateDriverDashboard(driverId);
                            
                            // Refresh employee dashboard if open
                            const booking = getBookingById(tripId);
                            if (booking && booking.requesterId) {
                                const employeeDashboard = document.getElementById('view-employee-dashboard');
                                if (employeeDashboard && employeeDashboard.classList.contains('active')) {
                                    await populateEmployeeDashboard(booking.requesterId);
                                }
                            }
                            
                            // Refresh admin dashboard if open
                            const adminDashboard = document.getElementById('view-admin-dashboard');
                            if (adminDashboard && adminDashboard.classList.contains('active')) {
                                await populateAdminDashboard();
                            }
                            
                            // Navigate back to driver dashboard
                            window.location.hash = 'guest/driver';
                        } catch (error) {
                            console.error('Error finalizing trip:', error);
                            showError('Failed to finalize trip. Please try again.');
                        }
                    }
                });
            }
            
            // Initialize driver trip on page load
            initializeDriverTrip();
        }
        
        // Call initializeApp when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Function to populate Employee Dashboard with bookings from Firestore or mock data
        async function populateEmployeeDashboard(userId) {
            try {
                // Use 'emp_high' as default userId in guest mode if not provided
                const actualUserId = userId || 'emp_high';
                
                console.log('üìä populateEmployeeDashboard called with userId:', actualUserId);
                
                // Try to get bookings from Firestore, fallback to mock data
                let bookings;
                try {
                    bookings = await getBookingsByRequesterFirestore(actualUserId);
                } catch (error) {
                    console.warn('Firestore not available, using mock data:', error);
                    // Ensure MOCK_BOOKINGS is defined
                    if (typeof MOCK_BOOKINGS === 'undefined') {
                        console.error('‚ùå MOCK_BOOKINGS is not defined');
                        showError('Unable to load bookings. Please refresh the page.');
                        return;
                    }
                    bookings = getBookingsByRequester(actualUserId);
                }
            
            console.log('üìä MOCK_BOOKINGS total count:', Object.keys(MOCK_BOOKINGS).length);
            console.log('üìä MOCK_BOOKINGS keys:', Object.keys(MOCK_BOOKINGS));
            console.log('üìä Found bookings for user:', bookings.length);
            
            if (bookings.length > 0) {
                console.log('üìä Bookings details:', bookings.map(b => ({ 
                    id: b.id, 
                    status: b.status, 
                    purpose: b.tripPurpose, 
                    requesterId: b.requesterId,
                    submittedTime: b.submittedTime 
                })));
            } else {
                console.warn('‚ö†Ô∏è No bookings found for userId:', actualUserId);
                console.log('üìä All MOCK_BOOKINGS:', Object.entries(MOCK_BOOKINGS).map(([id, b]) => ({ 
                    id, 
                    requesterId: b.requesterId, 
                    status: b.status 
                })));
            }
            
            const bookingsList = document.getElementById('employee-bookings-list');
            console.log('Bookings list element:', bookingsList);
            
            // Always update stats, even if bookings list doesn't exist yet
            const pendingCount = bookings.filter(b => b.status === 'PENDING').length;
            const approvedCount = bookings.filter(b => b.status === 'APPROVED').length;
            const activeCount = bookings.filter(b => b.status === 'ACTIVE').length;
            const deniedCount = bookings.filter(b => b.status === 'DENIED').length;
            const completedCount = bookings.filter(b => b.status === 'COMPLETED').length;
            
            console.log('Stats:', { pendingCount, approvedCount, activeCount, deniedCount, completedCount });
            
            const statsPending = document.getElementById('stats-pending');
            const statsApproved = document.getElementById('stats-approved');
            const statsActive = document.getElementById('stats-active');
            const statsDenied = document.getElementById('stats-denied');
            const statsCompleted = document.getElementById('stats-completed');
            
            if (statsPending) statsPending.textContent = pendingCount;
            if (statsApproved) statsApproved.textContent = approvedCount;
            if (statsActive) statsActive.textContent = activeCount;
            if (statsDenied) statsDenied.textContent = deniedCount;
            if (statsCompleted) statsCompleted.textContent = completedCount;
            
            // If bookings list doesn't exist, return early
            if (!bookingsList) {
                console.log('Employee bookings list not found, but stats updated');
                return;
            }
            
            // Clear existing bookings
            if (bookingsList) {
                bookingsList.innerHTML = '';
            }
            
            // Sort bookings: Active > Approved > Pending > Denied > Completed
            const statusOrder = { 'ACTIVE': 0, 'APPROVED': 1, 'PENDING': 2, 'DENIED': 3, 'COMPLETED': 4 };
            bookings.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));
            
            console.log('Rendering bookings, total:', bookings.length);
            
            // Render each booking
            bookings.forEach((booking, index) => {
                console.log(`Rendering booking ${index + 1}/${bookings.length}:`, booking.id, booking.status, booking.tripPurpose);
                const dt = formatDateTime(booking.startTime);
                const requester = getUserById(booking.requesterId);
                const driver = booking.assignedDriverId ? getUserById(booking.assignedDriverId) : null;
                
                let statusBadge = '';
                let borderColor = '';
                let statusClass = '';
                
                switch(booking.status) {
                    case 'PENDING':
                        statusBadge = `<span class="px-3 py-1 bg-yellow-500 text-white rounded-full text-xs font-semibold shadow-sm animate-pulse">‚è≥ ${window.t('pending')}</span>`;
                        borderColor = 'border-yellow-500';
                        statusClass = 'Pending';
                        break;
                    case 'APPROVED':
                        statusBadge = `<span class="px-3 py-1 bg-green-500 text-white rounded-full text-xs font-semibold shadow-sm">‚úì ${window.t('approved')}</span>`;
                        borderColor = 'border-green-500';
                        statusClass = 'Approved';
                        break;
                    case 'ACTIVE':
                        statusBadge = `<span class="px-3 py-1 bg-blue-500 text-white rounded-full text-xs font-semibold shadow-sm">‚ñ∂ ${window.t('activeTrip')}</span>`;
                        borderColor = 'border-blue-500';
                        statusClass = 'Active';
                        break;
                    case 'DENIED':
                        statusBadge = `<span class="px-3 py-1 bg-red-500 text-white rounded-full text-xs font-semibold shadow-sm">‚úó ${window.t('denied')}</span>`;
                        borderColor = 'border-red-500';
                        statusClass = 'Denied';
                        break;
                    case 'COMPLETED':
                        statusBadge = `<span class="px-3 py-1 bg-gray-500 text-white rounded-full text-xs font-semibold shadow-sm">‚úì ${window.t('completed')}</span>`;
                        borderColor = 'border-gray-500';
                        statusClass = 'Completed';
                        break;
                }
                
                // Sanitize user-generated content to prevent XSS
                const safePurpose = sanitizeHTML(booking.tripPurpose || 'Trip');
                const safeDate = sanitizeHTML(dt.dateShort);
                const safeTime = sanitizeHTML(dt.time);
                const safeVehicle = sanitizeHTML(booking.vehicleType);
                const safePassengers = String(booking.passengers || 0);
                
                let bookingHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 ${borderColor}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-bold text-gray-800">${safePurpose}</h3>
                                    ${statusBadge}
                                </div>
                                <p class="text-gray-600 text-sm mb-1">Date: <span class="font-semibold">${safeDate}</span> | Time: <span class="font-semibold">${safeTime}</span></p>
                                <p class="text-gray-600 text-sm mb-1">Vehicle: <span class="font-semibold">${safeVehicle}</span> | Passengers: <span class="font-semibold">${safePassengers}</span></p>
                `;
                
                if (driver) {
                    const safeDriverName = sanitizeHTML(driver.name);
                    bookingHTML += `<p class="text-gray-600 text-sm mb-2">${window.t('driverLabel')}: ${window.t('schoolDriver')} - ${safeDriverName}</p>`;
                    
                    if (booking.status === 'ACTIVE' && booking.driverStatus) {
                        const safeDriverStatus = sanitizeHTML(booking.driverStatus);
                        bookingHTML += `
                            <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-blue-800 text-xs font-semibold">${window.t('driverStatusLabel')}:</p>
                                    <span class="px-2 py-1 bg-blue-500 text-white rounded-full text-xs font-semibold">${safeDriverStatus}</span>
                                </div>
                                <p class="text-blue-700 text-xs">${window.t('driverLabel')} ${safeDriverName} ${window.t('isCurrently')} ${safeDriverStatus.toLowerCase()}.</p>
                                <button onclick="viewDriverStatus('${sanitizeHTML(booking.id)}')" class="mt-2 text-blue-700 hover:text-blue-900 text-xs font-semibold underline">${window.t('viewFullDriverStatus')}</button>
                            </div>
                        `;
                    }
                }
                
                if (booking.status === 'DENIED' && booking.adminNotes) {
                    const safeAdminNotes = sanitizeHTML(booking.adminNotes);
                    bookingHTML += `
                        <div class="mt-3 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                            <div class="flex items-start gap-2 mb-2">
                                <svg class="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <div class="flex-1">
                                    <p class="text-red-800 text-sm font-bold mb-1">${window.t('adminNoteRequiredJustification')}:</p>
                                    <p class="text-red-700 text-sm leading-relaxed">${safeAdminNotes}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (booking.status === 'PENDING') {
                    // Calculate time since submission
                    let timeSinceSubmission = '';
                    if (booking.submittedTime) {
                        const submittedDate = new Date(booking.submittedTime);
                        const now = new Date();
                        const hoursDiff = (now - submittedDate) / (1000 * 60 * 60);
                        const daysDiff = Math.floor(hoursDiff / 24);
                        
                        if (daysDiff > 0) {
                            timeSinceSubmission = `${window.t('waiting')} ${daysDiff} ${daysDiff > 1 ? window.t('days') : window.t('day')}`;
                        } else if (hoursDiff >= 1) {
                            const hours = Math.floor(hoursDiff);
                            timeSinceSubmission = `${window.t('waiting')} ${hours} ${hours > 1 ? window.t('hours') : window.t('hour')}`;
                        } else {
                            const minutes = Math.floor(hoursDiff * 60);
                            timeSinceSubmission = `${window.t('waiting')} ${minutes} ${minutes > 1 ? window.t('minutes') : window.t('minute')}`;
                        }
                    } else {
                        // Fallback: calculate from booking start time (simulated)
                        const bookingStart = new Date(booking.startTime);
                        const now = new Date();
                        const hoursDiff = (now - bookingStart) / (1000 * 60 * 60);
                        const daysDiff = Math.floor(hoursDiff / 24);
                        
                        if (daysDiff > 0) {
                            timeSinceSubmission = `${window.t('waiting')} ${daysDiff} ${daysDiff > 1 ? window.t('days') : window.t('day')}`;
                        } else if (hoursDiff >= 1) {
                            const hours = Math.floor(hoursDiff);
                            timeSinceSubmission = `${window.t('waiting')} ${hours} ${hours > 1 ? window.t('hours') : window.t('hour')}`;
                        } else {
                            timeSinceSubmission = window.t('waitingLessThan1Hour');
                        }
                    }
                    
                    bookingHTML += `
                        <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-center gap-2 mb-1">
                                <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                </svg>
                                <p class="text-yellow-800 text-xs font-semibold">${window.t('waitingForAdminAction')}</p>
                            </div>
                            <p class="text-yellow-700 text-sm font-medium">${timeSinceSubmission}</p>
                        </div>
                    `;
                }
                
                // Show final log information for completed trips
                if (booking.status === 'COMPLETED' && booking.finalLog) {
                    const safeOdometer = String(booking.finalLog.odometerEnd || 'N/A');
                    const safeFuelLevel = sanitizeHTML(booking.finalLog.fuelLevelEnd || 'N/A');
                    const safeIssues = sanitizeHTML(booking.finalLog.issuesComments || 'None reported');
                    
                    bookingHTML += `
                        <div class="mt-3 p-4 bg-gray-50 border-2 border-gray-300 rounded-lg">
                            <div class="flex items-start gap-2 mb-2">
                                <svg class="w-5 h-5 text-gray-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <div class="flex-1">
                                    <p class="text-gray-800 text-sm font-bold mb-2">${window.t('tripFinalizationLog')}:</p>
                                    <div class="space-y-1 text-sm text-gray-700">
                                        <p><span class="font-semibold">${window.t('finalOdometer')}:</span> ${safeOdometer} ${window.t('miles')}</p>
                                        <p><span class="font-semibold">${window.t('finalFuelLevel')}:</span> ${safeFuelLevel}</p>
                                        <p><span class="font-semibold">${window.t('vehicleIssuesComments')}:</span> ${safeIssues}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Sanitize booking ID for onclick handlers
                const safeBookingId = sanitizeHTML(booking.id);
                const safeStatusClass = sanitizeHTML(statusClass);
                
                bookingHTML += `
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-3">
                            <button onclick="viewBookingDetails('${safeBookingId}')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 text-sm">${window.t('viewDetails')}</button>
                `;
                
                if (booking.status === 'PENDING') {
                    bookingHTML += `<button onclick="modifyBooking('${safeBookingId}')" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 text-sm">${window.t('modifyRequest')}</button>`;
                }
                
                // Cancel button: Only render if currentRole is 'employee' AND status is NOT 'COMPLETED'
                const shouldShowCancelButton = getCurrentRole() === 'employee' && booking.status !== 'COMPLETED';
                if (shouldShowCancelButton && (booking.status === 'PENDING' || booking.status === 'APPROVED')) {
                    bookingHTML += `<button onclick="cancelBooking('${safeBookingId}', '${safeStatusClass}')" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 text-sm">${window.t('cancelRequest')}</button>`;
                }
                
                bookingHTML += `
                        </div>
                    </div>
                `;
                
                if (bookingsList) {
                    bookingsList.innerHTML += bookingHTML;
                }
                console.log(`Booking ${booking.id} rendered successfully`);
            });
            
            console.log('Finished rendering all bookings. Total rendered:', bookingsList ? bookingsList.children.length : 0);
            } catch (error) {
                console.error('‚ùå Error in populateEmployeeDashboard:', error);
                showError('Failed to load bookings. Please refresh the page.');
            }
        }
        
        // Function to populate Admin Dashboard with pending bookings from Firestore or mock data
        async function populateAdminDashboard() {
            try {
                // Try to get bookings from Firestore, fallback to mock data
                let pendingBookings;
                try {
                    pendingBookings = await getBookingsByStatusFirestore('PENDING');
                } catch (error) {
                    console.warn('Firestore not available, using mock data:', error);
                    pendingBookings = getBookingsByStatus('PENDING');
                }
                
                const queue = document.getElementById('pending-queue');
                if (!queue) {
                    console.warn('Admin dashboard: pending-queue element not found');
                    return;
                }
                
                // Update count
                const queueCount = document.getElementById('queue-count');
                if (queueCount) {
                    queueCount.textContent = pendingBookings.length;
                }
            
            // Clear existing queue
            if (queue) {
                queue.innerHTML = '';
            }
            
            // Sort by urgency (most urgent first)
            pendingBookings.sort((a, b) => {
                const aUrgent = isUrgentBooking(a.startTime) ? 0 : 1;
                const bUrgent = isUrgentBooking(b.startTime) ? 0 : 1;
                if (aUrgent !== bUrgent) return aUrgent - bUrgent;
                return new Date(a.startTime) - new Date(b.startTime);
            });
            
            pendingBookings.forEach(booking => {
                const dt = formatDateTime(booking.startTime);
                const requester = getUserById(booking.requesterId);
                const isUrgent = isUrgentBooking(booking.startTime);
                
                let urgencyBadge = '';
                let borderColor = 'border-yellow-500';
                let violations = 'none';
                
                if (isUrgent) {
                    urgencyBadge = '<span class="px-3 py-1 bg-red-500 text-white rounded-full text-xs font-semibold shadow-sm animate-pulse">URGENT</span>';
                    borderColor = 'border-red-500';
                }
                
                // Sanitize user-generated content
                const safePurpose = sanitizeHTML(booking.tripPurpose || 'Trip');
                const safeRequesterName = requester ? sanitizeHTML(requester.name) : 'Unknown';
                const safeDate = sanitizeHTML(dt.dateShort);
                const safeTime = sanitizeHTML(dt.time);
                const safeVehicle = sanitizeHTML(booking.vehicleType);
                const safePassengers = String(booking.passengers || 0);
                const safeBookingId = sanitizeHTML(booking.id);
                
                const bookingHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 ${borderColor}" data-urgency="${isUrgent ? 'urgent' : 'normal'}" data-violations="${violations}" data-date="${sanitizeHTML(booking.startTime)}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-bold text-gray-800">${safePurpose}</h3>
                                    ${urgencyBadge}
                                    <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">${window.t('pending')}</span>
                                </div>
                                <p class="text-gray-600 text-sm mb-1">${window.t('requestedBy')} <span class="font-semibold">${safeRequesterName}</span></p>
                                <p class="text-gray-600 text-sm mb-1">${window.t('dateLabel')} <span class="font-semibold">${safeDate}</span> | ${window.t('timeLabel')} <span class="font-semibold">${safeTime}</span></p>
                                <p class="text-gray-600 text-sm mb-1">${window.t('vehicleLabel')} <span class="font-semibold">${safeVehicle}</span> | ${window.t('passengersLabel')} <span class="font-semibold">${safePassengers}</span></p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="quickApprove('${safeBookingId}')" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 text-sm">‚úì ${window.t('approve')}</button>
                            <button onclick="quickDenyAvailability('${safeBookingId}')" class="px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 text-sm">${window.t('quickDeny')}</button>
                            <button onclick="openRequestDetailView('${safeBookingId}')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 text-sm">${window.t('viewDetails')}</button>
                        </div>
                    </div>
                `;
                
                if (queue) {
                    queue.innerHTML += bookingHTML;
                }
            });
            } catch (error) {
                console.error('‚ùå Error in populateAdminDashboard:', error);
                showError('Failed to load pending bookings. Please refresh the page.');
            }
        }
        
        // Function to populate Driver Dashboard with assigned trips
        async function populateDriverDashboard(driverId) {
            try {
                // Fetch bookings from Firebase or use mock data
                let allBookings = [];
                
                if (isFirebaseConfigured() && window.firebaseAuth && window.firebaseAuth.currentUser) {
                    try {
                        // Get bookings assigned to this driver from Firebase
                        const bookingsRef = window.firebaseFunctions.collection(window.firebaseDb, 'all_requests');
                        const q = window.firebaseFunctions.query(
                            bookingsRef,
                            window.firebaseFunctions.where('assignedDriverId', '==', driverId),
                            window.firebaseFunctions.where('status', 'in', ['APPROVED', 'ACTIVE']),
                            window.firebaseFunctions.orderBy('startTime', 'asc')
                        );
                    
                    const querySnapshot = await window.firebaseFunctions.getDocs(q);
                    querySnapshot.forEach((doc) => {
                        allBookings.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log(`üöó Driver Dashboard: Found ${allBookings.length} active/approved trips for driver ${driverId}`);
                    console.log(`   Note: CANCELLED trips are automatically excluded by query filter`);
                } catch (error) {
                    console.error('Error fetching driver trips from Firebase:', error);
                    // Fallback to mock data
                    allBookings = Object.entries(MOCK_BOOKINGS)
                        .filter(([id, booking]) => booking.assignedDriverId === driverId && (booking.status === 'APPROVED' || booking.status === 'ACTIVE'))
                        .map(([id, booking]) => ({ id, ...booking }));
                }
            } else {
                // Use mock data
                allBookings = Object.entries(MOCK_BOOKINGS)
                    .filter(([id, booking]) => booking.assignedDriverId === driverId && (booking.status === 'APPROVED' || booking.status === 'ACTIVE'))
                    .map(([id, booking]) => ({ id, ...booking }));
            }
            
            // Filter out CANCELLED trips (should already be filtered by query, but double-check)
            const assignedTrips = allBookings.filter(booking => 
                booking.status !== 'CANCELLED' && 
                (booking.status === 'APPROVED' || booking.status === 'ACTIVE')
            );
            
            console.log(`üöó Driver Dashboard: ${assignedTrips.length} active trips after filtering CANCELLED`);
            
            const activeTripCard = document.getElementById('active-trip-card');
            if (!activeTripCard) {
                console.warn('Driver dashboard: active-trip-card element not found');
                return;
            }
            
            if (assignedTrips.length === 0) {
                // No active trips - clear the card or show empty state
                console.log('üöó Driver Dashboard: No active trips found. Trip card should be empty or show "No active trips"');
                const tripTitle = activeTripCard.querySelector('h3');
                if (tripTitle) tripTitle.textContent = 'No Active Trips';
                return;
            }
            
            // Use the first active trip, or first approved trip
            const trip = assignedTrips.find(t => t.status === 'ACTIVE') || assignedTrips[0];
            const dt = formatDateTime(trip.startTime);
            const requester = getUserById(trip.requesterId);
            
            // Update trip card
            activeTripCard.dataset.tripId = trip.id;
            activeTripCard.dataset.status = trip.status.toLowerCase();
            
            const tripTitle = activeTripCard.querySelector('h3');
            const tripStatusBadge = document.getElementById('trip-status-badge');
            const tripDetails = activeTripCard.querySelector('.space-y-2');
            
            if (tripTitle) tripTitle.textContent = trip.tripPurpose || 'Trip';
            if (tripStatusBadge) {
                tripStatusBadge.textContent = trip.status === 'ACTIVE' ? 'Active Trip' : 'Scheduled';
                tripStatusBadge.className = trip.status === 'ACTIVE' ? 'px-3 py-1 bg-blue-500 text-white rounded-full text-sm font-semibold' : 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold';
            }
            
            if (tripDetails) {
                // Sanitize user-generated content
                const safeDate = sanitizeHTML(dt.dateShort);
                const safeTime = sanitizeHTML(dt.time);
                const safeVehicle = sanitizeHTML(trip.vehicleType);
                const safePassengers = String(trip.passengers || 0);
                const safePurpose = sanitizeHTML(trip.tripPurpose || 'Trip');
                
                tripDetails.innerHTML = `
                    <p><span class="font-semibold">Date:</span> ${safeDate}</p>
                    <p><span class="font-semibold">Pickup Time:</span> ${safeTime}</p>
                    <p><span class="font-semibold">Vehicle:</span> ${safeVehicle}</p>
                    <p><span class="font-semibold">Passengers:</span> ${safePassengers}</p>
                    <p><span class="font-semibold">Trip Purpose:</span> ${safePurpose}</p>
                `;
            }
            } catch (error) {
                console.error('‚ùå Error in populateDriverDashboard:', error);
                showError('Failed to load driver trips. Please refresh the page.');
            }
        }

        // Initialize app routing and navigation
        function initAppRouting() {
            try {
                app.setLanguage('en');
                app.handleRoute();
                
                // Set up hashchange listener for navigation
                window.addEventListener('hashchange', () => {
                    app.handleRoute();
                    // Re-populate dashboards when navigating
                    setTimeout(async () => {
                        // Check current route to set role
                        const hash = window.location.hash.replace('#', '');
                        if (hash.startsWith('guest/')) {
                            const role = hash.split('/')[1];
                            setCurrentRole(role);
                            
                            // Start real-time listeners when role changes
                            if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                                startDataListeners();
                            }
                        } else if (hash === 'my-bookings') {
                            setCurrentRole('employee');
                            
                            // Start real-time listeners for employee
                            if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                                startDataListeners();
                            }
                        }
                        
                        await populateEmployeeDashboard('emp_high');
                        await populateAdminDashboard();
                        populateDriverDashboard('driver_kore');
                    }, 100);
                });
                
                // Populate dashboards with mock data after DOM is ready
                // Check current route and populate accordingly
                setTimeout(() => {
                    const hash = window.location.hash.slice(1) || 'home';
                    if (hash === 'guest/employee' || hash === 'my-bookings') {
                        setCurrentRole('employee'); // Set role for employee dashboard
                        populateEmployeeDashboard('emp_high'); // Guest mode - using Sarah Chen
                    }
                    if (hash === 'guest/admin' || hash === 'booking-approvals') {
                        populateAdminDashboard();
                    }
                    if (hash === 'guest/driver' || hash === 'assigned-trips') {
                        populateDriverDashboard('driver_kore'); // Guest mode - using Jake Olsen
                    }
                }, 200);
            } catch (error) {
                console.error('Error initializing app routing:', error);
                // Fallback: ensure home view is shown
                const viewHome = document.getElementById('view-home');
                if (viewHome) viewHome.classList.add('active');
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            try {
                cleanupAllEventListeners();
                // Stop Firebase listeners if they exist
                if (window.dataListeners && Array.isArray(window.dataListeners)) {
                    window.dataListeners.forEach(listener => {
                        if (listener && listener.unsubscribe) {
                            listener.unsubscribe();
                        }
                    });
                }
            } catch (error) {
                console.error('Error during cleanup:', error);
            }
        });
        
        // Call routing initialization after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAppRouting);
        } else {
            // DOM is already ready
            initAppRouting();
        }
    </script>
</body>
</html>
